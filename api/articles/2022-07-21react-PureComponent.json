{"title":"React@16.5.0 PureComponent","uid":"d6e3ef07929a629e78ad737d602fe838","slug":"2022-07-21react-PureComponent","date":"2022-07-21T08:28:39.000Z","updated":"2022-09-15T13:16:16.659Z","comments":true,"path":"api/articles/2022-07-21react-PureComponent.json","keywords":null,"cover":[],"content":"<h2 id=\"ä¸²ä¸²\"><a href=\"#ä¸²ä¸²\" class=\"headerlink\" title=\"ä¸²ä¸²\"></a>ä¸²ä¸²</h2><img src=\"http://t-blog-images.aijs.top/img/pureComponent1.webp\" />\n\n<p>PureComponent ç»§æ‰¿ Component,æ·»åŠ  isPureReactComponent æ ‡è®°</p>\n<pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">&#x2F;&#x2F; ComponentDummy æ˜¯å…¸å‹çš„ JavaScript åŸå‹æ¨¡æ‹Ÿç»§æ‰¿çš„åšæ³•ï¼Œ\nfunction ComponentDummy() &#123;&#125;\nComponentDummy.prototype &#x3D; Component.prototype;\n\n&#x2F;**\n * Convenience component with default shallow equality check for sCU.\n * å…·æœ‰sCUé»˜è®¤æµ…ç›¸ç­‰æ£€æŸ¥çš„ä¾¿åˆ©ç»„ä»¶ã€‚\n *&#x2F;\nfunction PureComponent(props, context, updater) &#123;\n  this.props &#x3D; props;\n  this.context &#x3D; context;\n  &#x2F;&#x2F; If a component has string refs, we will assign a different object later.\n  &#x2F;&#x2F; å¦‚æœç»„ä»¶å…·æœ‰å­—ç¬¦ä¸²å¼•ç”¨ï¼Œæˆ‘ä»¬å°†ç¨åæŒ‡å®šå…¶ä»–å¯¹è±¡ã€‚\n  this.refs &#x3D; emptyObject;\n  this.updater &#x3D; updater || ReactNoopUpdateQueue;\n&#125;\n\nconst pureComponentPrototype &#x3D; (PureComponent.prototype &#x3D; new ComponentDummy());\npureComponentPrototype.constructor &#x3D; PureComponent;\n&#x2F;&#x2F; Avoid an extra prototype jump for these methods.  é¿å…è¿™äº›æ–¹æ³•çš„é¢å¤–åŸå‹è·³è½¬ã€‚\n&#x2F;&#x2F; ä¸ºäº†é¿å…åŸå‹é“¾æ‹‰é•¿å¯¼è‡´æ–¹æ³•æŸ¥æ‰¾çš„æ€§èƒ½å¼€é”€ï¼Œè¿˜ç”¨ Object.assign æŠŠæ–¹æ³•ä» ReactComponent æ‹·è´è¿‡æ¥äº†\nObject.assign(pureComponentPrototype, Component.prototype);\npureComponentPrototype.isPureReactComponent &#x3D; true; &#x2F;&#x2F; checkShouldComponentUpdateä¸­æœ‰æµ…æ¯”è¾ƒ&#96;shallowEqual&#96;</code></pre>\n\n<pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">&#x2F;&#x2F; packages&#x2F;react&#x2F;src&#x2F;ReactBaseClasses.js\n&#x2F;&#x2F; PureComponent-&gt;ç»§æ‰¿Component, æ·»åŠ  isPureReactComponent &#x3D; true\n\n&#x2F;&#x2F; packages&#x2F;react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js\n&#x2F;&#x2F; checkShouldComponentUpdate-&gt;\n&#x2F;&#x2F; shallowEqual</code></pre>\n\n<h2 id=\"checkShouldComponentUpdate\"><a href=\"#checkShouldComponentUpdate\" class=\"headerlink\" title=\"checkShouldComponentUpdate\"></a>checkShouldComponentUpdate</h2><pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">function checkShouldComponentUpdate(\n  workInProgress,\n  ctor,\n  oldProps,\n  newProps,\n  oldState,\n  newState,\n  nextLegacyContext\n) &#123;\n  const instance &#x3D; workInProgress.stateNode;\n  &#x2F;&#x2F; å®ä¾‹ä¸Šæœ‰shouldComponentUpdateï¼Œèµ°å®ä¾‹çš„åˆ¤æ–­\n  if (typeof instance.shouldComponentUpdate &#x3D;&#x3D;&#x3D; &quot;function&quot;) &#123;\n    startPhaseTimer(workInProgress, &quot;shouldComponentUpdate&quot;);\n    const shouldUpdate &#x3D; instance.shouldComponentUpdate(\n      newProps,\n      newState,\n      nextLegacyContext\n    );\n    stopPhaseTimer();\n\n    if (__DEV__) &#123;\n      warningWithoutStack(\n        shouldUpdate !&#x3D;&#x3D; undefined,\n        &quot;%s.shouldComponentUpdate(): Returned undefined instead of a &quot; +\n          &quot;boolean value. Make sure to return true or false.&quot;,\n        getComponentName(ctor) || &quot;Component&quot;\n      );\n    &#125;\n\n    return shouldUpdate; &#x2F;&#x2F; è¿”å›äº†\n  &#125;\n  &#x2F;&#x2F; å®ä¾‹æ²¡æœ‰çœ‹çœ‹ç»„ä»¶æ˜¯ä¸æ˜¯PureComponent,å¦‚æœæ˜¯è¿›è¡Œæµ…æ¯”è¾ƒ\n  &#x2F;&#x2F; æµ…æ¯”è¾ƒ\n  if (ctor.prototype &amp;&amp; ctor.prototype.isPureReactComponent) &#123;\n    return (\n      !shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)\n    );\n  &#125;\n\n  return true;\n&#125;</code></pre>\n\n<h2 id=\"shallowEqual\"><a href=\"#shallowEqual\" class=\"headerlink\" title=\"shallowEqual\"></a>shallowEqual</h2><pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">function shallowEqual(objA: mixed, objB: mixed): boolean &#123;\n  if (is(objA, objB)) &#123;\n    return true;\n  &#125;\n\n  if (\n    typeof objA !&#x3D;&#x3D; &quot;object&quot; ||\n    objA &#x3D;&#x3D;&#x3D; null ||\n    typeof objB !&#x3D;&#x3D; &quot;object&quot; ||\n    objB &#x3D;&#x3D;&#x3D; null\n  ) &#123;\n    return false;\n  &#125;\n\n  const keysA &#x3D; Object.keys(objA);\n  const keysB &#x3D; Object.keys(objB);\n\n  if (keysA.length !&#x3D;&#x3D; keysB.length) &#123;\n    return false;\n  &#125;\n\n  &#x2F;&#x2F; Test for A&#39;s keys different from B.\n  &#x2F;&#x2F; åªæ˜¯å¯¹é”®å¯¹åº”çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä»MDN Object.is Apiäº†è§£åˆ° éƒ½æ˜¯ç›¸åŒå¯¹è±¡ï¼ˆæ„å‘³ç€éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„å€¼å¼•ç”¨ï¼‰\n  &#x2F;&#x2F; å¦‚æœè¿™é‡Œè¿›è¡Œé€’å½’å¤„ç†ï¼Œå°±å˜æˆäº†deepCompare\n\n  for (let i &#x3D; 0; i &lt; keysA.length; i++) &#123;\n    if (\n      !hasOwnProperty.call(objB, keysA[i]) ||\n      !is(objA[keysA[i]], objB[keysA[i]])\n    ) &#123;\n      return false;\n    &#125;\n  &#125;\n\n  return true;\n&#125;</code></pre>\n\n<h2 id=\"is\"><a href=\"#is\" class=\"headerlink\" title=\"is\"></a>is</h2><pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">&#x2F;**\n * inlined Object.is polyfill to avoid requiring consumers ship their own\n * https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;JavaScript&#x2F;Reference&#x2F;Global_Objects&#x2F;Object&#x2F;is\n *&#x2F;\nfunction is(x, y) &#123;\n  &#x2F;&#x2F; SameValue algorithm\n  if (x &#x3D;&#x3D;&#x3D; y) &#123;\n    &#x2F;&#x2F; Steps 1-5, 7-10\n    &#x2F;&#x2F; Steps 6.b-6.e: +0 !&#x3D; -0\n    &#x2F;&#x2F; Added the nonzero y check to make Flow happy, but it is redundant\n    return x !&#x3D;&#x3D; 0 || y !&#x3D;&#x3D; 0 || 1 &#x2F; x &#x3D;&#x3D;&#x3D; 1 &#x2F; y;\n  &#125; else &#123;\n    &#x2F;&#x2F; Step 6.a: NaN &#x3D;&#x3D; NaN\n    return x !&#x3D;&#x3D; x &amp;&amp; y !&#x3D;&#x3D; y;\n  &#125;\n&#125;</code></pre>\n\n<h2 id=\"end-and-start\"><a href=\"#end-and-start\" class=\"headerlink\" title=\"end and start\"></a>end and start</h2><p>å…¶å®ä¸Šåˆ°è¿™ä¸ªåœ°æ–¹ï¼ŒPureComponent å°±èŠå®Œäº†</p>\n<h2 id=\"ä¸-beginWork-ä¸²ä¸²\"><a href=\"#ä¸-beginWork-ä¸²ä¸²\" class=\"headerlink\" title=\"ä¸ beginWork ä¸²ä¸²\"></a>ä¸ beginWork ä¸²ä¸²</h2><img src=\"http://t-blog-images.aijs.top/img/pureComponent.webp\" />\n\n<pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">&#x2F;&#x2F; beginWork-&gt;\n&#x2F;&#x2F; updateClassComponent(åˆ°è¿™é‡Œå°±ä¸@link: http:&#x2F;&#x2F;v.aijs.top&#x2F;posts&#x2F;2022-07-21react-createElement ä¸²èµ·æ¥äº†)-&gt;\n&#x2F;&#x2F; resumeMountClassInstance-&gt; | updateClassInstance-&gt;\n&#x2F;&#x2F; checkShouldComponentUpdate-&gt;\n&#x2F;&#x2F; shallowEqual</code></pre>\n\n<h2 id=\"resumeMountClassInstance\"><a href=\"#resumeMountClassInstance\" class=\"headerlink\" title=\"resumeMountClassInstance\"></a>resumeMountClassInstance</h2><p>å¦‚æœå·²ç»åˆ›å»ºå®ä¾‹ï¼Œåˆ™é‡ç”¨å®ä¾‹</p>\n<pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">function resumeMountClassInstance(\n  workInProgress: Fiber,\n  ctor: any,\n  newProps: any,\n  renderExpirationTime: ExpirationTime\n): boolean &#123;\n  &#x2F;&#x2F; æ˜¯å¦åº”è¯¥æ›´æ–°ï¼Œä¸¤ç§æƒ…å†µï¼šforceUpdate æˆ–è€… checkShouldComponentUpdate è¿”å›true\n  const shouldUpdate &#x3D;\n    checkHasForceUpdateAfterProcessing() ||\n    checkShouldComponentUpdate(\n      workInProgress,\n      ctor,\n      oldProps,\n      newProps,\n      oldState,\n      newState,\n      nextLegacyContext\n    );\n\n  if (shouldUpdate) &#123;\n    &#x2F;&#x2F; In order to support react-lifecycles-compat polyfilled components,\n    &#x2F;&#x2F; Unsafe lifecycles should not be invoked for components using the new APIs.\n    if (\n      !hasNewLifecycles &amp;&amp;\n      (typeof instance.UNSAFE_componentWillMount &#x3D;&#x3D;&#x3D; &quot;function&quot; ||\n        typeof instance.componentWillMount &#x3D;&#x3D;&#x3D; &quot;function&quot;)\n    ) &#123;\n      startPhaseTimer(workInProgress, &quot;componentWillMount&quot;);\n      if (typeof instance.componentWillMount &#x3D;&#x3D;&#x3D; &quot;function&quot;) &#123;\n        instance.componentWillMount();\n      &#125;\n      if (typeof instance.UNSAFE_componentWillMount &#x3D;&#x3D;&#x3D; &quot;function&quot;) &#123;\n        instance.UNSAFE_componentWillMount();\n      &#125;\n      stopPhaseTimer();\n    &#125;\n    &#x2F;&#x2F; è¿™é‡Œè¿›è¡Œæ ‡è®°äº†\n    if (typeof instance.componentDidMount &#x3D;&#x3D;&#x3D; &quot;function&quot;) &#123;\n      workInProgress.effectTag |&#x3D; Update;\n    &#125;\n  &#125; else &#123;\n  &#125;\n\n  &#x2F;&#x2F; Update the existing instance&#39;s state, props, and context pointers even\n  &#x2F;&#x2F; if shouldComponentUpdate returns false.\n  instance.props &#x3D; newProps;\n  instance.state &#x3D; newState;\n  instance.context &#x3D; nextLegacyContext;\n\n  return shouldUpdate;\n&#125;</code></pre>\n\n<h2 id=\"startPhaseTimer\"><a href=\"#startPhaseTimer\" class=\"headerlink\" title=\"startPhaseTimer\"></a>startPhaseTimer</h2><p><code>packages/react-reconciler/src/ReactDebugFiberPerf.js</code>æ–‡ä»¶ä¸­ï¼Œæ€§èƒ½æµ‹é‡ç›¸å…³ï¼Œä¸ç”¨å…³å¿ƒ</p>\n<h2 id=\"updateClassComponent\"><a href=\"#updateClassComponent\" class=\"headerlink\" title=\"updateClassComponent\"></a>updateClassComponent</h2><pre class=\"line-numbers language-js\" data-language=\"js\"><code class=\"language-js\">function updateClassComponent(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  Component: any,\n  nextProps,\n  renderExpirationTime: ExpirationTime\n) &#123;\n  let shouldUpdate;\n  if (current &#x3D;&#x3D;&#x3D; null) &#123;\n    &#x2F;&#x2F;  å¦‚æœè¿˜æ²¡åˆ›å»ºå®ä¾‹ï¼Œåˆå§‹åŒ–\n    if (workInProgress.stateNode &#x3D;&#x3D;&#x3D; null) &#123;\n    &#125; else &#123;\n      &#x2F;&#x2F;  å¦‚æœå·²ç»åˆ›å»ºå®ä¾‹ï¼Œåˆ™é‡ç”¨å®ä¾‹\n      &#x2F;&#x2F; In a resume, we&#39;ll already have an instance we can reuse.\n      shouldUpdate &#x3D; resumeMountClassInstance(\n        workInProgress,\n        Component,\n        nextProps,\n        renderExpirationTime\n      );\n    &#125;\n  &#125; else &#123;\n    &#x2F;&#x2F; æ›´æ–°ç±»å®ä¾‹\n    shouldUpdate &#x3D; updateClassInstance(\n      current,\n      workInProgress,\n      Component,\n      nextProps,\n      renderExpirationTime,\n    );\n  &#125;\n  return finishClassComponent(\n    &#x2F;&#x2F; è°ƒç”¨ç»„ä»¶å®ä¾‹çš„renderå‡½æ•°è·å–éœ€æ¸²æŸ“çš„å­å…ƒç´ ï¼Œå¹¶æŠŠå­å…ƒç´ è¿›è¡Œå¤„ç†ä¸ºFiberç±»å‹ï¼Œå¤„ç†stateå’Œpropsï¼š\n    current,\n    workInProgress,\n    Component,\n    shouldUpdate,\n    hasContext,\n    renderExpirationTime\n  );\n&#125;</code></pre>\n","text":"ä¸²ä¸² PureComponent ç»§æ‰¿ Component,æ·»åŠ  isPureReactComponent æ ‡è®° &#x2F;&#x2F; ComponentDummy æ˜¯å…¸å‹çš„ JavaScript åŸå‹æ¨¡æ‹Ÿç»§æ‰¿çš„åšæ³•ï¼Œ function ComponentDummy() &#...","link":"","photos":[],"count_time":{"symbolsCount":"7.7k","symbolsTime":"7 mins."},"categories":[{"name":"React@16.5.0","slug":"React-16-5-0","count":5,"path":"api/categories/React-16-5-0.json"}],"tags":[{"name":"react@16.5.0","slug":"react-16-5-0","count":5,"path":"api/tags/react-16-5-0.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%B2%E4%B8%B2\"><span class=\"toc-text\">ä¸²ä¸²</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#checkShouldComponentUpdate\"><span class=\"toc-text\">checkShouldComponentUpdate</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#shallowEqual\"><span class=\"toc-text\">shallowEqual</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#is\"><span class=\"toc-text\">is</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#end-and-start\"><span class=\"toc-text\">end and start</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%8E-beginWork-%E4%B8%B2%E4%B8%B2\"><span class=\"toc-text\">ä¸ beginWork ä¸²ä¸²</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#resumeMountClassInstance\"><span class=\"toc-text\">resumeMountClassInstance</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#startPhaseTimer\"><span class=\"toc-text\">startPhaseTimer</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#updateClassComponent\"><span class=\"toc-text\">updateClassComponent</span></a></li></ol>","author":{"name":"é™ˆæµ·é¾™","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"éœ€è¦å°±å­¦å‘—ï¼Œå¤šå¤§ç‚¹äº‹ğŸ˜‚","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"React@16.5.0 diffing algorithm","uid":"591f2a8f52aa8db4f8ec9853d594cc54","slug":"2022-07-22react-diffing","date":"2022-07-22T01:16:00.000Z","updated":"2022-09-15T13:16:25.592Z","comments":true,"path":"api/articles/2022-07-22react-diffing.json","keywords":null,"cover":[],"text":"è¯´æ˜ React provides a declarative API so that you donâ€™t have to worry about exactly what changes on every update. This makes writing applicati...","link":"","photos":[],"count_time":{"symbolsCount":"5k","symbolsTime":"5 mins."},"categories":[{"name":"React@16.5.0","slug":"React-16-5-0","count":5,"path":"api/categories/React-16-5-0.json"}],"tags":[{"name":"react@16.5.0","slug":"react-16-5-0","count":5,"path":"api/tags/react-16-5-0.json"}],"author":{"name":"é™ˆæµ·é¾™","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"éœ€è¦å°±å­¦å‘—ï¼Œå¤šå¤§ç‚¹äº‹ğŸ˜‚","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"React@16.5.0 unsafe_","uid":"f07658ed4d8d481756bfa8b0d656b104","slug":"2022-07-21react-unsafe","date":"2022-07-21T06:23:16.000Z","updated":"2022-09-15T13:16:21.712Z","comments":true,"path":"api/articles/2022-07-21react-unsafe.json","keywords":null,"cover":null,"text":"æˆ‘æ•´ç†è¿™ç¯‡æ–‡ç« çš„ç›®çš„å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘åœ¨å­¦æŠ€æœ¯æ—¶å€™æ›´å¤šå…³æ³¨çš„æ˜¯æ•™ç¨‹å’Œæ–‡æ¡£,åŸå› æœ‰ä¸‰ï¼šæ—¶é—´ç´§ã€ä»»åŠ¡é‡ã€æ–°æŠ€æœ¯å¾ˆå¤š æœ€è¿‘æ‰‹å¤´æ— äº‹ï¼Œåˆšå¥½æœæºç æœåˆ°äº†ï¼Œå¸Œæœ›é—²æš‡ä¹‹ä½™ï¼Œä½ ä¹Ÿèƒ½äº†è§£ React å˜æ›´è¿‡ç¨‹ï¼ŒåŠ æ·± React çš„ç†è§£ è¿‡æ—¶çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå¾€å¾€ä¼šå¸¦æ¥ä¸å®‰å…¨çš„ç¼–ç å®è·µ componentWi...","link":"","photos":[],"count_time":{"symbolsCount":"17k","symbolsTime":"15 mins."},"categories":[{"name":"React@16.5.0","slug":"React-16-5-0","count":5,"path":"api/categories/React-16-5-0.json"}],"tags":[{"name":"react@16.5.0","slug":"react-16-5-0","count":5,"path":"api/tags/react-16-5-0.json"}],"author":{"name":"é™ˆæµ·é¾™","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"éœ€è¦å°±å­¦å‘—ï¼Œå¤šå¤§ç‚¹äº‹ğŸ˜‚","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}