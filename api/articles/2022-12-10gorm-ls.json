{"title":"gorm 神坑~","uid":"1f1a9623ce6b522ab39575958416eb6f","slug":"2022-12-10gorm-ls","date":"2022-12-10T09:10:12.000Z","updated":"2022-12-22T13:36:21.801Z","comments":true,"path":"api/articles/2022-12-10gorm-ls.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/202212211225570.webp","content":"<h2 id=\"官方文档\"><a href=\"#官方文档\" class=\"headerlink\" title=\"官方文档\"></a>官方文档</h2><h2 id=\"坑-1、-generated-always-as-run-SQL-syntax-Error\"><a href=\"#坑-1、-generated-always-as-run-SQL-syntax-Error\" class=\"headerlink\" title=\"坑 1、 generated always as run SQL syntax Error\"></a>坑 1、 generated always as run SQL syntax Error</h2><p><a href=\"https://github.com/go-gorm/gorm/issues/5914\" target=\"_blank\" >&#x2F;issues&#x2F;5914</a></p>\n<p><span style=\"color: red\">转化的 sql 丢 data_type</span></p>\n<h2 id=\"坑-2、-Model-amp-User\"><a href=\"#坑-2、-Model-amp-User\" class=\"headerlink\" title=\"坑 2、 .Model(&amp;User{})\"></a>坑 2、 .Model(&amp;User{})</h2><p><a href=\"https://gorm.io/docs/update.html#Update-Hooks\" target=\"_blank\" >官网神坑</a></p>\n<pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\">db.Debug().Model(&amp;User&#123;&#125;).Where(&quot;id &#x3D; ?&quot;, user.ID).Updates(user)\n\n&#x2F;&#x2F; 这又是个坑 gorm官网可是贼坑，&amp;User&#123;&#125; 这尼玛怎么写的demo，是真的狗\n&#x2F;&#x2F; 直接导致hook全零值</code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1\n更新前\nUser BeforeSave执行了\nUser11 BeforeUpdate执行了\n&#123;\n        &quot;ID&quot;: 0,\n        &quot;DeletedAt&quot;: null,\n        &quot;Name&quot;: &quot;&quot;,\n        &quot;Email&quot;: null,\n        &quot;Age&quot;: 0,\n        &quot;Birthday&quot;: null,\n        &quot;MemberNumber&quot;: &#123;\n                &quot;String&quot;: &quot;&quot;,\n                &quot;Valid&quot;: false\n        &#125;,\n        &quot;ActivatedAt&quot;: &#123;\n                &quot;Time&quot;: &quot;0001-01-01T00:00:00Z&quot;,\n                &quot;Valid&quot;: false\n        &#125;,\n        &quot;Active&quot;: &#123;\n                &quot;Bool&quot;: false,\n                &quot;Valid&quot;: false\n        &#125;,\n        &quot;CreatedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,\n        &quot;UpdatedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,\n        &quot;CreditCard&quot;: &#123;\n                &quot;ID&quot;: 0,\n                &quot;CreatedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,\n                &quot;UpdatedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,\n                &quot;DeletedAt&quot;: null,\n                &quot;Number&quot;: &quot;&quot;,\n                &quot;UserID&quot;: 0\n        &#125;,\n        &quot;FirstName&quot;: &quot;&quot;,\n        &quot;LastName&quot;: &quot;&quot;,\n        &quot;FullName&quot;: &quot;&quot;\n&#125;更新后</code></pre>\n\n<p><span style=\"color: red\">updates 更新的时候 不要写 .Model, 这届导致 hook 接到空数据，空数据属性全是“零值”</span></p>\n<pre class=\"line-numbers language-Go\" data-language=\"Go\"><code class=\"language-Go\">package main\n\nimport (\n\t&quot;bytes&quot;\n\t&quot;database&#x2F;sql&quot;\n\t&quot;encoding&#x2F;json&quot;\n\t&quot;errors&quot;\n\t&quot;fmt&quot;\n\t&quot;log&quot;\n\t&quot;os&quot;\n\t&quot;time&quot;\n\n\tspew &quot;github.com&#x2F;davecgh&#x2F;go-spew&#x2F;spew&quot;\n\t&quot;gorm.io&#x2F;driver&#x2F;mysql&quot;\n\t&quot;gorm.io&#x2F;gorm&quot;\n)\n\n&#x2F;&#x2F; User 有一张 CreditCard，UserID 是外键\ntype User struct &#123; &#x2F;&#x2F; 拥有者\n\tgorm.Model\n\tName         string &#96;gorm:&quot;default:haotian&quot;&#96;\n\tEmail        *string\n\tAge          uint8 &#96;gorm:&quot;default:30&quot;&#96;\n\tBirthday     *time.Time\n\tMemberNumber sql.NullString\n\tActivatedAt  sql.NullTime\n\tActive       sql.NullBool &#96;gorm:&quot;default:true&quot;&#96;\n\tCreatedAt    time.Time\n\tUpdatedAt    time.Time\n\tCreditCard   CreditCard &#x2F;&#x2F; 一对一的关系\n\n\tFirstName string\n\tLastName  string\n\n\tFullName string &#96;gorm:&quot;-&gt;;type:GENERATED ALWAYS AS (concat(firstname,&#39; &#39;,lastname));default:(-);&quot;&#96;\n\n\t&#x2F;&#x2F; ALTER TABLE &#96;results&#96; add  COLUMN &#96;full_name&#96; longtext  generated always as (concat(results.first_name,&#39; &#39;,results.last_name));\n&#125;\n\n\nfunc (u *User) BeforeUpdate(tx *gorm.DB) (err error) &#123;\n\tfmt.Println(&quot;User11 BeforeUpdate执行了&quot;)\n\tJsonPrint(u)\n\n\tif u.Age &lt; 100 || u.Name &#x3D;&#x3D; &quot;&quot; &#123;\n\t\treturn errors.New(&quot;invalid Age or Name&quot;)\n\t&#125;\n\n\treturn nil\n&#125;\n\nfunc (u *User) AfterUpdate(*gorm.DB) (err error) &#123;\n\tfmt.Println(&quot;User AfterUpdate执行了&quot;)\n\treturn\n&#125;\nfunc (u *User) BeforeSave(*gorm.DB) (err error) &#123;\n\tfmt.Println(&quot;User BeforeSave执行了&quot;)\n\treturn\n&#125;\nfunc (u *User) AfterSave(*gorm.DB) (err error) &#123;\n\tfmt.Println(&quot;User AfterSave执行了&quot;)\n\treturn\n&#125;\n\n&#x2F;&#x2F; 增加信用卡结构体\ntype CreditCard struct &#123;\n\tgorm.Model\n\tNumber string\n\tUserID uint\n&#125;\n\ntype Result struct &#123;\n\tID   uint8\n\tName string\n&#125;\n\nfunc JsonPrint(val any) &#123;\n\n\tb, _ :&#x3D; json.Marshal(val)\n\n\tvar out bytes.Buffer\n\n\terr :&#x3D; json.Indent(&amp;out, b, &quot;&quot;, &quot;\\t&quot;)\n\tif err !&#x3D; nil &#123;\n\t\tlog.Fatalln(err)\n\t&#125;\n\n\tout.WriteTo(os.Stdout)\n&#125;\n\nfunc main() &#123;\n\t&#x2F;&#x2F; 参考 https:&#x2F;&#x2F;github.com&#x2F;go-sql-driver&#x2F;mysql#dsn-data-source-name 获取详情\n\tdsn :&#x3D; &quot;root:123456@tcp(localhost:3306)&#x2F;gorm_demo?charset&#x3D;utf8mb4&amp;parseTime&#x3D;True&amp;loc&#x3D;Local&quot;\n\tdb, err :&#x3D; gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)\n\n\tif err !&#x3D; nil &#123;\n\t\tpanic(&quot;failed to connect database&quot;)\n\t&#125;\n\n\tvar user User\n\n\tdb.Debug().Select(&quot;id&quot;, &quot;name&quot;).Model(&amp;user).First(&amp;user, &quot;name &#x3D; ?&quot;, &quot;hali&quot;)\n\t&#x2F;&#x2F; JsonPrint(user)\n\n\tspew.Println(user.ID)\n\n\t&#x2F;&#x2F; user.Name &#x3D; &quot;hali&quot;\n\tspew.Println(&quot;更新前&quot;)\n\n  &#x2F;&#x2F; 神坑\n\t&#x2F;&#x2F; db.Debug().Model(&amp;User&#123;&#125;).Where(&quot;id &#x3D; ?&quot;, user.ID).Updates(user) &#x2F;&#x2F; hook 获取属性全部是零值\n\n  &#x2F;&#x2F; ok 1\n\t&#x2F;&#x2F; db.Debug().Where(&quot;id &#x3D; ?&quot;, user.ID).Updates(user)\n\n\n  &#x2F;&#x2F; ok 2\n  &#x2F;&#x2F; 把有数据的user地址塞进去\n  db.Debug().Model(&amp;user).Where(&quot;id &#x3D; ?&quot;, user.ID).Updates(user)\n\n\tspew.Println(&quot;更新后&quot;)\n\n&#125;\n</code></pre>\n\n<h2 id=\"坑-3、-Model-User\"><a href=\"#坑-3、-Model-User\" class=\"headerlink\" title=\"坑 3、 .Model(User{})\"></a>坑 3、 .Model(User{})</h2><p><a href=\"https://gorm.io/docs/update.html#Batch-Updates\" target=\"_blank\" >db.Model(User{})</a></p>\n<pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\">db.Model(User&#123;&#125;).Where(&quot;role &#x3D; ?&quot;, &quot;admin&quot;).Updates(User&#123;Name: &quot;hello&quot;, Age: 18&#125;)\n\n\n&#x2F;&#x2F; panic: reflect.Value.Addr of unaddressable value\n\n&#x2F;&#x2F; goroutine 1 [running]:\n&#x2F;&#x2F; reflect.Value.Addr(&#123;0x13a3620?, 0xc0002aa000?, 0xc0000f3bd8?&#125;)\n&#x2F;&#x2F;         &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;reflect&#x2F;value.go:271 +0x65\n&#x2F;&#x2F; gorm.io&#x2F;gorm&#x2F;callbacks.callMethod(0xc0000754a0, 0xc0000f3c08)\n&#x2F;&#x2F;         &#x2F;Users&#x2F;chenhailong&#x2F;go&#x2F;pkg&#x2F;mod&#x2F;gorm.io&#x2F;gorm@v1.24.2&#x2F;callbacks&#x2F;callmethod.go:20 +0xdd\n&#x2F;&#x2F; gorm.io&#x2F;gorm&#x2F;callbacks.BeforeUpdate(0xc0000754a0?)\n&#x2F;&#x2F;         &#x2F;Users&#x2F;chenhailong&#x2F;go&#x2F;pkg&#x2F;mod&#x2F;gorm.io&#x2F;gorm@v1.24.2&#x2F;callbacks&#x2F;update.go:35 +0x67\n&#x2F;&#x2F; gorm.io&#x2F;gorm.(*processor).Execute(0xc00019c230, 0xc000194a50?)\n&#x2F;&#x2F;         &#x2F;Users&#x2F;chenhailong&#x2F;go&#x2F;pkg&#x2F;mod&#x2F;gorm.io&#x2F;gorm@v1.24.2&#x2F;callbacks.go:130 +0x436\n&#x2F;&#x2F; gorm.io&#x2F;gorm.(*DB).Updates(0x13a3620?, &#123;0x13a3620?, 0xc0002aa1a0&#125;)\n&#x2F;&#x2F;         &#x2F;Users&#x2F;chenhailong&#x2F;go&#x2F;pkg&#x2F;mod&#x2F;gorm.io&#x2F;gorm@v1.24.2&#x2F;finisher_api.go:382 +0x92\n&#x2F;&#x2F; main.main()\n&#x2F;&#x2F;         &#x2F;Users&#x2F;chenhailong&#x2F;code&#x2F;github&#x2F;go&#x2F;gorm-demo&#x2F;main.go:151 +0x37f\n&#x2F;&#x2F; exit status 2</code></pre>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>gorm 能解决的，代码能解决</li>\n<li>gorm 不能解决的，代码也能解决</li>\n<li>在 gorm 出现 bug 的时候，可以改为代码判断，原生 sql</li>\n</ul>\n","text":"官方文档坑 1、 generated always as run SQL syntax Error&#x2F;issues&#x2F;5914 转化的 sql 丢 data_type 坑 2、 .Model(&amp;User{})官网神坑 db.Debug().Model(&a...","link":"","photos":[],"count_time":{"symbolsCount":"6.6k","symbolsTime":"6 mins."},"categories":[{"name":"Go","slug":"Go","count":15,"path":"api/categories/Go.json"}],"tags":[{"name":"Go","slug":"Go","count":15,"path":"api/tags/Go.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3\"><span class=\"toc-text\">官方文档</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9D%91-1%E3%80%81-generated-always-as-run-SQL-syntax-Error\"><span class=\"toc-text\">坑 1、 generated always as run SQL syntax Error</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9D%91-2%E3%80%81-Model-amp-User\"><span class=\"toc-text\">坑 2、 .Model(&amp;User{})</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9D%91-3%E3%80%81-Model-User\"><span class=\"toc-text\">坑 3、 .Model(User{})</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"go yaml 配置文件","uid":"4a6cf6bee94617c665b74d794eabdd69","slug":"2022-12-11go-yaml","date":"2022-12-11T12:29:12.000Z","updated":"2022-12-22T13:36:21.801Z","comments":true,"path":"api/articles/2022-12-11go-yaml.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/202212211225570.webp","text":"项目gin-vue-admin 这个没看懂 gin-mall 见 参考链接Golang 程序读取 yaml 配置文件 gopkg.in&#x2F;yaml.v2 ","link":"","photos":[],"count_time":{"symbolsCount":81,"symbolsTime":"1 mins."},"categories":[{"name":"Go","slug":"Go","count":15,"path":"api/categories/Go.json"}],"tags":[{"name":"Go","slug":"Go","count":15,"path":"api/tags/Go.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"gorm 敲一敲","uid":"913ea831ec1db0086e941500c02969c4","slug":"2022-12-10gorm","date":"2022-12-10T01:21:05.000Z","updated":"2022-12-22T13:36:21.801Z","comments":true,"path":"api/articles/2022-12-10gorm.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/202212211225570.webp","text":"name “date”: unsupported Scan&#x2F;&#x2F; sql: Scan error on column index 0, name &quot;date&quot;: unsupported Scan, storing driver.Value t...","link":"","photos":[],"count_time":{"symbolsCount":"2.4k","symbolsTime":"2 mins."},"categories":[{"name":"Go","slug":"Go","count":15,"path":"api/categories/Go.json"}],"tags":[{"name":"Go","slug":"Go","count":15,"path":"api/tags/Go.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}