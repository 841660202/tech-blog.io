{"title":"企业微信- 授权","uid":"d81dd412709b6fc04e7a6fd5be173494","slug":"2022-08-17wx-auth","date":"2022-08-17T08:02:43.000Z","updated":"2022-08-31T13:00:11.735Z","comments":true,"path":"api/articles/2022-08-17wx-auth.json","keywords":null,"cover":[],"content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><ul>\n<li>项目：已经有一个项目了，又整一个新项目共存</li>\n<li>域名：一级相同，二级域名不同</li>\n</ul>\n<p><strong>微信授权回调限制, 回调可信域名只能配置一个</strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/202208171607858.webp\" />\n\n<h2 id=\"变更后的授权流程\"><a href=\"#变更后的授权流程\" class=\"headerlink\" title=\"变更后的授权流程\"></a>变更后的授权流程</h2><img src=\"http://t-blog-images.aijs.top/img/202208171604440.webp\" />\n\n<p><a href=\"https://app.diagrams.net/?src=about#H841660202%2Fpic%2Fmain%2Ftask-report\" target=\"_blank\" >draw.io</a></p>\n<h2 id=\"增加调试-强制内网\"><a href=\"#增加调试-强制内网\" class=\"headerlink\" title=\"增加调试 - 强制内网\"></a>增加调试 - 强制内网</h2><p>强制 本地&#x2F;日常&#x2F;预发环境 走内网，方便在企业微信进行适配</p>\n<pre class=\"line-numbers language-ts\" data-language=\"ts\"><code class=\"language-ts\">&#x2F;&#x2F; Config 为nextjs， 运行时配置信息\n\n&#x2F;&#x2F; 方便 日常&#x2F;预发环境 到企业微信中调试\nlet forceInNetwork &#x3D; true;\n\nif (isServer &amp;&amp; Config.env &#x3D;&#x3D;&#x3D; &quot;pro&quot;) &#123;\n  &#x2F;&#x2F; 线上环境 + 服务端渲染，不强制走内网\n  forceInNetwork &#x3D; false;\n&#125; else if (!isServer &amp;&amp; window.__NEXT_DATA__.runtimeConfig.env &#x3D;&#x3D;&#x3D; &quot;pro&quot;) &#123;\n  &#x2F;&#x2F; 线上环境 + 客户端渲染，不强制走内网\n  forceInNetwork &#x3D; false;\n&#125;\n\nif (\n  !forceInNetwork &amp;&amp; &#x2F;&#x2F; 非强制内网 + 微信环境，请求头设置 x-ty-auth-type\n  getWechatUserAgent(\n    isServer ? ctx.req.headers[&quot;user-agent&quot;] : navigator.userAgent\n  )\n) &#123;\n  options.headers[&quot;x-ty-auth-type&quot;] &#x3D; &quot;wx&quot;;\n&#125;\n\n&#x2F;&#x2F; ....\n\nlet apiUrl &#x3D; &quot;&quot;;\n&#x2F;&#x2F; 非强制内网 + 服务端 + 企业微信环境， 走企业微信授权\nif (\n  !forceInNetwork &amp;&amp;\n  isServer &amp;&amp;\n  getWechatUserAgent(options.headers[&quot;user-agent&quot;])\n) &#123;\n  apiUrl &#x3D; Config.wechatAuthProviderOrigin;\n&#125; else &#123;\n  apiUrl &#x3D; Config.api;\n&#125;</code></pre>\n\n<h2 id=\"增加调试-设置-cookie\"><a href=\"#增加调试-设置-cookie\" class=\"headerlink\" title=\"增加调试 - 设置 cookie\"></a>增加调试 - 设置 cookie</h2><pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">import &#123; useRouter &#125; from &quot;@ty-fe&#x2F;next&#x2F;router&quot;;\nimport &#123; usePersistFn &#125; from &quot;ahooks&quot;;\nimport &#123; AutoCenter, Button, Card, Input, Space &#125; from &quot;antd-mobile&quot;;\nimport React, &#123; useState &#125; from &quot;react&quot;;\ninterface IProps &#123;&#125;\nconst SetCookie: React.FC&lt;IProps&gt; &#x3D; (props) &#x3D;&gt; &#123;\n  const router &#x3D; useRouter();\n  const [cookie, setCookie] &#x3D; useState(\n    &quot;ss_pweTnTjCiU_1bVtt6GNbd4UT2B7nK87S8xCXE3t0xuqMqDmlu7mH7PoBQ_HwwCYA616QM_9d_2yUsduiNyRrXrXQWZG1TtD7ZNNI1k3XMBx-wsYq59DKsv3Bh6nnZ9zkG-NCHsSdxbHZZ-2bCQIZ-oZ9eGiXEIo&quot;\n  );\n  const handleSetCookie &#x3D; usePersistFn(() &#x3D;&gt; &#123;\n    document.cookie &#x3D; &quot;SSO_USER_TOKEN&quot; + &quot;&#x3D;&quot; + cookie;\n  &#125;);\n  const handleChange &#x3D; usePersistFn((v) &#x3D;&gt; &#123;\n    setCookie(v);\n  &#125;);\n\n  const handleGoMbHome &#x3D; usePersistFn(() &#x3D;&gt; &#123;\n    router.push(&quot;&#x2F;my&#x2F;mobile?activeTab&#x3D;1&quot;);\n  &#125;);\n  return (\n    &lt;Card&gt;\n      &lt;p&gt;设置cookie&lt;&#x2F;p&gt;\n      &lt;Input\n        style&#x3D;&#123;&#123; border: &quot;1px solid #000&quot; &#125;&#125;\n        value&#x3D;&#123;cookie&#125;\n        placeholder&#x3D;&quot;输入cookie&quot;\n        onChange&#x3D;&#123;handleChange&#125;\n      &#x2F;&gt;\n      &lt;br&gt;&lt;&#x2F;br&gt;\n      &lt;Space&gt;\n        &lt;Button color&#x3D;&quot;primary&quot; fill&#x3D;&quot;solid&quot; onClick&#x3D;&#123;handleSetCookie&#125;&gt;\n          设置cookie\n        &lt;&#x2F;Button&gt;\n        &lt;Button color&#x3D;&quot;primary&quot; fill&#x3D;&quot;solid&quot; onClick&#x3D;&#123;handleGoMbHome&#125;&gt;\n          移动端首页\n        &lt;&#x2F;Button&gt;\n      &lt;&#x2F;Space&gt;\n    &lt;&#x2F;Card&gt;\n  );\n&#125;;\n\nexport default SetCookie;</code></pre>\n\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><h3 id=\"No-1\"><a href=\"#No-1\" class=\"headerlink\" title=\"No.1\"></a>No.1</h3><p>对于某些需要使用到当前用户数据的页面，在作为入口的时候需要特别注意</p>\n<p><span style=\"color: red\">会出现拿不到当前登录用户信息的情况</span></p>\n<p><strong>过程如下</strong></p>\n<ol>\n<li>开始是没有授权的</li>\n<li>授权之后，页面被重定向回到该页面</li>\n<li>由于已加载了，有缓存，服务端不会再走一遍，在服务端往<code>redux</code>塞数据的时候，不会再次触发</li>\n<li>如果服务端有些接口设计的时候不是从 cookie 中获取用户信息，前端在传当前用户信息的时候，很有可能<code>redux</code>中没有该用户信息</li>\n</ol>\n<p><strong>解决方案</strong>： 在一些入口页面，<code>redux</code> 取不到用户信息时候，客户端渲染时候再次获取用户信息</p>\n<h3 id=\"No-2\"><a href=\"#No-2\" class=\"headerlink\" title=\"No.2\"></a>No.2</h3><p>部分企业微信 pc 客户端不支持<code>[].at()</code>方法, 避免使用此 api 的时候， polyfill 是解决不了问题的 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/at#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5\" target=\"_blank\" >见</a></p>\n<p><a href=\"https://github.com/zloirock/core-js/blob/b61f3c334f7a3010f376eae4fc465e68232da102/packages/core-js/modules/es.array.at.js#L11\" target=\"_blank\" >code</a></p>\n<img src=\"http://t-blog-images.aijs.top/img/202208250909849.webp\" />\n\n<p><a href=\"https://v.aijs.top/post/2022-07-14js-arr#:~:text=Copy-,at,-at()%20%E6%96%B9%E6%B3%95%E6%8E%A5%E6%94%B6\" target=\"_blank\" >2022-07-14js-arr</a></p>\n<p>经测试发现 polyfill 无效, 应该是被企业微信限制了</p>\n<img src=\"http://t-blog-images.aijs.top/img/202208250920994.webp\" />\n\n<p>企业微信限制了<code>Array</code>，为何有的企业微信客户端可以，我猜是企业微信的一个 bug</p>\n<img src=\"http://t-blog-images.aijs.top/img/202208250949357.webp\" />\n\n<h3 id=\"No-3\"><a href=\"#No-3\" class=\"headerlink\" title=\"No.3\"></a>No.3</h3>","text":"背景 项目：已经有一个项目了，又整一个新项目共存 域名：一级相同，二级域名不同 微信授权回调限制, 回调可信域名只能配置一个 变更后的授权流程 draw.io 增加调试 - 强制内网强制 本地&#x2F;日常&#x2F;预发环境 走内网，方便在企业微信进行适配 &#x2F;&#x...","link":"","photos":[],"count_time":{"symbolsCount":"3.5k","symbolsTime":"3 mins."},"categories":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/categories/企业微信.json"}],"tags":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/tags/企业微信.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%83%8C%E6%99%AF\"><span class=\"toc-text\">背景</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%98%E6%9B%B4%E5%90%8E%E7%9A%84%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">变更后的授权流程</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A2%9E%E5%8A%A0%E8%B0%83%E8%AF%95-%E5%BC%BA%E5%88%B6%E5%86%85%E7%BD%91\"><span class=\"toc-text\">增加调试 - 强制内网</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A2%9E%E5%8A%A0%E8%B0%83%E8%AF%95-%E8%AE%BE%E7%BD%AE-cookie\"><span class=\"toc-text\">增加调试 - 设置 cookie</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9\"><span class=\"toc-text\">注意事项</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#No-1\"><span class=\"toc-text\">No.1</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#No-2\"><span class=\"toc-text\">No.2</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#No-3\"><span class=\"toc-text\">No.3</span></a></li></ol></li></ol>","author":{"name":"陈海龙","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"需要就学呗，多大点事😂","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"前端基础-es6+","uid":"a1c8da0653d05a3bca517b77d6bf6809","slug":"2022-08-17es","date":"2022-08-17T14:46:14.000Z","updated":"2022-08-17T14:47:07.310Z","comments":true,"path":"api/articles/2022-08-17es.json","keywords":null,"cover":null,"text":"参考链接1.5万字概括ES6全部特性(已更新ES2020) ","link":"","photos":[],"count_time":{"symbolsCount":30,"symbolsTime":"1 mins."},"categories":[{"name":"前端基础","slug":"前端基础","count":26,"path":"api/categories/前端基础.json"}],"tags":[{"name":"前端基础","slug":"前端基础","count":28,"path":"api/tags/前端基础.json"}],"author":{"name":"陈海龙","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"需要就学呗，多大点事😂","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"备份插件排查code helper","uid":"0c749d9dc89621b4e02fc2ff0a775bfc","slug":"2022-08-11vscode-plugins","date":"2022-08-11T01:31:40.000Z","updated":"2022-08-31T13:00:11.734Z","comments":true,"path":"api/articles/2022-08-11vscode-plugins.json","keywords":null,"cover":[],"text":"codegen_anything codegen_mock codegen_sinipets CSS Module Typed CSS Modules Color Highlight ES7+ React&#x2F;Redux&#x2F;React-Native snippets...","link":"","photos":[],"count_time":{"symbolsCount":797,"symbolsTime":"1 mins."},"categories":[{"name":"vscode","slug":"vscode","count":2,"path":"api/categories/vscode.json"}],"tags":[{"name":"vscode","slug":"vscode","count":6,"path":"api/tags/vscode.json"}],"author":{"name":"陈海龙","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"需要就学呗，多大点事😂","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}