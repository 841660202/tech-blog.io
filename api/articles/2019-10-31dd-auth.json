{"title":"钉钉授权-单token刷新","uid":"8fa718ac5651ee524192868a31e6e820","slug":"2019-10-31dd-auth","date":"2019-10-31T12:49:53.000Z","updated":"2022-09-16T13:54:56.088Z","comments":true,"path":"api/articles/2019-10-31dd-auth.json","keywords":null,"cover":null,"content":"<h2 id=\"钉钉授权\"><a href=\"#钉钉授权\" class=\"headerlink\" title=\"钉钉授权\"></a>钉钉授权</h2><p> 钉钉小程序，单token防止进行token刷新</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">&#x2F;&#x2F; 刷新token\nfunction refreshToken(corpId, cb) &#123;\n  dd.getAuthCode(&#123;\n    success: async (res) &#x3D;&gt; &#123;\n      const params &#x3D; &#123;\n        authCode: res.authCode,\n        corpId,\n      &#125;;\n      dd.stopPullDownRefresh();\n      const resAuth &#x3D; await authDing(params);\n      &#x2F;&#x2F; 只有授权成功情况下才可以\n      if (resAuth.code &#x3D;&#x3D;&#x3D; &quot;000000&quot;) &#123;\n        saveToken(resAuth.data.token);\n        setLastTokenTime(new Date().getTime().toString());\n        if (cb) &#123;\n          cb();\n        &#125;\n      &#125; else &#123;\n        showToastFail(JSON.stringify(resAuth));\n      &#125;\n    &#125;,\n    fail: (err) &#x3D;&gt; &#123;\n      showToastFail(JSON.stringify(err));\n    &#125;,\n  &#125;);\n&#125;\n&#x2F;**\n * 钉钉授权\n * corpId 企业钉钉组织id\n * callBack 授权成功后的回调\n * *&#x2F;\nexport function ddAuth(corpId, callBack) &#123;\n  const currentTime &#x3D; new Date().getTime();\n  const lastTokenTime &#x3D; getLastTokenTime() || 0;\n  &#x2F;&#x2F; 发布\n  if (config.release) &#123;\n    try &#123;\n      &#x2F;&#x2F; 大于23小时，重新授权\n      if (currentTime - +lastTokenTime &gt; 23 * 60 * 60 * 1000) &#123;\n        refreshToken(corpId, callBack);\n        console.log(&quot;重新授权&quot;);\n      &#125; else &#123;\n        &#x2F;&#x2F; 小于23小时，大于6小时，刷新\n        callBack();\n        &#x2F;&#x2F; 刷新token\n        if (currentTime - +lastTokenTime &gt; 6 * 60 * 60 * 1000) &#123;\n          refreshToken(corpId);\n        &#125;\n      &#125;\n    &#125; catch (error) &#123;\n      showToastFail(error);\n    &#125;\n    &#x2F;&#x2F; 开发调试\n  &#125; else &#123;\n    callBack();\n    &#x2F;&#x2F; showToastFail(&quot;开发登录超时，重新登录&quot;)\n  &#125;\n&#125;</code></pre>\n","text":"钉钉授权 钉钉小程序，单token防止进行token刷新 &#x2F;&#x2F; 刷新token function refreshToken(corpId, cb) &#123; dd.getAuthCode(&#123; success: async (res) &#x3D;...","link":"","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[{"name":"钉钉小程序","slug":"钉钉小程序","count":1,"path":"api/categories/钉钉小程序.json"}],"tags":[{"name":"钉钉小程序","slug":"钉钉小程序","count":1,"path":"api/tags/钉钉小程序.json"},{"name":"token","slug":"token","count":1,"path":"api/tags/token.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%92%89%E9%92%89%E6%8E%88%E6%9D%83\"><span class=\"toc-text\">钉钉授权</span></a></li></ol>","author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"npm 包发布相关","uid":"33a4c09d5b272c8b61a9dda679d7a5e9","slug":"2022-04-28npm","date":"2020-04-28T01:20:00.000Z","updated":"2022-09-16T13:54:56.096Z","comments":true,"path":"api/articles/2022-04-28npm.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/20220519182933.webp","text":"npm 包发布npm notice &#x3D;&#x3D;&#x3D; Tarball Details &#x3D;&#x3D;&#x3D; npm notice name: @tutu-fe&#x2F;wiki-ui npm notice version: 0.1.1-bet...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"npm","slug":"npm","count":4,"path":"api/categories/npm.json"}],"tags":[{"name":"npm","slug":"npm","count":5,"path":"api/tags/npm.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"Git public key","uid":"e8f86794a8b73abb4c26e162bb1c7550","slug":"2016-06-20git","date":"2019-10-30T13:30:47.000Z","updated":"2022-09-16T13:54:56.086Z","comments":true,"path":"api/articles/2016-06-20git.json","keywords":null,"cover":[],"text":"[root@izbp1hun1qsl59e2nzqyvcz ~]# git config --global user.name &quot;hailong.chen&quot; [root@izbp1hun1qsl59e2nzqyvcz ~]# git config --glob...","link":"","photos":[],"count_time":{"symbolsCount":"5.5k","symbolsTime":"5 mins."},"categories":[{"name":"git","slug":"git","count":1,"path":"api/categories/git.json"}],"tags":[{"name":"git","slug":"git","count":1,"path":"api/tags/git.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}