{"title":"pinia源码分析 playground","uid":"cb01f973e2d0f78b875308680dd29577","slug":"2022-06-13vue-pinia","date":"2022-06-13T07:27:26.000Z","updated":"2022-09-16T13:54:56.142Z","comments":true,"path":"api/articles/2022-06-13vue-pinia.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/20220610172420.webp","content":"<h2 id=\"playground-运行\"><a href=\"#playground-运行\" class=\"headerlink\" title=\"playground 运行\"></a>playground 运行</h2><p>是一个标准的 vue 项目</p>\n<h2 id=\"package-json\"><a href=\"#package-json\" class=\"headerlink\" title=\"package.json\"></a>package.json</h2><pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&quot;scripts&quot;: &#123;\n  &quot;release&quot;: &quot;node scripts&#x2F;release.mjs&quot;,\n  &quot;size&quot;: &quot;pnpm run -r size&quot;,\n  &quot;build&quot;: &quot;pnpm run -r build&quot;,\n  &quot;docs:build&quot;: &quot;pnpm run docs:api &amp;&amp; pnpm run -r docs:build --filter .&#x2F;packages&#x2F;docs&quot;,\n  &quot;play&quot;: &quot;pnpm run -r play&quot;,\n  &quot;build:dts&quot;: &quot;pnpm run -r build:dts --parallel&quot;,\n  &quot;lint&quot;: &quot;prettier -c --parser typescript \\&quot;packages&#x2F;*&#x2F;&#123;src,__tests__,e2e&#125;&#x2F;**&#x2F;*.[jt]s?(x)\\&quot;&quot;,\n  &quot;lint:fix&quot;: &quot;pnpm run lint --write&quot;,\n  &quot;test&quot;: &quot;pnpm run test:types &amp;&amp; pnpm run test:jest &amp;&amp; pnpm run -r test &amp;&amp; pnpm run build &amp;&amp; pnpm run build:dts &amp;&amp; pnpm test:dts&quot;,\n  &quot;test:jest&quot;: &quot;jest --coverage&quot;,\n  &quot;test:types&quot;: &quot;tsc --build .&#x2F;tsconfig.json&quot;,\n  &quot;test:dts&quot;: &quot;pnpm run -r test:dts&quot;,\n  &quot;docs:api&quot;: &quot;pnpm run -r docs:api --filter .&#x2F;packages&#x2F;docs&quot;\n&#125;\n</code></pre>\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">WARNING</p>\n<p>注意 node 版本 <code>The engine &quot;node&quot; is incompatible with this module. Expected version &quot;^12.20.0 || ^14.13.1 || &gt;=16.0.0&quot;.</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">👑 ~&#x2F;Desktop&#x2F;pinia git:(v2) $ yarn\n yarn install v1.4.0\n\n     node&#x2F;14.17.4\n   ο node&#x2F;15.14.0\n     node&#x2F;16.13.1\n\n Use up&#x2F;down arrow keys to select a version, return key to install, d to delete, q to quit\n info No lockfile found.\n [1&#x2F;4] 🔍  Resolving packages...\n warning conventional-changelog-cli &gt; tempfile &gt; uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https:&#x2F;&#x2F;v8.dev&#x2F;blog&#x2F;math-random for details.\n warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 &gt; @pinia&#x2F;nuxt &gt; @nuxt&#x2F;types &gt; @types&#x2F;autoprefixer &gt; @types&#x2F;browserslist@4.15.0: This is a stub types definition. browserslist provides its own type definitions, so you do not need this installed.\n warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 &gt; @pinia&#x2F;nuxt &gt; @nuxt&#x2F;types &gt; @types&#x2F;webpack &gt; @types&#x2F;anymatch@3.0.0: This is a stub types definition. anymatch provides its own type definitions, so you do not need this installed.\n [2&#x2F;4] 🚚  Fetching packages...\n error execa@6.1.0: The engine &quot;node&quot; is incompatible with this module. Expected version &quot;^12.20.0 || ^14.13.1 || &gt;&#x3D;16.0.0&quot;.\n error An unexpected error occurred: &quot;Found incompatible module&quot;.\n info If you think this is a bug, please open a bug report with the information provided in &quot;&#x2F;Users&#x2F;haotian&#x2F;Desktop&#x2F;pinia&#x2F;yarn-error.log&quot;.\n info Visit https:&#x2F;&#x2F;yarnpkg.com&#x2F;en&#x2F;docs&#x2F;cli&#x2F;install for documentation about this command.\n 👑 ~&#x2F;Desktop&#x2F;pinia git:(v2) $ sudo n\n Password:\n   installed : v16.13.1 (with npm 8.1.2)</code></pre>\n\n\n</div>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 全局安装pnpm\nnpm install -g pnpm\n\n# 根目录\nyarn</code></pre>\n\n<h2 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">yarn build &amp;&amp; yarn play</code></pre>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p><p>如果不运行 <code>yarn build</code>,你将看到如下报错信息，原因是<code>playgound/vite.config.ts</code>，内部写了<code>copyPiniaPlugin</code></p>\n<p>[plugin:vite:import-analysis] Failed to resolve entry for package “pinia”. The package may have incorrect main&#x2F;module&#x2F;exports specified in its package.json: Failed to resolve entry for package “pinia”. The package may have incorrect main&#x2F;module&#x2F;exports specified in its package.json</p>\n</div>\n<h2 id=\"playgound-x2F-vite-config-ts\"><a href=\"#playgound-x2F-vite-config-ts\" class=\"headerlink\" title=\"playgound&#x2F;vite.config.ts\"></a>playgound&#x2F;vite.config.ts</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; defineConfig, Plugin &#125; from &quot;vite&quot;;\nimport vue from &quot;@vitejs&#x2F;plugin-vue&quot;;\nimport &#123; promises as fs &#125; from &quot;fs&quot;;\nimport path from &quot;path&quot;;\n\n&#x2F;&#x2F; https:&#x2F;&#x2F;vitejs.dev&#x2F;config&#x2F;\nexport default defineConfig(&#123;\n  plugins: [vue(), copyPiniaPlugin()],\n  define: &#123;\n    &#x2F;&#x2F; __DEV__: &#39;true&#39;,\n    &#x2F;&#x2F; __BROWSER__: &#39;true&#39;,\n    __TEST__: &quot;false&quot;,\n  &#125;,\n  resolve: &#123;\n    &#x2F;&#x2F; alias: &#123;\n    &#x2F;&#x2F;   &#39;@vue&#x2F;composition-api&#39;: &#39;vue-demi&#39;,\n    &#x2F;&#x2F; &#125;,\n    dedupe: [&quot;vue-demi&quot;, &quot;vue&quot;],\n  &#125;,\n  optimizeDeps: &#123;\n    &#x2F;&#x2F; pinia项排除\n    exclude: [&quot;vue-demi&quot;, &quot;@vueuse&#x2F;shared&quot;, &quot;@vueuse&#x2F;core&quot;, &quot;pinia&quot;],\n  &#125;,\n&#125;);\n&#x2F;&#x2F; 拷贝pinia到项目中，避免编译\nfunction copyPiniaPlugin(): Plugin &#123;\n  return &#123;\n    name: &quot;copy-pinia&quot;,\n    async generateBundle() &#123;\n      const filePath &#x3D; path.resolve(__dirname, &quot;..&#x2F;pinia&#x2F;dist&#x2F;pinia.mjs&quot;); &#x2F;&#x2F; 注意这里，不执行 yarn build 这里是没有数据的，yarn play会报错\n\n      &#x2F;&#x2F; throws if file doesn&#39;t exist\n      await fs.access(filePath);\n\n      this.emitFile(&#123;\n        type: &quot;asset&quot;,\n        fileName: &quot;pinia.mjs&quot;,\n        source: await fs.readFile(filePath, &quot;utf-8&quot;),\n      &#125;);\n    &#125;,\n  &#125;;\n&#125;</code></pre>\n\n<p><img src=\"http://t-blog-images.aijs.top/img/20220613184319.webp\"></p>\n<h2 id=\"playground-x2F-index-html\"><a href=\"#playground-x2F-index-html\" class=\"headerlink\" title=\"playground&#x2F;index.html\"></a>playground&#x2F;index.html</h2><pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;!DOCTYPE html&gt;\n&lt;!-- html解析规则--&gt;\n&lt;html lang&#x3D;&quot;en&quot;&gt;\n  &lt;head&gt;\n    &lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;\n    &lt;!-- 关键字符集 --&gt;\n    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot; &#x2F;&gt;\n    &lt;!-- 方便手机端调整分辨率 --&gt;\n    &lt;title&gt;🍍 Pinia playground&lt;&#x2F;title&gt;\n\n    &lt;link\n      rel&#x3D;&quot;stylesheet&quot;\n      href&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;@exampledev&#x2F;new.css@1&#x2F;new.min.css&quot;\n    &#x2F;&gt;\n    &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;fonts.xz.style&#x2F;serve&#x2F;inter.css&quot; &#x2F;&gt;\n    &lt;!-- 一开始以为是 首屏优化，加载动画 运行后发现，并不是，仅仅是样式而已，代码中使用v-if 或v-else-if渲染加载动画--&gt;\n    &lt;!-- \n      JokesPromised.vue \n      NasaPOD.vue \n      NasaPODwrc.vue \n    --&gt;\n    &lt;style&gt;\n      @keyframes spinner &#123;\n        to &#123;\n          transform: rotate(360deg);\n        &#125;\n      &#125;\n\n      .spinner:before &#123;\n        content: &quot;&quot;;\n        box-sizing: border-box;\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 30px;\n        height: 30px;\n        margin-top: -15px;\n        margin-left: -15px;\n        border-radius: 50%;\n        border: 1px solid #ccc;\n        border-top-color: #07d;\n        animation: spinner 0.6s linear infinite;\n      &#125;\n    &lt;&#x2F;style&gt;\n  &lt;&#x2F;head&gt;\n  &lt;body&gt;\n    &lt;!-- vue根节点 --&gt;\n    &lt;div id&#x3D;&quot;app&quot;&gt;&lt;&#x2F;div&gt;\n    &lt;!-- 模块加载 --&gt;\n    &lt;script type&#x3D;&quot;module&quot; src&#x3D;&quot;&#x2F;src&#x2F;main.ts&quot;&gt;&lt;&#x2F;script&gt;\n  &lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;</code></pre>\n\n<h2 id=\"api-目录\"><a href=\"#api-目录\" class=\"headerlink\" title=\"api 目录\"></a>api 目录</h2><p>一些小练习，demo 之类的东西，我有点不明白的是，<code>pinia/packages/playground/src/api</code>下使用了<code>mande</code>,不能直接用<code>fetch</code>吗?</p>\n<ul>\n<li><code>mande</code><strong>Requires fetch support.</strong></li>\n<li>Weekly Downloads 530 😓</li>\n<li>Unpacked Size 47.3 kB<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>为了炫技而写的，所以我没有用<code>fetch</code>，而是用了<code>mande</code>。——此处 AI 自动生成</p></blockquote>\n</li>\n</ul>\n<h2 id=\"composables-目录\"><a href=\"#composables-目录\" class=\"headerlink\" title=\"composables 目录\"></a>composables 目录</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; useCachedRequest.ts\n&#x2F;&#x2F; pinia&#x2F;packages&#x2F;playground&#x2F;src&#x2F;composables&#x2F;useCachedRequest.ts\n\nexport function useCachedRequest&lt;T, U&gt;(\n  keySource: Ref&lt;U&gt;,\n  getter: (key: U) &#x3D;&gt; Promise&lt;T&gt; &#x2F;&#x2F; 这应该是一个接口\n) &#123;\n  const data &#x3D; ref&lt;T&gt;(); &#x2F;&#x2F; 存数据\n  const isLoading &#x3D; ref(false); &#x2F;&#x2F; 加载动画\n  const isReady &#x3D; ref(false); &#x2F;&#x2F; 是否已加载数据\n  const error &#x3D; ref&lt;Error | undefined&gt;(); &#x2F;&#x2F; 有没有出错\n\n  const cache &#x3D; new Map&lt;U, T&gt;(); &#x2F;&#x2F; 使用map实现缓存\n\n  onScopeDispose(() &#x3D;&gt; &#123;\n    &#x2F;&#x2F; 清理缓存\n    cache.clear();\n  &#125;);\n\n  watchEffect(async () &#x3D;&gt; &#123;\n    const key &#x3D; unref(keySource);\n    isReady.value &#x3D; false; &#x2F;&#x2F; 是不是已拿到数据\n    isLoading.value &#x3D; true; &#x2F;&#x2F; 加载动画\n\n    if (cache.has(key)) &#123;\n      data.value &#x3D; cache.get(key)!;\n      isReady.value &#x3D; true;\n    &#125;\n\n    getter(key)\n      .then((newData) &#x3D;&gt; &#123;\n        cache.set(key, newData);\n        data.value &#x3D; newData;\n        isReady.value &#x3D; true;\n      &#125;)\n      .catch((err) &#x3D;&gt; &#123;\n        error.value &#x3D; err;\n      &#125;)\n      .finally(() &#x3D;&gt; &#123;\n        isLoading.value &#x3D; false;\n      &#125;);\n  &#125;);\n\n  return &#123; data, error, isLoading, isReady &#125;; &#x2F;&#x2F; 最后将这些值返回\n&#125;</code></pre>\n\n<hr/>\n\n<h2 style=\"text-aligin:center\">小插曲</h2>\n\n<p><strong>onScopeDispose</strong></p>\n<p>这个 api 没见过，搜下其他人是怎么理解的</p>\n<p>在 vue3.2 中新增了一个属性 EffectScope，官方文档的解释比较简单，只说是一个高级属性，并没有具体的示例。</p>\n<p>antfu 大神的 vueuse 框架源码，里面大量使用 EffectScope，所以研究了一下这个属性的使用方法。</p>\n<h2 id=\"什么是-EffectScope\"><a href=\"#什么是-EffectScope\" class=\"headerlink\" title=\"什么是 EffectScope?\"></a>什么是 EffectScope?</h2><p>下面是官方文档解释，感觉有点敷衍</p>\n<p>Effect scope is an advanced API primarily intended for library authors. For details on how to leverage this API, please consult its corresponding RFC(opens new window).<br>这个 api 是高级的，主要用于库的开发者。更多详情，请参考其对应的 RFC(新窗口打开)。</p>\n<p>RFC 关于 EffectScopeApi 的解释</p>\n<p>在 Vue 的 setup 中，响应会在开始初始化的时候被收集，在实例被卸载的时候，响应就会自动的被取消追踪了，这时一个很方便的特性。但是，当我们在组件外使用或者编写一个独立的包时，这会变得非常麻烦。当在单独的文件中，我们该<strong>如何停止 computed &amp; watch 的响应式依赖呢？</strong></p>\n<p>实际上 EffectScope 按我的理解就是副作用生效的作用域。</p>\n<p>vue3 对响应式的监听是通过 effect 实现的，当我们的组件销毁的时候 vue 会自动取消该组件的 effect。</p>\n<p>那么如果我们想要自己控制 effect 生效与否呢？ 比如我只想在莫种特定情况下才监听摸个 ref，其他情况下不想监听该怎么做？</p>\n<p>vue3.2 之前</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F;（vue-RFC示例代码）\nconst disposables &#x3D; [];\n\nconst counter &#x3D; ref(0);\nconst doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\ndisposables.push(() &#x3D;&gt; stop(doubled.effect));\n\nconst stopWatch1 &#x3D; watchEffect(() &#x3D;&gt; &#123;\n  console.log(&#96;counter: $&#123;counter.value&#125;&#96;);\n&#125;);\n\ndisposables.push(stopWatch1);\n\nconst stopWatch2 &#x3D; watch(doubled, () &#x3D;&gt; &#123;\n  console.log(doubled.value);\n&#125;);\n\ndisposables.push(stopWatch2);</code></pre>\n\n<h2 id=\"EffectScope-如何实现\"><a href=\"#EffectScope-如何实现\" class=\"headerlink\" title=\"EffectScope 如何实现\"></a>EffectScope 如何实现</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; effect, computed, watch, watchEffect created inside the scope will be collected\n\nconst scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; to dispose all effects in the scope\nscope.stop();</code></pre>\n\n<p>示例;</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\nlet counter &#x3D; ref(0);\nsetInterval(() &#x3D;&gt; &#123;\n  counter.value++;\n&#125;, 1000);\nscope.run(() &#x3D;&gt; &#123;\n  watchEffect(() &#x3D;&gt; console.log(&#96;counter: $&#123;counter.value&#125;&#96;));\n&#125;);\n&#x2F;*log:\ncounter: 0\ncounter: 1\ncounter: 2\ncounter: 3\ncounter: 4\ncounter: 5\n*&#x2F;</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\nlet counter &#x3D; ref(0);\nsetInterval(() &#x3D;&gt; &#123;\n  counter.value++;\n&#125;, 1000);\nscope.run(() &#x3D;&gt; &#123;\n  watchEffect(() &#x3D;&gt; console.log(&#96;counter: $&#123;counter.value&#125;&#96;));\n&#125;);\nscope.stop();\n&#x2F;*log:\ncounter: 0\n*&#x2F;</code></pre>\n\n<p>基本使用<br>新建一个 scope:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();</code></pre>\n\n<p>一个 scope 可以执行一个 run 函数（接受一个函数作为参数，并返回该函数的返回值），并且捕获所有在该函数执行过程中创建的 effect ，包括可以创建 effect 的 API，例如 computed , watch , watchEffect :</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">scope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; the same scope can run multiple times\nscope.run(() &#x3D;&gt; &#123;\n  watch(counter, () &#x3D;&gt; &#123;\n    &#x2F;*...*&#x2F;\n  &#125;);\n&#125;);</code></pre>\n\n<p>当调用 scope.stop(), 所有被捕获的 effect 都会被取消，包括 nested Scopes 也会被递归取消</p>\n<h2 id=\"Nested-Scopes\"><a href=\"#Nested-Scopes\" class=\"headerlink\" title=\"Nested Scopes\"></a>Nested Scopes</h2><p>嵌套 scope 也会被他们的父级 scope 收集。并且当父级 scope 销毁的时候，所有的后代 scope 也会被递归销毁。</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  &#x2F;&#x2F; not need to get the stop handler, it will be collected by the outer scope\n  effectScope().run(() &#x3D;&gt; &#123;\n    watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n  &#125;);\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; dispose all effects, including those in the nested scopes\nscope.stop();</code></pre>\n\n<h2 id=\"Detached-Nested-Scopes\"><a href=\"#Detached-Nested-Scopes\" class=\"headerlink\" title=\"Detached Nested Scopes\"></a>Detached Nested Scopes</h2><p>effectScope 接受一个参数可以在分离模式（detached mode）下创建。 detached scope 不会被父级 collect。</p>\n<p>这一特性同时解决了一个 Issues lazy Initialization。</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">let nestedScope;\n\nconst parentScope &#x3D; effectScope();\n\nparentScope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  &#x2F;&#x2F; with the detected flag,\n  &#x2F;&#x2F; the scope will not be collected and disposed by the outer scope\n  nestedScope &#x3D; effectScope(true &#x2F;* detached *&#x2F;);\n  nestedScope.run(() &#x3D;&gt; &#123;\n    watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n  &#125;);\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; disposes all effects, but not &#96;nestedScope&#96;\nparentScope.stop();\n\n&#x2F;&#x2F; stop the nested scope only when appropriate\nnestedScope.stop();</code></pre>\n\n<p>onScopeDispose<br>全局钩子函数 onScopeDispose 提供了类似于 onUnmounted 的功能，不同的是它工作在 scope 中而不是当前 instance。</p>\n<p>这使得 composable functions 可以通过他们的 scope 清除他们的副作用。</p>\n<p>由于 setup() 默认会为当前 instance 创建一个 scope，所以当没有明确声明一个 scope 的时候，onScopeDispose 等同于 onUnmounted。</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; onScopeDispose &#125; from &quot;vue&quot;;\n\nconst scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  onScopeDispose(() &#x3D;&gt; &#123;\n    console.log(&quot;cleaned!&quot;);\n  &#125;);\n&#125;);\n\nscope.stop(); &#x2F;&#x2F; logs &#39;cleaned!&#39;</code></pre>\n\n<p>Getting the current Scope</p>\n<p>通过 getCurrentScope() 可以获取当前 scope</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; getCurrentScope &#125; from &quot;vue&quot;;\n\ngetCurrentScope(); &#x2F;&#x2F; EffectScope | undefined</code></pre>\n\n<p>实战<br>示例：Shared Composable<br>一些 composables 会设置全局副作用，例如如下的 useMouse() function:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">function useMouse() &#123;\n  const x &#x3D; ref(0);\n  const y &#x3D; ref(0);\n\n  window.addEventListener(&quot;mousemove&quot;, handler);\n\n  function handler(e) &#123;\n    x.value &#x3D; e.x;\n    y.value &#x3D; e.y;\n  &#125;\n\n  onUnmounted(() &#x3D;&gt; &#123;\n    window.removeEventListener(&quot;mousemove&quot;, handler);\n  &#125;);\n\n  return &#123; x, y &#125;;\n&#125;</code></pre>\n\n<p>如果在多个组件中调用 useMouse () ，则每个组件将附加一个 mouseemove 监听器，并创建自己的 x 和 y refs 副本。我们应该能够通过在多个组件之间共享相同的侦听器集和 refs 来提高效率，但是我们做不到，因为每个 onUnmounted 调用都耦合到一个组件实例。</p>\n<p>我们可以使用分离作用域和 onScopeDispose 来实现这一点, 首先，我们需要用 onScopeDispose 替换 onUnmounted</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">- onUnmounted(() &#x3D;&gt; &#123;\n\n* onScopeDispose(() &#x3D;&gt; &#123;\n  window.removeEventListener(&#39;mousemove&#39;, handler)\n  &#125;)</code></pre>\n\n<p>这仍然有效，因为 Vue 组件现在也在作用域内运行其 setup () ，该作用域将在组件卸载时释放。</p>\n<p>然后，我们可以创建一个工具函数来管理父范围订阅:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">function createSharedComposable(composable) &#123;\n  let subscribers &#x3D; 0;\n  let state, scope;\n\n  const dispose &#x3D; () &#x3D;&gt; &#123;\n    if (scope &amp;&amp; --subscribers &lt;&#x3D; 0) &#123;\n      scope.stop();\n      state &#x3D; scope &#x3D; null;\n    &#125;\n  &#125;;\n  &#x2F;&#x2F; 这里只有在第一次运行的时候创建一个 state, 后面所有的组件就不会再创建新的 state，而是共用一个 state\n  return (...args) &#x3D;&gt; &#123;\n    subscribers++;\n    if (!state) &#123;\n      scope &#x3D; effectScope(true);\n      state &#x3D; scope.run(() &#x3D;&gt; composable(...args));\n    &#125;\n    onScopeDispose(dispose);\n    return state;\n  &#125;;\n&#125;</code></pre>\n\n<p>现在我们就可以使用这个 shared 版本的 useMouse</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const useSharedMouse &#x3D; createSharedComposable(useMouse);</code></pre>\n\n<p>通过这个例子，不禁想到，是否可以通过这种模式模拟 vuex 的能力？我们是否可以通过 shared composables 更加灵活的达到全局状态管理的目的呢？</p>\n<p>作者：zifeiyu<br>链接：<a href=\"https://juejin.cn/post/7019241635942760455\">https://juejin.cn/post/7019241635942760455</a></p>\n<p>总结：说了一大堆，大概意思是提供在组件外进行副作用清理的 api，这也是为什么说给库的开发者使用</p>\n<hr/>\n\n<h2 id=\"stores-目录，对应-v2-的-vuex\"><a href=\"#stores-目录，对应-v2-的-vuex\" class=\"headerlink\" title=\"stores 目录，对应 v2 的 vuex\"></a>stores 目录，对应 v2 的 vuex</h2><p>一个购物车的例子</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; .\n&#x2F;&#x2F; ├── cart.ts\n&#x2F;&#x2F; ├── counter.ts\n&#x2F;&#x2F; ├── counterSetup.ts\n&#x2F;&#x2F; ├── demo-counter.ts\n&#x2F;&#x2F; ├── jokes-swrv.ts\n&#x2F;&#x2F; ├── jokes.ts\n&#x2F;&#x2F; ├── jokesUsePromised.ts\n&#x2F;&#x2F; ├── nasa-pod.ts\n&#x2F;&#x2F; ├── nasa.ts\n&#x2F;&#x2F; └── user.ts</code></pre>\n\n<p><strong>user.ts</strong></p>\n<p>定义 useUserStore，id 为‘user’, state 两个字段，<br>actions 1. 登录，调用的是 apiLogin 接口，调用成功后进行数据<code>this.$patch</code>批量更新<br>actions 2. 退出登录</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; defineStore &#125; from &quot;pinia&quot;;\n\nexport const useUserStore &#x3D; defineStore(&quot;user&quot;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    name: &quot;Eduardo&quot;,\n    isAdmin: true,\n  &#125;),\n  actions: &#123;\n    &#x2F;**\n     * Attempt to login a user\n     *&#x2F;\n    async login(user: string, password: string) &#123;\n      const userData &#x3D; await apiLogin(user, password);\n\n      this.$patch(&#123;\n        name: user,\n        ...userData,\n      &#125;);\n    &#125;,\n    logout() &#123;\n      this.$patch(&#123;\n        name: &quot;&quot;,\n        isAdmin: false,\n      &#125;);\n\n      &#x2F;&#x2F; we could do other stuff like redirecting the user\n    &#125;,\n  &#125;,\n&#125;);\n\n&#x2F;**\n * Simulate a login 模拟登录\n *&#x2F;\nfunction apiLogin(a: string, p: string) &#123;\n  if (a &#x3D;&#x3D;&#x3D; &quot;ed&quot; &amp;&amp; p &#x3D;&#x3D;&#x3D; &quot;ed&quot;) return Promise.resolve(&#123; isAdmin: true &#125;); &#x2F;&#x2F; 管理员\n  if (p &#x3D;&#x3D;&#x3D; &quot;ed&quot;) return Promise.resolve(&#123; isAdmin: false &#125;); &#x2F;&#x2F; 非管理员\n  return Promise.reject(new Error(&quot;invalid credentials&quot;)); &#x2F;&#x2F; 游客未认证\n&#125;</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; counter.ts\nimport &#123; acceptHMRUpdate, defineStore &#125; from &quot;pinia&quot;;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t));\n\nexport const useCounter &#x3D; defineStore(&#123;\n  id: &quot;counter&quot;,\n\n  state: () &#x3D;&gt; (&#123;\n    n: 2,\n    incrementedTimes: 0,\n    decrementedTimes: 0,\n    numbers: [] as number[],\n  &#125;),\n\n  getters: &#123;\n    double: (state) &#x3D;&gt; state.n * 2,\n  &#125;,\n\n  actions: &#123;\n    increment(amount &#x3D; 1) &#123;\n      if (typeof amount !&#x3D;&#x3D; &quot;number&quot;) &#123;\n        amount &#x3D; 1;\n      &#125;\n      this.incrementedTimes++;\n      this.n +&#x3D; amount;\n    &#125;,\n\n    changeMe() &#123;\n      console.log(&quot;change me to test HMR&quot;);\n    &#125;,\n\n    async fail() &#123;\n      const n &#x3D; this.n;\n      await delay(1000);\n      this.numbers.push(n);\n      await delay(1000);\n      if (this.n !&#x3D;&#x3D; n) &#123;\n        throw new Error(&quot;Someone changed n!&quot;);\n      &#125;\n\n      return n;\n    &#125;,\n\n    async decrementToZero(interval: number &#x3D; 300, usePatch &#x3D; true) &#123;\n      if (this.n &lt;&#x3D; 0) return;\n\n      while (this.n &gt; 0) &#123;\n        if (usePatch) &#123;\n          this.$patch(&#123;\n            &#x2F;&#x2F; 这个就比较奇怪了，我严重怀疑这里的(usePatch &#x3D; true 与 usePatch &#x3D; false)数据不一致\n            n: this.n - 1,\n            decrementedTimes: this.decrementedTimes + 1,\n          &#125;);\n          &#x2F;&#x2F; this.$patch(state &#x3D;&gt; &#123;\n          &#x2F;&#x2F;   state.n--\n          &#x2F;&#x2F;   state.decrementedTimes++\n          &#x2F;&#x2F; &#125;)\n        &#125; else &#123;\n          this.n -&#x3D; 1;\n        &#125;\n        await delay(interval);\n      &#125;\n    &#125;,\n  &#125;,\n&#125;);\n\n&#x2F;&#x2F; 这个地方没看懂.\n\nif (import.meta.hot) &#123;\n  &#x2F;&#x2F; @link: https:&#x2F;&#x2F;www.jb51.net&#x2F;article&#x2F;244749.htm\n  &#x2F;&#x2F; import.meta 是一个给 JavaScript 模块暴露特定上下文的元数据属性的对象，它包含了这个模块的信息。\n  &#x2F;&#x2F; Pinia 是 vuex 新替代方案。Pinia 中热更新实现，借助 import.meta。\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));\n&#125;</code></pre>\n\n<p>counterSetup.ts 结合 vue 做了很多操作，最后只返回了一个 state,没有 getters,actions<br>以下为 state 上的方法</p>\n<ul>\n<li>double,</li>\n<li>increment,</li>\n<li>fail,</li>\n<li>changeMe,</li>\n<li>decrementToZero,</li>\n</ul>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; counterSetup\nimport &#123; computed, toRefs, reactive &#125; from &quot;vue&quot;;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &quot;pinia&quot;;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t));\n\nexport const useCounter &#x3D; defineStore(&quot;counter-setup&quot;, () &#x3D;&gt; &#123;\n  const state &#x3D; reactive(&#123;\n    &#x2F;&#x2F; vue\n    n: 0,\n    incrementedTimes: 0,\n    decrementedTimes: 0,\n    numbers: [] as number[],\n  &#125;);\n\n  const double &#x3D; computed(() &#x3D;&gt; state.n * 2); &#x2F;&#x2F; vue\n\n  function increment(amount &#x3D; 1) &#123;\n    if (typeof amount !&#x3D;&#x3D; &quot;number&quot;) &#123;\n      amount &#x3D; 1;\n    &#125;\n    state.incrementedTimes++;\n    state.n +&#x3D; amount;\n  &#125;\n\n  function changeMe() &#123;\n    console.log(&quot;change me to test HMR&quot;);\n  &#125;\n  &#x2F;&#x2F;\n  async function fail() &#123;\n    const n &#x3D; state.n;\n    await delay(1000);\n    state.numbers.push(n);\n    await delay(1000);\n    if (state.n !&#x3D;&#x3D; n) &#123;\n      throw new Error(&quot;Someone changed n!&quot;);\n    &#125;\n\n    return n;\n  &#125;\n  &#x2F;&#x2F; 定时器直到减少到0\n  async function decrementToZero(interval: number &#x3D; 300) &#123;\n    if (state.n &lt;&#x3D; 0) return;\n\n    while (state.n &gt; 0) &#123;\n      state.n -&#x3D; 1;\n      state.decrementedTimes +&#x3D; 1;\n      await delay(interval);\n    &#125;\n  &#125;\n\n  return &#123;\n    ...toRefs(state), &#x2F;&#x2F; vue将 state 转换为 refs， TODO：toRefs这个之后可以看下源码做了怎样的处理\n    double,\n    increment,\n    fail,\n    changeMe,\n    decrementToZero,\n  &#125;;\n&#125;);\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));\n&#125;</code></pre>\n<p>demo-counter.ts 只返回一个箭头函数简写的state</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; demo-counter.ts\nimport &#123; defineStore, acceptHMRUpdate &#125; from &#39;pinia&#39;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t))\n&#x2F;&#x2F; just to ignore the not used error\ndelay(0)\n\nexport const useCounter &#x3D; defineStore(&#39;demo-counter&#39;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    n: 0,\n  &#125;),\n&#125;)\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot))\n&#125;\n</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; jokes-swrv.ts\n\nimport &#123; ref, toRaw, watch &#125; from &#39;vue&#39;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &#39;pinia&#39;\nimport &#123; getRandomJoke, Joke &#125; from &#39;..&#x2F;api&#x2F;jokes&#39;\nimport useSWRV from &#39;swrv&#39; &#x2F;&#x2F; @link https:&#x2F;&#x2F;www.npmjs.com&#x2F;package&#x2F;swrv\n\nexport const useJokesSetup &#x3D; defineStore(&#39;jokes-swrv-setup&#39;, () &#x3D;&gt; &#123;\n  &#x2F;&#x2F; const current &#x3D; ref&lt;null | Joke&gt;(null)\n  const history &#x3D; ref&lt;Joke[]&gt;([])\n  &#x2F;&#x2F; useSWRV vue组合式网络请求，之前了解代码&#96;pinia&#x2F;packages&#x2F;playground&#x2F;src&#x2F;api&#96; 中使用了‘mande’，做网络请求，我想这应该是作者为了给开发者提供更多的场景来学习pinia\n  const &#123; data, error, mutate &#125; &#x3D; useSWRV(&#39;jokes&#39;, getRandomJoke)\n  &#x2F;&#x2F; 监听data变化\n  watch(data, (joke) &#x3D;&gt; &#123;\n    console.log(&#39;changed from within the store&#39;, joke)\n    if (joke) &#123;\n      &#x2F;&#x2F; 响应式数据，  history是响应式的，需要用.value来操作\n      history.value.push(toRaw(joke))\n    &#125;\n  &#125;)\n\n  return &#123; current: data, error, history, fetchJoke: mutate &#125;\n&#125;)\n\nif (import.meta.hot) &#123;\n  &#x2F;&#x2F; import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))\n  import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))\n&#125;\n\n</code></pre>\n<p> jokes.ts 文件下，写了useJokes 和 useJokesSetup</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; jokes.ts\nimport &#123; ref, unref &#125; from &#39;vue&#39;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &#39;pinia&#39;\nimport &#123; getRandomJoke, Joke &#125; from &#39;..&#x2F;api&#x2F;jokes&#39;\n\nexport const useJokes &#x3D; defineStore(&#39;jokes&#39;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    current: null as null | Joke,\n    jokes: [] as Joke[],\n    &#x2F;&#x2F; hello: true,\n  &#125;),\n  actions: &#123;\n    async fetchJoke() &#123;\n      if (\n        this.current &amp;&amp;\n        &#x2F;&#x2F; if the request below fails, avoid adding it twice\n        &#x2F;&#x2F; 如果请求失败，就不要添加进历史记录\n        !this.jokes.includes(this.current)\n      ) &#123;\n        this.jokes.push(this.current)\n      &#125;\n\n      &#x2F;&#x2F; NOTE: Avoid patching an object because it&#39;s recursive\n      &#x2F;&#x2F; 注意：不要更新一个对象，因为它是递归的\n      &#x2F;&#x2F; this.$patch(&#123; current: await getRandomJoke() &#125;)\n      this.current &#x3D; await getRandomJoke()\n    &#125;,\n  &#125;,\n&#125;)\n\nexport const useJokesSetup &#x3D; defineStore(&#39;jokes-setup&#39;, () &#x3D;&gt; &#123;\n  const current &#x3D; ref&lt;null | Joke&gt;(null)\n  const history &#x3D; ref&lt;Joke[]&gt;([])\n\n  async function fetchJoke() &#123;\n    const cur &#x3D; unref(current.value)\n    if (\n      cur &amp;&amp;\n      &#x2F;&#x2F; if the request below fails, avoid adding it twice\n      !history.value.find((joke) &#x3D;&gt; joke.id &#x3D;&#x3D;&#x3D; cur.id)\n    ) &#123;\n      history.value.push(cur)\n    &#125;\n\n    current.value &#x3D; await getRandomJoke()\n    return current.value\n  &#125;\n\n  return &#123; current, history, fetchJoke &#125;\n&#125;)\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))\n  &#x2F;&#x2F; import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))\n&#125;\n</code></pre>","text":"playground 运行是一个标准的 vue 项目 package.json&quot;scripts&quot;: &#123; &quot;release&quot;: &quot;node scripts&#x2F;release.mjs&quot;, &quot;siz...","link":"","photos":[],"count_time":{"symbolsCount":"25k","symbolsTime":"23 mins."},"categories":[{"name":"vue","slug":"vue","count":13,"path":"api/categories/vue.json"}],"tags":[{"name":"源码","slug":"源码","count":16,"path":"api/tags/源码.json"},{"name":"vue","slug":"vue","count":13,"path":"api/tags/vue.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playground-%E8%BF%90%E8%A1%8C\"><span class=\"toc-text\">playground 运行</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#package-json\"><span class=\"toc-text\">package.json</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">安装</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%BF%90%E8%A1%8C\"><span class=\"toc-text\">运行</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playgound-x2F-vite-config-ts\"><span class=\"toc-text\">playgound&#x2F;vite.config.ts</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playground-x2F-index-html\"><span class=\"toc-text\">playground&#x2F;index.html</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#api-%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">api 目录</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#composables-%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">composables 目录</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\"><span class=\"toc-text\">小插曲</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AF-EffectScope\"><span class=\"toc-text\">什么是 EffectScope?</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EffectScope-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">EffectScope 如何实现</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Nested-Scopes\"><span class=\"toc-text\">Nested Scopes</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Detached-Nested-Scopes\"><span class=\"toc-text\">Detached Nested Scopes</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#stores-%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%AF%B9%E5%BA%94-v2-%E7%9A%84-vuex\"><span class=\"toc-text\">stores 目录，对应 v2 的 vuex</span></a></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"pinia中的vue-demi源码","uid":"a2db94377c4f0ef1a22f18cb45800737","slug":"2022-06-15vue-demi","date":"2022-06-15T01:46:31.000Z","updated":"2022-09-16T13:54:56.144Z","comments":true,"path":"api/articles/2022-06-15vue-demi.json","keywords":null,"cover":null,"text":"pinia 中的 vue-demiVue Demi 是一个让你可以开发同时支持 Vue2 和 3 的通用的 Vue 库的开发工具，而无需担心用户安装的版本。 当用户要创建一个 Vue 插件&#x2F;库时，只需将 vue-demi 安装为依赖项并将其导入，然后像之前一样发布你的插...","link":"","photos":[],"count_time":{"symbolsCount":"6k","symbolsTime":"5 mins."},"categories":[{"name":"vue","slug":"vue","count":13,"path":"api/categories/vue.json"}],"tags":[{"name":"源码","slug":"源码","count":16,"path":"api/tags/源码.json"},{"name":"vue","slug":"vue","count":13,"path":"api/tags/vue.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"javascript event","uid":"30090ec9fe2f3c6d588fdab6524f755c","slug":"2022-06-13event","date":"2022-06-13T02:31:04.000Z","updated":"2022-09-16T13:54:56.141Z","comments":true,"path":"api/articles/2022-06-13event.json","keywords":null,"cover":null,"text":"现象描述react_devtools_backend.js:4026 Warning: This synthetic event is reused for performance reasons. If you&#39;re seeing this, you&#39;re ac...","link":"","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"javascript","slug":"javascript","count":1,"path":"api/categories/javascript.json"}],"tags":[{"name":"javascript","slug":"javascript","count":1,"path":"api/tags/javascript.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><p>做好该做的，然后做自己想做的</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}