{"title":"piniaæºç åˆ†æ playground","uid":"cb01f973e2d0f78b875308680dd29577","slug":"2022-06-13vue-pinia","date":"2022-06-13T07:27:26.000Z","updated":"2022-09-16T13:54:56.142Z","comments":true,"path":"api/articles/2022-06-13vue-pinia.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/20220610172420.webp","content":"<h2 id=\"playground-è¿è¡Œ\"><a href=\"#playground-è¿è¡Œ\" class=\"headerlink\" title=\"playground è¿è¡Œ\"></a>playground è¿è¡Œ</h2><p>æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ vue é¡¹ç›®</p>\n<h2 id=\"package-json\"><a href=\"#package-json\" class=\"headerlink\" title=\"package.json\"></a>package.json</h2><pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&quot;scripts&quot;: &#123;\n  &quot;release&quot;: &quot;node scripts&#x2F;release.mjs&quot;,\n  &quot;size&quot;: &quot;pnpm run -r size&quot;,\n  &quot;build&quot;: &quot;pnpm run -r build&quot;,\n  &quot;docs:build&quot;: &quot;pnpm run docs:api &amp;&amp; pnpm run -r docs:build --filter .&#x2F;packages&#x2F;docs&quot;,\n  &quot;play&quot;: &quot;pnpm run -r play&quot;,\n  &quot;build:dts&quot;: &quot;pnpm run -r build:dts --parallel&quot;,\n  &quot;lint&quot;: &quot;prettier -c --parser typescript \\&quot;packages&#x2F;*&#x2F;&#123;src,__tests__,e2e&#125;&#x2F;**&#x2F;*.[jt]s?(x)\\&quot;&quot;,\n  &quot;lint:fix&quot;: &quot;pnpm run lint --write&quot;,\n  &quot;test&quot;: &quot;pnpm run test:types &amp;&amp; pnpm run test:jest &amp;&amp; pnpm run -r test &amp;&amp; pnpm run build &amp;&amp; pnpm run build:dts &amp;&amp; pnpm test:dts&quot;,\n  &quot;test:jest&quot;: &quot;jest --coverage&quot;,\n  &quot;test:types&quot;: &quot;tsc --build .&#x2F;tsconfig.json&quot;,\n  &quot;test:dts&quot;: &quot;pnpm run -r test:dts&quot;,\n  &quot;docs:api&quot;: &quot;pnpm run -r docs:api --filter .&#x2F;packages&#x2F;docs&quot;\n&#125;\n</code></pre>\n\n<h2 id=\"å®‰è£…\"><a href=\"#å®‰è£…\" class=\"headerlink\" title=\"å®‰è£…\"></a>å®‰è£…</h2><div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">WARNING</p>\n<p>æ³¨æ„ node ç‰ˆæœ¬ <code>The engine &quot;node&quot; is incompatible with this module. Expected version &quot;^12.20.0 || ^14.13.1 || &gt;=16.0.0&quot;.</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">ğŸ‘‘ ~&#x2F;Desktop&#x2F;pinia git:(v2) $ yarn\n yarn install v1.4.0\n\n     node&#x2F;14.17.4\n   Î¿ node&#x2F;15.14.0\n     node&#x2F;16.13.1\n\n Use up&#x2F;down arrow keys to select a version, return key to install, d to delete, q to quit\n info No lockfile found.\n [1&#x2F;4] ğŸ”  Resolving packages...\n warning conventional-changelog-cli &gt; tempfile &gt; uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https:&#x2F;&#x2F;v8.dev&#x2F;blog&#x2F;math-random for details.\n warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 &gt; @pinia&#x2F;nuxt &gt; @nuxt&#x2F;types &gt; @types&#x2F;autoprefixer &gt; @types&#x2F;browserslist@4.15.0: This is a stub types definition. browserslist provides its own type definitions, so you do not need this installed.\n warning workspace-aggregator-d3702d10-5118-458d-9b17-8c5b340f31d0 &gt; @pinia&#x2F;nuxt &gt; @nuxt&#x2F;types &gt; @types&#x2F;webpack &gt; @types&#x2F;anymatch@3.0.0: This is a stub types definition. anymatch provides its own type definitions, so you do not need this installed.\n [2&#x2F;4] ğŸšš  Fetching packages...\n error execa@6.1.0: The engine &quot;node&quot; is incompatible with this module. Expected version &quot;^12.20.0 || ^14.13.1 || &gt;&#x3D;16.0.0&quot;.\n error An unexpected error occurred: &quot;Found incompatible module&quot;.\n info If you think this is a bug, please open a bug report with the information provided in &quot;&#x2F;Users&#x2F;haotian&#x2F;Desktop&#x2F;pinia&#x2F;yarn-error.log&quot;.\n info Visit https:&#x2F;&#x2F;yarnpkg.com&#x2F;en&#x2F;docs&#x2F;cli&#x2F;install for documentation about this command.\n ğŸ‘‘ ~&#x2F;Desktop&#x2F;pinia git:(v2) $ sudo n\n Password:\n   installed : v16.13.1 (with npm 8.1.2)</code></pre>\n\n\n</div>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># å…¨å±€å®‰è£…pnpm\nnpm install -g pnpm\n\n# æ ¹ç›®å½•\nyarn</code></pre>\n\n<h2 id=\"è¿è¡Œ\"><a href=\"#è¿è¡Œ\" class=\"headerlink\" title=\"è¿è¡Œ\"></a>è¿è¡Œ</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">yarn build &amp;&amp; yarn play</code></pre>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p><p>å¦‚æœä¸è¿è¡Œ <code>yarn build</code>,ä½ å°†çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼ŒåŸå› æ˜¯<code>playgound/vite.config.ts</code>ï¼Œå†…éƒ¨å†™äº†<code>copyPiniaPlugin</code></p>\n<p>[plugin:vite:import-analysis] Failed to resolve entry for package â€œpiniaâ€. The package may have incorrect main&#x2F;module&#x2F;exports specified in its package.json: Failed to resolve entry for package â€œpiniaâ€. The package may have incorrect main&#x2F;module&#x2F;exports specified in its package.json</p>\n</div>\n<h2 id=\"playgound-x2F-vite-config-ts\"><a href=\"#playgound-x2F-vite-config-ts\" class=\"headerlink\" title=\"playgound&#x2F;vite.config.ts\"></a>playgound&#x2F;vite.config.ts</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; defineConfig, Plugin &#125; from &quot;vite&quot;;\nimport vue from &quot;@vitejs&#x2F;plugin-vue&quot;;\nimport &#123; promises as fs &#125; from &quot;fs&quot;;\nimport path from &quot;path&quot;;\n\n&#x2F;&#x2F; https:&#x2F;&#x2F;vitejs.dev&#x2F;config&#x2F;\nexport default defineConfig(&#123;\n  plugins: [vue(), copyPiniaPlugin()],\n  define: &#123;\n    &#x2F;&#x2F; __DEV__: &#39;true&#39;,\n    &#x2F;&#x2F; __BROWSER__: &#39;true&#39;,\n    __TEST__: &quot;false&quot;,\n  &#125;,\n  resolve: &#123;\n    &#x2F;&#x2F; alias: &#123;\n    &#x2F;&#x2F;   &#39;@vue&#x2F;composition-api&#39;: &#39;vue-demi&#39;,\n    &#x2F;&#x2F; &#125;,\n    dedupe: [&quot;vue-demi&quot;, &quot;vue&quot;],\n  &#125;,\n  optimizeDeps: &#123;\n    &#x2F;&#x2F; piniaé¡¹æ’é™¤\n    exclude: [&quot;vue-demi&quot;, &quot;@vueuse&#x2F;shared&quot;, &quot;@vueuse&#x2F;core&quot;, &quot;pinia&quot;],\n  &#125;,\n&#125;);\n&#x2F;&#x2F; æ‹·è´piniaåˆ°é¡¹ç›®ä¸­ï¼Œé¿å…ç¼–è¯‘\nfunction copyPiniaPlugin(): Plugin &#123;\n  return &#123;\n    name: &quot;copy-pinia&quot;,\n    async generateBundle() &#123;\n      const filePath &#x3D; path.resolve(__dirname, &quot;..&#x2F;pinia&#x2F;dist&#x2F;pinia.mjs&quot;); &#x2F;&#x2F; æ³¨æ„è¿™é‡Œï¼Œä¸æ‰§è¡Œ yarn build è¿™é‡Œæ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œyarn playä¼šæŠ¥é”™\n\n      &#x2F;&#x2F; throws if file doesn&#39;t exist\n      await fs.access(filePath);\n\n      this.emitFile(&#123;\n        type: &quot;asset&quot;,\n        fileName: &quot;pinia.mjs&quot;,\n        source: await fs.readFile(filePath, &quot;utf-8&quot;),\n      &#125;);\n    &#125;,\n  &#125;;\n&#125;</code></pre>\n\n<p><img src=\"http://t-blog-images.aijs.top/img/20220613184319.webp\"></p>\n<h2 id=\"playground-x2F-index-html\"><a href=\"#playground-x2F-index-html\" class=\"headerlink\" title=\"playground&#x2F;index.html\"></a>playground&#x2F;index.html</h2><pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;!DOCTYPE html&gt;\n&lt;!-- htmlè§£æè§„åˆ™--&gt;\n&lt;html lang&#x3D;&quot;en&quot;&gt;\n  &lt;head&gt;\n    &lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;\n    &lt;!-- å…³é”®å­—ç¬¦é›† --&gt;\n    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot; &#x2F;&gt;\n    &lt;!-- æ–¹ä¾¿æ‰‹æœºç«¯è°ƒæ•´åˆ†è¾¨ç‡ --&gt;\n    &lt;title&gt;ğŸ Pinia playground&lt;&#x2F;title&gt;\n\n    &lt;link\n      rel&#x3D;&quot;stylesheet&quot;\n      href&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;@exampledev&#x2F;new.css@1&#x2F;new.min.css&quot;\n    &#x2F;&gt;\n    &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;fonts.xz.style&#x2F;serve&#x2F;inter.css&quot; &#x2F;&gt;\n    &lt;!-- ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ é¦–å±ä¼˜åŒ–ï¼ŒåŠ è½½åŠ¨ç”» è¿è¡Œåå‘ç°ï¼Œå¹¶ä¸æ˜¯ï¼Œä»…ä»…æ˜¯æ ·å¼è€Œå·²ï¼Œä»£ç ä¸­ä½¿ç”¨v-if æˆ–v-else-ifæ¸²æŸ“åŠ è½½åŠ¨ç”»--&gt;\n    &lt;!-- \n      JokesPromised.vue \n      NasaPOD.vue \n      NasaPODwrc.vue \n    --&gt;\n    &lt;style&gt;\n      @keyframes spinner &#123;\n        to &#123;\n          transform: rotate(360deg);\n        &#125;\n      &#125;\n\n      .spinner:before &#123;\n        content: &quot;&quot;;\n        box-sizing: border-box;\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 30px;\n        height: 30px;\n        margin-top: -15px;\n        margin-left: -15px;\n        border-radius: 50%;\n        border: 1px solid #ccc;\n        border-top-color: #07d;\n        animation: spinner 0.6s linear infinite;\n      &#125;\n    &lt;&#x2F;style&gt;\n  &lt;&#x2F;head&gt;\n  &lt;body&gt;\n    &lt;!-- vueæ ¹èŠ‚ç‚¹ --&gt;\n    &lt;div id&#x3D;&quot;app&quot;&gt;&lt;&#x2F;div&gt;\n    &lt;!-- æ¨¡å—åŠ è½½ --&gt;\n    &lt;script type&#x3D;&quot;module&quot; src&#x3D;&quot;&#x2F;src&#x2F;main.ts&quot;&gt;&lt;&#x2F;script&gt;\n  &lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;</code></pre>\n\n<h2 id=\"api-ç›®å½•\"><a href=\"#api-ç›®å½•\" class=\"headerlink\" title=\"api ç›®å½•\"></a>api ç›®å½•</h2><p>ä¸€äº›å°ç»ƒä¹ ï¼Œdemo ä¹‹ç±»çš„ä¸œè¥¿ï¼Œæˆ‘æœ‰ç‚¹ä¸æ˜ç™½çš„æ˜¯ï¼Œ<code>pinia/packages/playground/src/api</code>ä¸‹ä½¿ç”¨äº†<code>mande</code>,ä¸èƒ½ç›´æ¥ç”¨<code>fetch</code>å—?</p>\n<ul>\n<li><code>mande</code><strong>Requires fetch support.</strong></li>\n<li>Weekly Downloads 530 ğŸ˜“</li>\n<li>Unpacked Size 47.3 kB<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>ä¸ºäº†ç‚«æŠ€è€Œå†™çš„ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰ç”¨<code>fetch</code>ï¼Œè€Œæ˜¯ç”¨äº†<code>mande</code>ã€‚â€”â€”æ­¤å¤„ AI è‡ªåŠ¨ç”Ÿæˆ</p></blockquote>\n</li>\n</ul>\n<h2 id=\"composables-ç›®å½•\"><a href=\"#composables-ç›®å½•\" class=\"headerlink\" title=\"composables ç›®å½•\"></a>composables ç›®å½•</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; useCachedRequest.ts\n&#x2F;&#x2F; pinia&#x2F;packages&#x2F;playground&#x2F;src&#x2F;composables&#x2F;useCachedRequest.ts\n\nexport function useCachedRequest&lt;T, U&gt;(\n  keySource: Ref&lt;U&gt;,\n  getter: (key: U) &#x3D;&gt; Promise&lt;T&gt; &#x2F;&#x2F; è¿™åº”è¯¥æ˜¯ä¸€ä¸ªæ¥å£\n) &#123;\n  const data &#x3D; ref&lt;T&gt;(); &#x2F;&#x2F; å­˜æ•°æ®\n  const isLoading &#x3D; ref(false); &#x2F;&#x2F; åŠ è½½åŠ¨ç”»\n  const isReady &#x3D; ref(false); &#x2F;&#x2F; æ˜¯å¦å·²åŠ è½½æ•°æ®\n  const error &#x3D; ref&lt;Error | undefined&gt;(); &#x2F;&#x2F; æœ‰æ²¡æœ‰å‡ºé”™\n\n  const cache &#x3D; new Map&lt;U, T&gt;(); &#x2F;&#x2F; ä½¿ç”¨mapå®ç°ç¼“å­˜\n\n  onScopeDispose(() &#x3D;&gt; &#123;\n    &#x2F;&#x2F; æ¸…ç†ç¼“å­˜\n    cache.clear();\n  &#125;);\n\n  watchEffect(async () &#x3D;&gt; &#123;\n    const key &#x3D; unref(keySource);\n    isReady.value &#x3D; false; &#x2F;&#x2F; æ˜¯ä¸æ˜¯å·²æ‹¿åˆ°æ•°æ®\n    isLoading.value &#x3D; true; &#x2F;&#x2F; åŠ è½½åŠ¨ç”»\n\n    if (cache.has(key)) &#123;\n      data.value &#x3D; cache.get(key)!;\n      isReady.value &#x3D; true;\n    &#125;\n\n    getter(key)\n      .then((newData) &#x3D;&gt; &#123;\n        cache.set(key, newData);\n        data.value &#x3D; newData;\n        isReady.value &#x3D; true;\n      &#125;)\n      .catch((err) &#x3D;&gt; &#123;\n        error.value &#x3D; err;\n      &#125;)\n      .finally(() &#x3D;&gt; &#123;\n        isLoading.value &#x3D; false;\n      &#125;);\n  &#125;);\n\n  return &#123; data, error, isLoading, isReady &#125;; &#x2F;&#x2F; æœ€åå°†è¿™äº›å€¼è¿”å›\n&#125;</code></pre>\n\n<hr/>\n\n<h2 style=\"text-aligin:center\">å°æ’æ›²</h2>\n\n<p><strong>onScopeDispose</strong></p>\n<p>è¿™ä¸ª api æ²¡è§è¿‡ï¼Œæœä¸‹å…¶ä»–äººæ˜¯æ€ä¹ˆç†è§£çš„</p>\n<p>åœ¨ vue3.2 ä¸­æ–°å¢äº†ä¸€ä¸ªå±æ€§ EffectScopeï¼Œå®˜æ–¹æ–‡æ¡£çš„è§£é‡Šæ¯”è¾ƒç®€å•ï¼Œåªè¯´æ˜¯ä¸€ä¸ªé«˜çº§å±æ€§ï¼Œå¹¶æ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚</p>\n<p>antfu å¤§ç¥çš„ vueuse æ¡†æ¶æºç ï¼Œé‡Œé¢å¤§é‡ä½¿ç”¨ EffectScopeï¼Œæ‰€ä»¥ç ”ç©¶äº†ä¸€ä¸‹è¿™ä¸ªå±æ€§çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>\n<h2 id=\"ä»€ä¹ˆæ˜¯-EffectScope\"><a href=\"#ä»€ä¹ˆæ˜¯-EffectScope\" class=\"headerlink\" title=\"ä»€ä¹ˆæ˜¯ EffectScope?\"></a>ä»€ä¹ˆæ˜¯ EffectScope?</h2><p>ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£è§£é‡Šï¼Œæ„Ÿè§‰æœ‰ç‚¹æ•·è¡</p>\n<p>Effect scope is an advanced API primarily intended for library authors. For details on how to leverage this API, please consult its corresponding RFC(opens new window).<br>è¿™ä¸ª api æ˜¯é«˜çº§çš„ï¼Œä¸»è¦ç”¨äºåº“çš„å¼€å‘è€…ã€‚æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚è€ƒå…¶å¯¹åº”çš„ RFC(æ–°çª—å£æ‰“å¼€)ã€‚</p>\n<p>RFC å…³äº EffectScopeApi çš„è§£é‡Š</p>\n<p>åœ¨ Vue çš„ setup ä¸­ï¼Œå“åº”ä¼šåœ¨å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™è¢«æ”¶é›†ï¼Œåœ¨å®ä¾‹è¢«å¸è½½çš„æ—¶å€™ï¼Œå“åº”å°±ä¼šè‡ªåŠ¨çš„è¢«å–æ¶ˆè¿½è¸ªäº†ï¼Œè¿™æ—¶ä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„ç‰¹æ€§ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç»„ä»¶å¤–ä½¿ç”¨æˆ–è€…ç¼–å†™ä¸€ä¸ªç‹¬ç«‹çš„åŒ…æ—¶ï¼Œè¿™ä¼šå˜å¾—éå¸¸éº»çƒ¦ã€‚å½“åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬è¯¥<strong>å¦‚ä½•åœæ­¢ computed &amp; watch çš„å“åº”å¼ä¾èµ–å‘¢ï¼Ÿ</strong></p>\n<p>å®é™…ä¸Š EffectScope æŒ‰æˆ‘çš„ç†è§£å°±æ˜¯å‰¯ä½œç”¨ç”Ÿæ•ˆçš„ä½œç”¨åŸŸã€‚</p>\n<p>vue3 å¯¹å“åº”å¼çš„ç›‘å¬æ˜¯é€šè¿‡ effect å®ç°çš„ï¼Œå½“æˆ‘ä»¬çš„ç»„ä»¶é”€æ¯çš„æ—¶å€™ vue ä¼šè‡ªåŠ¨å–æ¶ˆè¯¥ç»„ä»¶çš„ effectã€‚</p>\n<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦è‡ªå·±æ§åˆ¶ effect ç”Ÿæ•ˆä¸å¦å‘¢ï¼Ÿ æ¯”å¦‚æˆ‘åªæƒ³åœ¨è«ç§ç‰¹å®šæƒ…å†µä¸‹æ‰ç›‘å¬æ‘¸ä¸ª refï¼Œå…¶ä»–æƒ…å†µä¸‹ä¸æƒ³ç›‘å¬è¯¥æ€ä¹ˆåšï¼Ÿ</p>\n<p>vue3.2 ä¹‹å‰</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F;ï¼ˆvue-RFCç¤ºä¾‹ä»£ç ï¼‰\nconst disposables &#x3D; [];\n\nconst counter &#x3D; ref(0);\nconst doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\ndisposables.push(() &#x3D;&gt; stop(doubled.effect));\n\nconst stopWatch1 &#x3D; watchEffect(() &#x3D;&gt; &#123;\n  console.log(&#96;counter: $&#123;counter.value&#125;&#96;);\n&#125;);\n\ndisposables.push(stopWatch1);\n\nconst stopWatch2 &#x3D; watch(doubled, () &#x3D;&gt; &#123;\n  console.log(doubled.value);\n&#125;);\n\ndisposables.push(stopWatch2);</code></pre>\n\n<h2 id=\"EffectScope-å¦‚ä½•å®ç°\"><a href=\"#EffectScope-å¦‚ä½•å®ç°\" class=\"headerlink\" title=\"EffectScope å¦‚ä½•å®ç°\"></a>EffectScope å¦‚ä½•å®ç°</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; effect, computed, watch, watchEffect created inside the scope will be collected\n\nconst scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; to dispose all effects in the scope\nscope.stop();</code></pre>\n\n<p>ç¤ºä¾‹;</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\nlet counter &#x3D; ref(0);\nsetInterval(() &#x3D;&gt; &#123;\n  counter.value++;\n&#125;, 1000);\nscope.run(() &#x3D;&gt; &#123;\n  watchEffect(() &#x3D;&gt; console.log(&#96;counter: $&#123;counter.value&#125;&#96;));\n&#125;);\n&#x2F;*log:\ncounter: 0\ncounter: 1\ncounter: 2\ncounter: 3\ncounter: 4\ncounter: 5\n*&#x2F;</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\nlet counter &#x3D; ref(0);\nsetInterval(() &#x3D;&gt; &#123;\n  counter.value++;\n&#125;, 1000);\nscope.run(() &#x3D;&gt; &#123;\n  watchEffect(() &#x3D;&gt; console.log(&#96;counter: $&#123;counter.value&#125;&#96;));\n&#125;);\nscope.stop();\n&#x2F;*log:\ncounter: 0\n*&#x2F;</code></pre>\n\n<p>åŸºæœ¬ä½¿ç”¨<br>æ–°å»ºä¸€ä¸ª scope:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();</code></pre>\n\n<p>ä¸€ä¸ª scope å¯ä»¥æ‰§è¡Œä¸€ä¸ª run å‡½æ•°ï¼ˆæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›è¯¥å‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œå¹¶ä¸”æ•è·æ‰€æœ‰åœ¨è¯¥å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºçš„ effect ï¼ŒåŒ…æ‹¬å¯ä»¥åˆ›å»º effect çš„ APIï¼Œä¾‹å¦‚ computed , watch , watchEffect :</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">scope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; the same scope can run multiple times\nscope.run(() &#x3D;&gt; &#123;\n  watch(counter, () &#x3D;&gt; &#123;\n    &#x2F;*...*&#x2F;\n  &#125;);\n&#125;);</code></pre>\n\n<p>å½“è°ƒç”¨ scope.stop(), æ‰€æœ‰è¢«æ•è·çš„ effect éƒ½ä¼šè¢«å–æ¶ˆï¼ŒåŒ…æ‹¬ nested Scopes ä¹Ÿä¼šè¢«é€’å½’å–æ¶ˆ</p>\n<h2 id=\"Nested-Scopes\"><a href=\"#Nested-Scopes\" class=\"headerlink\" title=\"Nested Scopes\"></a>Nested Scopes</h2><p>åµŒå¥— scope ä¹Ÿä¼šè¢«ä»–ä»¬çš„çˆ¶çº§ scope æ”¶é›†ã€‚å¹¶ä¸”å½“çˆ¶çº§ scope é”€æ¯çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„åä»£ scope ä¹Ÿä¼šè¢«é€’å½’é”€æ¯ã€‚</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  &#x2F;&#x2F; not need to get the stop handler, it will be collected by the outer scope\n  effectScope().run(() &#x3D;&gt; &#123;\n    watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n  &#125;);\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; dispose all effects, including those in the nested scopes\nscope.stop();</code></pre>\n\n<h2 id=\"Detached-Nested-Scopes\"><a href=\"#Detached-Nested-Scopes\" class=\"headerlink\" title=\"Detached Nested Scopes\"></a>Detached Nested Scopes</h2><p>effectScope æ¥å—ä¸€ä¸ªå‚æ•°å¯ä»¥åœ¨åˆ†ç¦»æ¨¡å¼ï¼ˆdetached modeï¼‰ä¸‹åˆ›å»ºã€‚ detached scope ä¸ä¼šè¢«çˆ¶çº§ collectã€‚</p>\n<p>è¿™ä¸€ç‰¹æ€§åŒæ—¶è§£å†³äº†ä¸€ä¸ª Issues lazy Initializationã€‚</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">let nestedScope;\n\nconst parentScope &#x3D; effectScope();\n\nparentScope.run(() &#x3D;&gt; &#123;\n  const doubled &#x3D; computed(() &#x3D;&gt; counter.value * 2);\n\n  &#x2F;&#x2F; with the detected flag,\n  &#x2F;&#x2F; the scope will not be collected and disposed by the outer scope\n  nestedScope &#x3D; effectScope(true &#x2F;* detached *&#x2F;);\n  nestedScope.run(() &#x3D;&gt; &#123;\n    watch(doubled, () &#x3D;&gt; console.log(doubled.value));\n  &#125;);\n\n  watchEffect(() &#x3D;&gt; console.log(&quot;Count: &quot;, doubled.value));\n&#125;);\n\n&#x2F;&#x2F; disposes all effects, but not &#96;nestedScope&#96;\nparentScope.stop();\n\n&#x2F;&#x2F; stop the nested scope only when appropriate\nnestedScope.stop();</code></pre>\n\n<p>onScopeDispose<br>å…¨å±€é’©å­å‡½æ•° onScopeDispose æä¾›äº†ç±»ä¼¼äº onUnmounted çš„åŠŸèƒ½ï¼Œä¸åŒçš„æ˜¯å®ƒå·¥ä½œåœ¨ scope ä¸­è€Œä¸æ˜¯å½“å‰ instanceã€‚</p>\n<p>è¿™ä½¿å¾— composable functions å¯ä»¥é€šè¿‡ä»–ä»¬çš„ scope æ¸…é™¤ä»–ä»¬çš„å‰¯ä½œç”¨ã€‚</p>\n<p>ç”±äº setup() é»˜è®¤ä¼šä¸ºå½“å‰ instance åˆ›å»ºä¸€ä¸ª scopeï¼Œæ‰€ä»¥å½“æ²¡æœ‰æ˜ç¡®å£°æ˜ä¸€ä¸ª scope çš„æ—¶å€™ï¼ŒonScopeDispose ç­‰åŒäº onUnmountedã€‚</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; onScopeDispose &#125; from &quot;vue&quot;;\n\nconst scope &#x3D; effectScope();\n\nscope.run(() &#x3D;&gt; &#123;\n  onScopeDispose(() &#x3D;&gt; &#123;\n    console.log(&quot;cleaned!&quot;);\n  &#125;);\n&#125;);\n\nscope.stop(); &#x2F;&#x2F; logs &#39;cleaned!&#39;</code></pre>\n\n<p>Getting the current Scope</p>\n<p>é€šè¿‡ getCurrentScope() å¯ä»¥è·å–å½“å‰ scope</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; getCurrentScope &#125; from &quot;vue&quot;;\n\ngetCurrentScope(); &#x2F;&#x2F; EffectScope | undefined</code></pre>\n\n<p>å®æˆ˜<br>ç¤ºä¾‹ï¼šShared Composable<br>ä¸€äº› composables ä¼šè®¾ç½®å…¨å±€å‰¯ä½œç”¨ï¼Œä¾‹å¦‚å¦‚ä¸‹çš„ useMouse() function:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">function useMouse() &#123;\n  const x &#x3D; ref(0);\n  const y &#x3D; ref(0);\n\n  window.addEventListener(&quot;mousemove&quot;, handler);\n\n  function handler(e) &#123;\n    x.value &#x3D; e.x;\n    y.value &#x3D; e.y;\n  &#125;\n\n  onUnmounted(() &#x3D;&gt; &#123;\n    window.removeEventListener(&quot;mousemove&quot;, handler);\n  &#125;);\n\n  return &#123; x, y &#125;;\n&#125;</code></pre>\n\n<p>å¦‚æœåœ¨å¤šä¸ªç»„ä»¶ä¸­è°ƒç”¨ useMouse () ï¼Œåˆ™æ¯ä¸ªç»„ä»¶å°†é™„åŠ ä¸€ä¸ª mouseemove ç›‘å¬å™¨ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„ x å’Œ y refs å‰¯æœ¬ã€‚æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿé€šè¿‡åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº«ç›¸åŒçš„ä¾¦å¬å™¨é›†å’Œ refs æ¥æé«˜æ•ˆç‡ï¼Œä½†æ˜¯æˆ‘ä»¬åšä¸åˆ°ï¼Œå› ä¸ºæ¯ä¸ª onUnmounted è°ƒç”¨éƒ½è€¦åˆåˆ°ä¸€ä¸ªç»„ä»¶å®ä¾‹ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†ç¦»ä½œç”¨åŸŸå’Œ onScopeDispose æ¥å®ç°è¿™ä¸€ç‚¹, é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç”¨ onScopeDispose æ›¿æ¢ onUnmounted</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">- onUnmounted(() &#x3D;&gt; &#123;\n\n* onScopeDispose(() &#x3D;&gt; &#123;\n  window.removeEventListener(&#39;mousemove&#39;, handler)\n  &#125;)</code></pre>\n\n<p>è¿™ä»ç„¶æœ‰æ•ˆï¼Œå› ä¸º Vue ç»„ä»¶ç°åœ¨ä¹Ÿåœ¨ä½œç”¨åŸŸå†…è¿è¡Œå…¶ setup () ï¼Œè¯¥ä½œç”¨åŸŸå°†åœ¨ç»„ä»¶å¸è½½æ—¶é‡Šæ”¾ã€‚</p>\n<p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå·¥å…·å‡½æ•°æ¥ç®¡ç†çˆ¶èŒƒå›´è®¢é˜…:</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">function createSharedComposable(composable) &#123;\n  let subscribers &#x3D; 0;\n  let state, scope;\n\n  const dispose &#x3D; () &#x3D;&gt; &#123;\n    if (scope &amp;&amp; --subscribers &lt;&#x3D; 0) &#123;\n      scope.stop();\n      state &#x3D; scope &#x3D; null;\n    &#125;\n  &#125;;\n  &#x2F;&#x2F; è¿™é‡Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™åˆ›å»ºä¸€ä¸ª state, åé¢æ‰€æœ‰çš„ç»„ä»¶å°±ä¸ä¼šå†åˆ›å»ºæ–°çš„ stateï¼Œè€Œæ˜¯å…±ç”¨ä¸€ä¸ª state\n  return (...args) &#x3D;&gt; &#123;\n    subscribers++;\n    if (!state) &#123;\n      scope &#x3D; effectScope(true);\n      state &#x3D; scope.run(() &#x3D;&gt; composable(...args));\n    &#125;\n    onScopeDispose(dispose);\n    return state;\n  &#125;;\n&#125;</code></pre>\n\n<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª shared ç‰ˆæœ¬çš„ useMouse</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const useSharedMouse &#x3D; createSharedComposable(useMouse);</code></pre>\n\n<p>é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä¸ç¦æƒ³åˆ°ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡è¿™ç§æ¨¡å¼æ¨¡æ‹Ÿ vuex çš„èƒ½åŠ›ï¼Ÿæˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡ shared composables æ›´åŠ çµæ´»çš„è¾¾åˆ°å…¨å±€çŠ¶æ€ç®¡ç†çš„ç›®çš„å‘¢ï¼Ÿ</p>\n<p>ä½œè€…ï¼šzifeiyu<br>é“¾æ¥ï¼š<a href=\"https://juejin.cn/post/7019241635942760455\">https://juejin.cn/post/7019241635942760455</a></p>\n<p>æ€»ç»“ï¼šè¯´äº†ä¸€å¤§å †ï¼Œå¤§æ¦‚æ„æ€æ˜¯æä¾›åœ¨ç»„ä»¶å¤–è¿›è¡Œå‰¯ä½œç”¨æ¸…ç†çš„ apiï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´ç»™åº“çš„å¼€å‘è€…ä½¿ç”¨</p>\n<hr/>\n\n<h2 id=\"stores-ç›®å½•ï¼Œå¯¹åº”-v2-çš„-vuex\"><a href=\"#stores-ç›®å½•ï¼Œå¯¹åº”-v2-çš„-vuex\" class=\"headerlink\" title=\"stores ç›®å½•ï¼Œå¯¹åº” v2 çš„ vuex\"></a>stores ç›®å½•ï¼Œå¯¹åº” v2 çš„ vuex</h2><p>ä¸€ä¸ªè´­ç‰©è½¦çš„ä¾‹å­</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; .\n&#x2F;&#x2F; â”œâ”€â”€ cart.ts\n&#x2F;&#x2F; â”œâ”€â”€ counter.ts\n&#x2F;&#x2F; â”œâ”€â”€ counterSetup.ts\n&#x2F;&#x2F; â”œâ”€â”€ demo-counter.ts\n&#x2F;&#x2F; â”œâ”€â”€ jokes-swrv.ts\n&#x2F;&#x2F; â”œâ”€â”€ jokes.ts\n&#x2F;&#x2F; â”œâ”€â”€ jokesUsePromised.ts\n&#x2F;&#x2F; â”œâ”€â”€ nasa-pod.ts\n&#x2F;&#x2F; â”œâ”€â”€ nasa.ts\n&#x2F;&#x2F; â””â”€â”€ user.ts</code></pre>\n\n<p><strong>user.ts</strong></p>\n<p>å®šä¹‰ useUserStoreï¼Œid ä¸ºâ€˜userâ€™, state ä¸¤ä¸ªå­—æ®µï¼Œ<br>actions 1. ç™»å½•ï¼Œè°ƒç”¨çš„æ˜¯ apiLogin æ¥å£ï¼Œè°ƒç”¨æˆåŠŸåè¿›è¡Œæ•°æ®<code>this.$patch</code>æ‰¹é‡æ›´æ–°<br>actions 2. é€€å‡ºç™»å½•</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">import &#123; defineStore &#125; from &quot;pinia&quot;;\n\nexport const useUserStore &#x3D; defineStore(&quot;user&quot;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    name: &quot;Eduardo&quot;,\n    isAdmin: true,\n  &#125;),\n  actions: &#123;\n    &#x2F;**\n     * Attempt to login a user\n     *&#x2F;\n    async login(user: string, password: string) &#123;\n      const userData &#x3D; await apiLogin(user, password);\n\n      this.$patch(&#123;\n        name: user,\n        ...userData,\n      &#125;);\n    &#125;,\n    logout() &#123;\n      this.$patch(&#123;\n        name: &quot;&quot;,\n        isAdmin: false,\n      &#125;);\n\n      &#x2F;&#x2F; we could do other stuff like redirecting the user\n    &#125;,\n  &#125;,\n&#125;);\n\n&#x2F;**\n * Simulate a login æ¨¡æ‹Ÿç™»å½•\n *&#x2F;\nfunction apiLogin(a: string, p: string) &#123;\n  if (a &#x3D;&#x3D;&#x3D; &quot;ed&quot; &amp;&amp; p &#x3D;&#x3D;&#x3D; &quot;ed&quot;) return Promise.resolve(&#123; isAdmin: true &#125;); &#x2F;&#x2F; ç®¡ç†å‘˜\n  if (p &#x3D;&#x3D;&#x3D; &quot;ed&quot;) return Promise.resolve(&#123; isAdmin: false &#125;); &#x2F;&#x2F; éç®¡ç†å‘˜\n  return Promise.reject(new Error(&quot;invalid credentials&quot;)); &#x2F;&#x2F; æ¸¸å®¢æœªè®¤è¯\n&#125;</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; counter.ts\nimport &#123; acceptHMRUpdate, defineStore &#125; from &quot;pinia&quot;;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t));\n\nexport const useCounter &#x3D; defineStore(&#123;\n  id: &quot;counter&quot;,\n\n  state: () &#x3D;&gt; (&#123;\n    n: 2,\n    incrementedTimes: 0,\n    decrementedTimes: 0,\n    numbers: [] as number[],\n  &#125;),\n\n  getters: &#123;\n    double: (state) &#x3D;&gt; state.n * 2,\n  &#125;,\n\n  actions: &#123;\n    increment(amount &#x3D; 1) &#123;\n      if (typeof amount !&#x3D;&#x3D; &quot;number&quot;) &#123;\n        amount &#x3D; 1;\n      &#125;\n      this.incrementedTimes++;\n      this.n +&#x3D; amount;\n    &#125;,\n\n    changeMe() &#123;\n      console.log(&quot;change me to test HMR&quot;);\n    &#125;,\n\n    async fail() &#123;\n      const n &#x3D; this.n;\n      await delay(1000);\n      this.numbers.push(n);\n      await delay(1000);\n      if (this.n !&#x3D;&#x3D; n) &#123;\n        throw new Error(&quot;Someone changed n!&quot;);\n      &#125;\n\n      return n;\n    &#125;,\n\n    async decrementToZero(interval: number &#x3D; 300, usePatch &#x3D; true) &#123;\n      if (this.n &lt;&#x3D; 0) return;\n\n      while (this.n &gt; 0) &#123;\n        if (usePatch) &#123;\n          this.$patch(&#123;\n            &#x2F;&#x2F; è¿™ä¸ªå°±æ¯”è¾ƒå¥‡æ€ªäº†ï¼Œæˆ‘ä¸¥é‡æ€€ç–‘è¿™é‡Œçš„(usePatch &#x3D; true ä¸ usePatch &#x3D; false)æ•°æ®ä¸ä¸€è‡´\n            n: this.n - 1,\n            decrementedTimes: this.decrementedTimes + 1,\n          &#125;);\n          &#x2F;&#x2F; this.$patch(state &#x3D;&gt; &#123;\n          &#x2F;&#x2F;   state.n--\n          &#x2F;&#x2F;   state.decrementedTimes++\n          &#x2F;&#x2F; &#125;)\n        &#125; else &#123;\n          this.n -&#x3D; 1;\n        &#125;\n        await delay(interval);\n      &#125;\n    &#125;,\n  &#125;,\n&#125;);\n\n&#x2F;&#x2F; è¿™ä¸ªåœ°æ–¹æ²¡çœ‹æ‡‚.\n\nif (import.meta.hot) &#123;\n  &#x2F;&#x2F; @link: https:&#x2F;&#x2F;www.jb51.net&#x2F;article&#x2F;244749.htm\n  &#x2F;&#x2F; import.meta æ˜¯ä¸€ä¸ªç»™ JavaScript æ¨¡å—æš´éœ²ç‰¹å®šä¸Šä¸‹æ–‡çš„å…ƒæ•°æ®å±æ€§çš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†è¿™ä¸ªæ¨¡å—çš„ä¿¡æ¯ã€‚\n  &#x2F;&#x2F; Pinia æ˜¯ vuex æ–°æ›¿ä»£æ–¹æ¡ˆã€‚Pinia ä¸­çƒ­æ›´æ–°å®ç°ï¼Œå€ŸåŠ© import.metaã€‚\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));\n&#125;</code></pre>\n\n<p>counterSetup.ts ç»“åˆ vue åšäº†å¾ˆå¤šæ“ä½œï¼Œæœ€ååªè¿”å›äº†ä¸€ä¸ª state,æ²¡æœ‰ getters,actions<br>ä»¥ä¸‹ä¸º state ä¸Šçš„æ–¹æ³•</p>\n<ul>\n<li>double,</li>\n<li>increment,</li>\n<li>fail,</li>\n<li>changeMe,</li>\n<li>decrementToZero,</li>\n</ul>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; counterSetup\nimport &#123; computed, toRefs, reactive &#125; from &quot;vue&quot;;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &quot;pinia&quot;;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t));\n\nexport const useCounter &#x3D; defineStore(&quot;counter-setup&quot;, () &#x3D;&gt; &#123;\n  const state &#x3D; reactive(&#123;\n    &#x2F;&#x2F; vue\n    n: 0,\n    incrementedTimes: 0,\n    decrementedTimes: 0,\n    numbers: [] as number[],\n  &#125;);\n\n  const double &#x3D; computed(() &#x3D;&gt; state.n * 2); &#x2F;&#x2F; vue\n\n  function increment(amount &#x3D; 1) &#123;\n    if (typeof amount !&#x3D;&#x3D; &quot;number&quot;) &#123;\n      amount &#x3D; 1;\n    &#125;\n    state.incrementedTimes++;\n    state.n +&#x3D; amount;\n  &#125;\n\n  function changeMe() &#123;\n    console.log(&quot;change me to test HMR&quot;);\n  &#125;\n  &#x2F;&#x2F;\n  async function fail() &#123;\n    const n &#x3D; state.n;\n    await delay(1000);\n    state.numbers.push(n);\n    await delay(1000);\n    if (state.n !&#x3D;&#x3D; n) &#123;\n      throw new Error(&quot;Someone changed n!&quot;);\n    &#125;\n\n    return n;\n  &#125;\n  &#x2F;&#x2F; å®šæ—¶å™¨ç›´åˆ°å‡å°‘åˆ°0\n  async function decrementToZero(interval: number &#x3D; 300) &#123;\n    if (state.n &lt;&#x3D; 0) return;\n\n    while (state.n &gt; 0) &#123;\n      state.n -&#x3D; 1;\n      state.decrementedTimes +&#x3D; 1;\n      await delay(interval);\n    &#125;\n  &#125;\n\n  return &#123;\n    ...toRefs(state), &#x2F;&#x2F; vueå°† state è½¬æ¢ä¸º refsï¼Œ TODOï¼štoRefsè¿™ä¸ªä¹‹åå¯ä»¥çœ‹ä¸‹æºç åšäº†æ€æ ·çš„å¤„ç†\n    double,\n    increment,\n    fail,\n    changeMe,\n    decrementToZero,\n  &#125;;\n&#125;);\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot));\n&#125;</code></pre>\n<p>demo-counter.ts åªè¿”å›ä¸€ä¸ªç®­å¤´å‡½æ•°ç®€å†™çš„state</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; demo-counter.ts\nimport &#123; defineStore, acceptHMRUpdate &#125; from &#39;pinia&#39;\n\nconst delay &#x3D; (t: number) &#x3D;&gt; new Promise((r) &#x3D;&gt; setTimeout(r, t))\n&#x2F;&#x2F; just to ignore the not used error\ndelay(0)\n\nexport const useCounter &#x3D; defineStore(&#39;demo-counter&#39;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    n: 0,\n  &#125;),\n&#125;)\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useCounter, import.meta.hot))\n&#125;\n</code></pre>\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; jokes-swrv.ts\n\nimport &#123; ref, toRaw, watch &#125; from &#39;vue&#39;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &#39;pinia&#39;\nimport &#123; getRandomJoke, Joke &#125; from &#39;..&#x2F;api&#x2F;jokes&#39;\nimport useSWRV from &#39;swrv&#39; &#x2F;&#x2F; @link https:&#x2F;&#x2F;www.npmjs.com&#x2F;package&#x2F;swrv\n\nexport const useJokesSetup &#x3D; defineStore(&#39;jokes-swrv-setup&#39;, () &#x3D;&gt; &#123;\n  &#x2F;&#x2F; const current &#x3D; ref&lt;null | Joke&gt;(null)\n  const history &#x3D; ref&lt;Joke[]&gt;([])\n  &#x2F;&#x2F; useSWRV vueç»„åˆå¼ç½‘ç»œè¯·æ±‚ï¼Œä¹‹å‰äº†è§£ä»£ç &#96;pinia&#x2F;packages&#x2F;playground&#x2F;src&#x2F;api&#96; ä¸­ä½¿ç”¨äº†â€˜mandeâ€™ï¼Œåšç½‘ç»œè¯·æ±‚ï¼Œæˆ‘æƒ³è¿™åº”è¯¥æ˜¯ä½œè€…ä¸ºäº†ç»™å¼€å‘è€…æä¾›æ›´å¤šçš„åœºæ™¯æ¥å­¦ä¹ pinia\n  const &#123; data, error, mutate &#125; &#x3D; useSWRV(&#39;jokes&#39;, getRandomJoke)\n  &#x2F;&#x2F; ç›‘å¬dataå˜åŒ–\n  watch(data, (joke) &#x3D;&gt; &#123;\n    console.log(&#39;changed from within the store&#39;, joke)\n    if (joke) &#123;\n      &#x2F;&#x2F; å“åº”å¼æ•°æ®ï¼Œ  historyæ˜¯å“åº”å¼çš„ï¼Œéœ€è¦ç”¨.valueæ¥æ“ä½œ\n      history.value.push(toRaw(joke))\n    &#125;\n  &#125;)\n\n  return &#123; current: data, error, history, fetchJoke: mutate &#125;\n&#125;)\n\nif (import.meta.hot) &#123;\n  &#x2F;&#x2F; import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))\n  import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))\n&#125;\n\n</code></pre>\n<p> jokes.ts æ–‡ä»¶ä¸‹ï¼Œå†™äº†useJokes å’Œ useJokesSetup</p>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; jokes.ts\nimport &#123; ref, unref &#125; from &#39;vue&#39;\nimport &#123; acceptHMRUpdate, defineStore &#125; from &#39;pinia&#39;\nimport &#123; getRandomJoke, Joke &#125; from &#39;..&#x2F;api&#x2F;jokes&#39;\n\nexport const useJokes &#x3D; defineStore(&#39;jokes&#39;, &#123;\n  state: () &#x3D;&gt; (&#123;\n    current: null as null | Joke,\n    jokes: [] as Joke[],\n    &#x2F;&#x2F; hello: true,\n  &#125;),\n  actions: &#123;\n    async fetchJoke() &#123;\n      if (\n        this.current &amp;&amp;\n        &#x2F;&#x2F; if the request below fails, avoid adding it twice\n        &#x2F;&#x2F; å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°±ä¸è¦æ·»åŠ è¿›å†å²è®°å½•\n        !this.jokes.includes(this.current)\n      ) &#123;\n        this.jokes.push(this.current)\n      &#125;\n\n      &#x2F;&#x2F; NOTE: Avoid patching an object because it&#39;s recursive\n      &#x2F;&#x2F; æ³¨æ„ï¼šä¸è¦æ›´æ–°ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå®ƒæ˜¯é€’å½’çš„\n      &#x2F;&#x2F; this.$patch(&#123; current: await getRandomJoke() &#125;)\n      this.current &#x3D; await getRandomJoke()\n    &#125;,\n  &#125;,\n&#125;)\n\nexport const useJokesSetup &#x3D; defineStore(&#39;jokes-setup&#39;, () &#x3D;&gt; &#123;\n  const current &#x3D; ref&lt;null | Joke&gt;(null)\n  const history &#x3D; ref&lt;Joke[]&gt;([])\n\n  async function fetchJoke() &#123;\n    const cur &#x3D; unref(current.value)\n    if (\n      cur &amp;&amp;\n      &#x2F;&#x2F; if the request below fails, avoid adding it twice\n      !history.value.find((joke) &#x3D;&gt; joke.id &#x3D;&#x3D;&#x3D; cur.id)\n    ) &#123;\n      history.value.push(cur)\n    &#125;\n\n    current.value &#x3D; await getRandomJoke()\n    return current.value\n  &#125;\n\n  return &#123; current, history, fetchJoke &#125;\n&#125;)\n\nif (import.meta.hot) &#123;\n  import.meta.hot.accept(acceptHMRUpdate(useJokes, import.meta.hot))\n  &#x2F;&#x2F; import.meta.hot.accept(acceptHMRUpdate(useJokesSetup, import.meta.hot))\n&#125;\n</code></pre>","text":"playground è¿è¡Œæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ vue é¡¹ç›® package.json&quot;scripts&quot;: &#123; &quot;release&quot;: &quot;node scripts&#x2F;release.mjs&quot;, &quot;siz...","link":"","photos":[],"count_time":{"symbolsCount":"25k","symbolsTime":"23 mins."},"categories":[{"name":"vue","slug":"vue","count":13,"path":"api/categories/vue.json"}],"tags":[{"name":"æºç ","slug":"æºç ","count":16,"path":"api/tags/æºç .json"},{"name":"vue","slug":"vue","count":13,"path":"api/tags/vue.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playground-%E8%BF%90%E8%A1%8C\"><span class=\"toc-text\">playground è¿è¡Œ</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#package-json\"><span class=\"toc-text\">package.json</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">å®‰è£…</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%BF%90%E8%A1%8C\"><span class=\"toc-text\">è¿è¡Œ</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playgound-x2F-vite-config-ts\"><span class=\"toc-text\">playgound&#x2F;vite.config.ts</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#playground-x2F-index-html\"><span class=\"toc-text\">playground&#x2F;index.html</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#api-%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">api ç›®å½•</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#composables-%E7%9B%AE%E5%BD%95\"><span class=\"toc-text\">composables ç›®å½•</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\"><span class=\"toc-text\">å°æ’æ›²</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AF-EffectScope\"><span class=\"toc-text\">ä»€ä¹ˆæ˜¯ EffectScope?</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EffectScope-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">EffectScope å¦‚ä½•å®ç°</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Nested-Scopes\"><span class=\"toc-text\">Nested Scopes</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Detached-Nested-Scopes\"><span class=\"toc-text\">Detached Nested Scopes</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#stores-%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%AF%B9%E5%BA%94-v2-%E7%9A%84-vuex\"><span class=\"toc-text\">stores ç›®å½•ï¼Œå¯¹åº” v2 çš„ vuex</span></a></li></ol>","author":{"name":"ä¸¾æ‰‹æ‘˜æœˆäº®","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>çœ¼ä¸­æœ‰å…‰ï¼Œå¿ƒä¸­æœ‰æ¢¦ï¼Œè„šä¸‹æœ‰è·¯</p><p>åšå¥½è¯¥åšçš„ï¼Œç„¶ååšè‡ªå·±æƒ³åšçš„</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"piniaä¸­çš„vue-demiæºç ","uid":"a2db94377c4f0ef1a22f18cb45800737","slug":"2022-06-15vue-demi","date":"2022-06-15T01:46:31.000Z","updated":"2022-09-16T13:54:56.144Z","comments":true,"path":"api/articles/2022-06-15vue-demi.json","keywords":null,"cover":null,"text":"pinia ä¸­çš„ vue-demiVue Demi æ˜¯ä¸€ä¸ªè®©ä½ å¯ä»¥å¼€å‘åŒæ—¶æ”¯æŒ Vue2 å’Œ 3 çš„é€šç”¨çš„ Vue åº“çš„å¼€å‘å·¥å…·ï¼Œè€Œæ— éœ€æ‹…å¿ƒç”¨æˆ·å®‰è£…çš„ç‰ˆæœ¬ã€‚ å½“ç”¨æˆ·è¦åˆ›å»ºä¸€ä¸ª Vue æ’ä»¶&#x2F;åº“æ—¶ï¼Œåªéœ€å°† vue-demi å®‰è£…ä¸ºä¾èµ–é¡¹å¹¶å°†å…¶å¯¼å…¥ï¼Œç„¶ååƒä¹‹å‰ä¸€æ ·å‘å¸ƒä½ çš„æ’...","link":"","photos":[],"count_time":{"symbolsCount":"6k","symbolsTime":"5 mins."},"categories":[{"name":"vue","slug":"vue","count":13,"path":"api/categories/vue.json"}],"tags":[{"name":"æºç ","slug":"æºç ","count":16,"path":"api/tags/æºç .json"},{"name":"vue","slug":"vue","count":13,"path":"api/tags/vue.json"}],"author":{"name":"ä¸¾æ‰‹æ‘˜æœˆäº®","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>çœ¼ä¸­æœ‰å…‰ï¼Œå¿ƒä¸­æœ‰æ¢¦ï¼Œè„šä¸‹æœ‰è·¯</p><p>åšå¥½è¯¥åšçš„ï¼Œç„¶ååšè‡ªå·±æƒ³åšçš„</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"javascript event","uid":"30090ec9fe2f3c6d588fdab6524f755c","slug":"2022-06-13event","date":"2022-06-13T02:31:04.000Z","updated":"2022-09-16T13:54:56.141Z","comments":true,"path":"api/articles/2022-06-13event.json","keywords":null,"cover":null,"text":"ç°è±¡æè¿°react_devtools_backend.js:4026 Warning: This synthetic event is reused for performance reasons. If you&#39;re seeing this, you&#39;re ac...","link":"","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"javascript","slug":"javascript","count":1,"path":"api/categories/javascript.json"}],"tags":[{"name":"javascript","slug":"javascript","count":1,"path":"api/tags/javascript.json"}],"author":{"name":"ä¸¾æ‰‹æ‘˜æœˆäº®","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"<div><p>çœ¼ä¸­æœ‰å…‰ï¼Œå¿ƒä¸­æœ‰æ¢¦ï¼Œè„šä¸‹æœ‰è·¯</p><p>åšå¥½è¯¥åšçš„ï¼Œç„¶ååšè‡ªå·±æƒ³åšçš„</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}