{"title":"ant design form设置值 !== 获取值","uid":"e2b55be84d65cc914ce2f0d3a3e083d3","slug":"2022-05-13react","date":"2022-05-13T07:39:33.000Z","updated":"2022-09-16T14:57:37.978Z","comments":true,"path":"api/articles/2022-05-13react.json","keywords":null,"cover":[],"content":"<h2 id=\"有意思的事\"><a href=\"#有意思的事\" class=\"headerlink\" title=\"有意思的事\"></a>有意思的事</h2><ul>\n<li>今天维护项目遇到一个有意思的事，直观感受，设置值，再取出来，貌似没毛病<pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">  &#x2F;&#x2F; ...\n  const [values, setValues] &#x3D; useState&lt;Record&lt;string, any&gt;&gt;()\n\n  const &#123; applyStartTime, applyEndTime, attendanceType, staffId &#125; &#x3D; values || &#123;&#125;\n\n  const getDetail &#x3D; usePersistFn(async () &#x3D;&gt; &#123;\n    &#x2F;&#x2F; ...略\n    const obj: Record&lt;string, any&gt; &#x3D; &#123;\n      staffId: applyStaff.staffId,\n      attendanceType: res.result.attendanceType,\n      applyStartTime: &#123;\n        value: moment(res.result.applyStartTime),\n        half: res.result.startDayType,\n      &#125;,\n      applyEndTime: &#123;\n        value: moment(res.result.applyEndTime),\n        half: res.result.endDayType,\n      &#125;,\n      applyReason,\n      applyAttachments,\n    &#125;\n    &#x2F;&#x2F; ...略\n    form.setFieldsValue(obj)\n    setValues(form.getFieldsValue())\n  &#125;)\n\n  &#x2F;&#x2F; ...略\n  const &#123; total, loading: totalLoading &#125; &#x3D; useCaculateDays(\n    &#123;\n      start: applyStartTime,\n      end: applyEndTime,\n    &#125;,\n    staffId,\n    attendanceType,\n  )\n  &#x2F;&#x2F; ...略\n\n  &#x2F;&#x2F; AnualForm组件\n  &lt;Form.Item name&#x3D;&quot;applyStartTime&quot; label&#x3D;&quot;起始日期&quot; rules&#x3D;&#123;[&#123; required: true &#125;]&#125;&gt;\n      &lt;HalftDatePicker predict&#x3D;&#123;&#123; lessThan: end?.value &#125;&#125; &#x2F;&gt;\n    &lt;&#x2F;Form.Item&gt;\n  &lt;Form.Item name&#x3D;&quot;applyEndTime&quot; label&#x3D;&quot;结束日期&quot; rules&#x3D;&#123;[&#123; required: true &#125;]&#125;&gt;\n    &lt;HalftDatePicker predict&#x3D;&#123;&#123; moreThan: start?.value &#125;&#125; &#x2F;&gt;\n  &lt;&#x2F;Form.Item&gt;\n\n\n  type IValue &#x3D; &#123;\n    value?: moment.Moment\n    half: 1 | 2\n  &#125;\n &#x2F;&#x2F; HalftDatePicker组件\nconst HalftDatePicker: React.ForwardRefRenderFunction&lt;any, PickerProps&lt;moment.Moment&gt; &amp; &#123;\n  value?: IValue\n  onChange?: (v?: IValue) &#x3D;&gt; void\n  predict?: &#123;\n    lessThan?: moment.Moment\n    moreThan?: moment.Moment\n    holiday?: boolean\n  &#125;\n&#125;&gt; &#x3D; (props, ref) &#x3D;&gt; &#123;\n  &#x2F;&#x2F; ...略\n&#125;</code></pre></li>\n</ul>\n<p>代码的目的是： </p>\n<ol>\n<li>请求详情</li>\n<li>装配数据，更新values</li>\n<li>useCaculateDays 通过后台动态计算有效工作日，返回total请假天数，</li>\n<li>渲染total到表单对应位置</li>\n</ol>\n<h3 id=\"调试\"><a href=\"#调试\" class=\"headerlink\" title=\"调试\"></a>调试</h3><p>经过一点一点回溯调试，发现 useCaculateDays 没请求，被判断拦截掉了，往上找找，</p>\n<pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">form.setFieldsValue(obj)\nsetValues(form.getFieldsValue())</code></pre>\n\n<h3 id=\"打上日志\"><a href=\"#打上日志\" class=\"headerlink\" title=\"打上日志\"></a>打上日志</h3><pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">&#x2F;&#x2F; ...略\nconsole.log(&quot;obj&quot;,obj);\nform.setFieldsValue(obj)\nconsole.log(&quot;obj1&quot;,form.getFieldsValue());\nsetValues(obj)</code></pre>\n\n<p>发现<code>obj</code>键值内容不等于<code>obj1</code></p>\n<ul>\n<li>obj</li>\n</ul>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#123;\n    &quot;staffId&quot;: &quot;02333&quot;,\n    &quot;attendanceType&quot;: 11,\n    &quot;applyStartTime&quot;: &#123;\n        &quot;value&quot;: &quot;2022-03-23T16:00:00.000Z&quot;,\n        &quot;half&quot;: 1\n    &#125;,\n    &quot;applyEndTime&quot;: &#123;\n        &quot;value&quot;: &quot;2022-03-23T16:00:00.000Z&quot;,\n        &quot;half&quot;: 2\n    &#125;,\n    &quot;applyReason&quot;: &quot;&quot;,\n    &quot;applyAttachments&quot;: []\n&#125;\n</code></pre>\n<ul>\n<li>obj1<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#123;\n    &quot;staffId&quot;: &quot;02333&quot;,\n    &quot;attendanceType&quot;: 11,\n    &quot;applyReason&quot;: &quot;&quot;,\n    &quot;applyAttachments&quot;: []\n&#125;</code></pre></li>\n</ul>\n<p><em>猜想</em></p>\n<ul>\n<li>会不会<code>form.setFieldsValue</code>异步？查了下api是同步的<em>排除这种可能</em></li>\n<li>断点调试过程中，也会遇到表单渲染一半的情况，<code>AnualForm组件</code>是条件渲染，如果这块表单没有渲染出来，通过<code>form.getFieldsValue</code>就拿不到</li>\n</ul>\n<h3 id=\"修改代码验证下猜想\"><a href=\"#修改代码验证下猜想\" class=\"headerlink\" title=\"修改代码验证下猜想\"></a>修改代码验证下猜想</h3><pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">console.log(&quot;obj&quot;,obj);\nform.setFieldsValue(obj)\nconsole.log(&quot;obj1&quot;,form.getFieldsValue());\nsetTimeout(() &#x3D;&gt; &#123;\n  setValues(form.getFieldsValue())\n  &#125;, 5000);\n&#125;</code></pre>\n<img src=\"http://t-blog-images.aijs.top/img/Kapture%202022-05-13%20at%2016.01.46.gif\" width=300 />\n\n<h3 id=\"最终修改\"><a href=\"#最终修改\" class=\"headerlink\" title=\"最终修改\"></a>最终修改</h3><pre class=\"line-numbers language-tsx\" data-language=\"tsx\"><code class=\"language-tsx\">form.setFieldsValue(obj)\nsetValues(obj)</code></pre>","text":"有意思的事 今天维护项目遇到一个有意思的事，直观感受，设置值，再取出来，貌似没毛病 &#x2F;&#x2F; ... const [values, setValues] &#x3D; useState&lt;Record&lt;string, any&gt;&gt;() cons...","link":"","photos":[],"count_time":{"symbolsCount":"3.5k","symbolsTime":"3 mins."},"categories":[{"name":"React","slug":"React","count":20,"path":"api/categories/React.json"}],"tags":[{"name":"React","slug":"React","count":14,"path":"api/tags/React.json"},{"name":"bug","slug":"bug","count":6,"path":"api/tags/bug.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E4%BA%8B\"><span class=\"toc-text\">有意思的事</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B0%83%E8%AF%95\"><span class=\"toc-text\">调试</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%89%93%E4%B8%8A%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">打上日志</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81%E4%B8%8B%E7%8C%9C%E6%83%B3\"><span class=\"toc-text\">修改代码验证下猜想</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%80%E7%BB%88%E4%BF%AE%E6%94%B9\"><span class=\"toc-text\">最终修改</span></a></li></ol></li></ol>","author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"设计模式","uid":"deffdaaa2a24a19ee257667b3b36743c","slug":"2022-05-13design_mode","date":"2022-05-13T09:01:15.000Z","updated":"2022-09-20T12:23:35.405Z","comments":true,"path":"api/articles/2022-05-13design_mode.json","keywords":null,"cover":null,"text":"先聊用到过哪些，背后的设计模式是什么 实例化一个 axios 实例，全局都来使用它 单例模式 兄弟组件通信,事件监听 观察者模式 构造函数继承、类的继承 构造函数模式 实例化不同的实例 工厂模式 优化中的事件代理代理模式 esm、commonjs模块模式 熟悉而又陌生：熟悉的是一...","link":"","photos":[],"count_time":{"symbolsCount":"2k","symbolsTime":"2 mins."},"categories":[{"name":"前端","slug":"前端","count":1,"path":"api/categories/前端.json"}],"tags":[{"name":"设计模式","slug":"设计模式","count":1,"path":"api/tags/设计模式.json"},{"name":"前端","slug":"前端","count":1,"path":"api/tags/前端.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"ModHeader","uid":"f31094f49d8642b9a610a9630bcdbff8","slug":"2022-05-13modeheader","date":"2022-05-13T06:59:19.000Z","updated":"2022-09-16T13:54:56.109Z","comments":true,"path":"api/articles/2022-05-13modeheader.json","keywords":null,"cover":[],"text":"通过不同请求头字段标识请求不同的环境 Requesr HeadersAccept: *&#x2F;* Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8,zh-...","link":"","photos":[],"count_time":{"symbolsCount":685,"symbolsTime":"1 mins."},"categories":[{"name":"工具","slug":"工具","count":15,"path":"api/categories/工具.json"}],"tags":[{"name":"工具","slug":"工具","count":7,"path":"api/tags/工具.json"},{"name":"Chrome","slug":"Chrome","count":1,"path":"api/tags/Chrome.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}