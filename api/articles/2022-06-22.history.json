{"title":"react-router v0.6.4 依赖 history 5.0.0-beta.5源码","uid":"a154738b9ff4f1409237a2b3abef8f87","slug":"2022-06-22.history","date":"2022-06-22T10:40:45.000Z","updated":"2022-09-16T15:00:17.131Z","comments":true,"path":"api/articles/2022-06-22.history.json","keywords":null,"cover":null,"content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>Documentation for version 5 can be found in the docs directory. This is the current stable release. Version 5 is used in React Router version 6.<br><em>history 5 对应 React Router 6</em></p>\n<p>Documentation for version 4 can be found on the v4 branch. Version 4 is used in React Router versions 4 and 5.<br><em>history 4 对应 React Router 4 和 5</em></p>\n<p>The history library provides history tracking and navigation primitives for JavaScript applications that run in browsers and other stateful environments.<br><em>历史库为在浏览器和其他有状态环境中运行的 JavaScript 应用程序提供历史跟踪和导航。</em><br>If you haven’t yet, please take a second to read through the Installation guide to get the library installed and running on your system.<br><em>如果尚未安装，请花几秒钟阅读安装指南，以便在系统上安装并运行库。</em></p>\n<p>We provide 3 different methods for working with history, depending on your environment:<br><em>根据您的环境，我们提供了 3 种不同的历史处理方法：</em></p>\n<ul>\n<li><p>A “browser history” is for use in modern web browsers that support the HTML5 history API (see cross-browser compatibility)<br><em>“浏览器历史记录”用于支持 HTML5 历史记录 API 的现代 web 浏览器（请参阅跨浏览器兼容性）</em></p>\n</li>\n<li><p>A “hash history” is for use in web browsers where you want to store the location in the hash portion of the current URL to avoid sending it to the server when the page reloads<br><em>“哈希历史记录”用于 web 浏览器中，您希望将位置存储在当前 URL 的哈希部分中，以避免在页面重新加载时将其发送到服务器</em></p>\n</li>\n<li><p>A “memory history” is used as a reference implementation that may be used in non-browser environments, like React Native or tests<br><em>“内存历史记录”用作参考实现，可在非浏览器环境中使用，如 React Native 或 tests</em></p>\n</li>\n</ul>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>常用的是 “browser history” ，使用 “hash history”，会有用户反馈怎么有#号，要你去除，除此之外，有时候需要用到<code>hash</code>滚动到页面具体某个位置，所以为了<code>hash</code>只做定位，通常用 browser history，进行导航</p>\n<p>以 github 为例：</p>\n<p><code>https://github.com/841660202/history/blob/dev/docs/getting-started.md#basic-usage</code></p>\n<p>“memory history” 这个基本上没见到过有用的，<code>react-native</code>使用<code>react-navigation</code>进行导航,<code>react-navigation</code>的<code>package.json</code>种未见到<code>history</code>依赖</p>\n</div>\n<p>The main bundle exports one method for each environment: createBrowserHistory for browsers, createHashHistory for using hash history in browsers, and createMemoryHistory for creating an in-memory history.</p>\n<p><em>主捆绑包为每个环境导出一个方法：createBrowserHistory 用于浏览器，CreateBhashHistory 用于在浏览器中使用哈希历史，createMemoryHistory 用于创建内存中的历史。</em></p>\n<p>In addition to the main bundle, the library also includes history&#x2F;browser and history&#x2F;hash bundles that export singletons you can use to quickly get a history instance for the current document (web page).<br><em>除了主捆绑包之外，该库还包括 history&#x2F;browser 和 history&#x2F;hash 包，这些捆绑包导出可以用于快速获取当前文档（网页）的历史实例的单例。</em></p>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><p><a href=\"https://github.com/841660202/history/blob/dev/docs/getting-started.md#basic-usage\" target=\"_blank\" >见</a></p>\n<h2 id=\"api-参考\"><a href=\"#api-参考\" class=\"headerlink\" title=\"api 参考\"></a>api 参考</h2><p><a href=\"https://github.com/841660202/history/blob/dev/docs/api-reference.md\" target=\"_blank\" >见</a></p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><h2 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h2><ol>\n<li><code>package.json</code>种 workspaces 格式错误，无法 <code>yarn</code></li>\n</ol>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#x2F;&#x2F; 改前\n&quot;workspaces&quot;: &#123;\n    &quot;packages&quot;: [\n      &quot;packages&#x2F;history&quot;\n    ]\n  &#125;\n&#x2F;&#x2F; 改后\n&quot;workspaces&quot;: [\n  &quot;packages&#x2F;*&quot;\n]</code></pre>\n\n<ol start=\"2\">\n<li>在<code>yarn test</code>前，需要<code>yarn build</code>,执行打包输出，因为 test 会引用 build 的产物</li>\n</ol>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#123;\n  &quot;private&quot;: true,\n  &quot;scripts&quot;: &#123;\n    &quot;build&quot;: &quot;node .&#x2F;scripts&#x2F;build.js&quot;,\n    &quot;size&quot;: &quot;filesize&quot;,\n    &quot;clean&quot;: &quot;git clean -fdX .&quot;,\n    &quot;lint&quot;: &quot;eslint .&quot;,\n    &quot;prepublishOnly&quot;: &quot;yarn build&quot;,\n    &quot;test&quot;: &quot;node .&#x2F;scripts&#x2F;test.js&quot;\n  &#125;,\n  &quot;dependencies&quot;: &#123;\n    &quot;@ampproject&#x2F;filesize&quot;: &quot;^2.1.1&quot;,\n    &quot;@ampproject&#x2F;rollup-plugin-closure-compiler&quot;: &quot;0.21.0&quot;,\n    &quot;@babel&#x2F;core&quot;: &quot;^7.1.2&quot;,\n    &quot;@babel&#x2F;plugin-transform-runtime&quot;: &quot;^7.7.6&quot;,\n    &quot;@babel&#x2F;preset-env&quot;: &quot;^7.1.0&quot;,\n    &quot;@babel&#x2F;preset-modules&quot;: &quot;^0.1.1&quot;,\n    &quot;@rollup&#x2F;plugin-replace&quot;: &quot;^2.2.1&quot;,\n    &quot;babel-core&quot;: &quot;^7.0.0-bridge.0&quot;,\n    &quot;babel-eslint&quot;: &quot;^7.0.0&quot;,\n    &quot;babel-loader&quot;: &quot;^8.0.4&quot;,\n    &quot;babel-plugin-dev-expression&quot;: &quot;^0.2.1&quot;,\n    &quot;eslint&quot;: &quot;^3.3.0&quot;,\n    &quot;eslint-plugin-import&quot;: &quot;^2.0.0&quot;,\n    &quot;expect&quot;: &quot;^21.0.0&quot;,\n    &quot;express&quot;: &quot;^4.17.1&quot;,\n    &quot;jest-mock&quot;: &quot;^21.0.0&quot;,\n    &quot;karma&quot;: &quot;^3.1.3&quot;,\n    &quot;karma-browserstack-launcher&quot;: &quot;^1.3.0&quot;,\n    &quot;karma-chrome-launcher&quot;: &quot;^2.2.0&quot;,\n    &quot;karma-firefox-launcher&quot;: &quot;^1.1.0&quot;,\n    &quot;karma-mocha&quot;: &quot;^1.3.0&quot;,\n    &quot;karma-mocha-reporter&quot;: &quot;^2.2.5&quot;,\n    &quot;karma-sourcemap-loader&quot;: &quot;^0.3.7&quot;,\n    &quot;karma-webpack&quot;: &quot;^3.0.5&quot;,\n    &quot;mocha&quot;: &quot;^5.2.0&quot;,\n    &quot;rollup&quot;: &quot;^1.27.9&quot;,\n    &quot;rollup-plugin-babel&quot;: &quot;^4.0.3&quot;,\n    &quot;rollup-plugin-copy&quot;: &quot;^3.1.0&quot;,\n    &quot;rollup-plugin-prettier&quot;: &quot;^0.6.0&quot;,\n    &quot;rollup-plugin-terser&quot;: &quot;^5.1.2&quot;,\n    &quot;webpack&quot;: &quot;^3.12.0&quot;\n  &#125;,\n  &quot;filesize&quot;: &#123;\n    &quot;build&#x2F;history&#x2F;history.production.min.js&quot;: &#123;\n      &quot;none&quot;: &quot;5 kB&quot;\n    &#125;,\n    &quot;build&#x2F;history&#x2F;umd&#x2F;history.production.min.js&quot;: &#123;\n      &quot;none&quot;: &quot;6 kB&quot;\n    &#125;\n  &#125;,\n  &quot;workspaces&quot;: [&quot;packages&#x2F;*&quot;]\n&#125;</code></pre>\n\n<p>查看文件我们可以了解到,该项目依赖种没有<code>history</code>包，由于是<code>yarn</code> workspaces 项目，test 下引入<code>history</code>的都是产物</p>\n<ol start=\"3\">\n<li>测试 <code>yarn test</code>, 浏览器会运行开启，页面历史栈 进栈 出栈 操作，最终浏览器历史会完全出栈。大概是使用了<code>karma-chrome-launcher</code></li>\n</ol>\n<h2 id=\"打包\"><a href=\"#打包\" class=\"headerlink\" title=\"打包\"></a>打包</h2><p>使用 rollup</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">import babel from &quot;rollup-plugin-babel&quot;;\nimport compiler from &quot;@ampproject&#x2F;rollup-plugin-closure-compiler&quot;;\nimport copy from &quot;rollup-plugin-copy&quot;; &#x2F;&#x2F; 有些不需要改变的直接拷贝\nimport prettier from &quot;rollup-plugin-prettier&quot;;\nimport replace from &quot;@rollup&#x2F;plugin-replace&quot;;\nimport &#123; terser &#125; from &quot;rollup-plugin-terser&quot;; &#x2F;&#x2F; deadcode\n\nconst PRETTY &#x3D; !!process.env.PRETTY;\nconsole.log(&quot;PRETTY&quot;, PRETTY); &#x2F;&#x2F; false\nconst SOURCE_DIR &#x3D; &quot;packages&#x2F;history&quot;;\nconst OUTPUT_DIR &#x3D; &quot;build&#x2F;history&quot;;\n&#x2F;&#x2F; 模块化，应该是按需的东西，产出esm格式, 产出 browser、hash\nconst modules &#x3D; [\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;history.js&#96;,\n      format: &quot;esm&quot;,\n      sourcemap: !PRETTY,\n    &#125;,\n    external: [&quot;@babel&#x2F;runtime&#x2F;helpers&#x2F;esm&#x2F;extends&quot;],\n    plugins: [\n      babel(&#123;\n        exclude: &#x2F;node_modules&#x2F;,\n        presets: [[&quot;@babel&#x2F;preset-env&quot;, &#123; loose: true &#125;]],\n        plugins: [\n          &quot;babel-plugin-dev-expression&quot;,\n          [&quot;@babel&#x2F;plugin-transform-runtime&quot;, &#123; useESModules: true &#125;],\n        ],\n        runtimeHelpers: true,\n      &#125;),\n      compiler(),\n      copy(&#123;\n        targets: [\n          &#123; src: &quot;README.md&quot;, dest: OUTPUT_DIR &#125;,\n          &#123; src: &quot;LICENSE&quot;, dest: OUTPUT_DIR &#125;,\n          &#123; src: &#96;$&#123;SOURCE_DIR&#125;&#x2F;package.json&#96;, dest: OUTPUT_DIR &#125;,\n          &#123; src: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.d.ts&#96;, dest: OUTPUT_DIR &#125;,\n          &#123; src: &#96;$&#123;SOURCE_DIR&#125;&#x2F;browser.d.ts&#96;, dest: OUTPUT_DIR &#125;,\n          &#123; src: &#96;$&#123;SOURCE_DIR&#125;&#x2F;hash.d.ts&#96;, dest: OUTPUT_DIR &#125;,\n        ],\n        verbose: true,\n      &#125;),\n    ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n  ...[&quot;browser&quot;, &quot;hash&quot;].map((env) &#x3D;&gt; &#123;\n    return &#123;\n      input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;$&#123;env&#125;.js&#96;,\n      output: &#123;\n        file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;$&#123;env&#125;.js&#96;,\n        format: &quot;esm&quot;,\n        sourcemap: !PRETTY,\n      &#125;,\n      plugins: [\n        babel(&#123;\n          exclude: &#x2F;node_modules&#x2F;,\n          presets: [[&quot;@babel&#x2F;preset-env&quot;, &#123; loose: true &#125;]],\n          plugins: [&quot;babel-plugin-dev-expression&quot;],\n        &#125;),\n        compiler(),\n      ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n    &#125;;\n  &#125;),\n];\n&#x2F;&#x2F; web浏览器esm结构，只处理history\nconst webModules &#x3D; [\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;history.development.js&#96;,\n      format: &quot;esm&quot;,\n      sourcemap: !PRETTY,\n    &#125;,\n    plugins: [\n      babel(&#123;\n        exclude: &#x2F;node_modules&#x2F;,\n        presets: [&quot;@babel&#x2F;preset-modules&quot;],\n        plugins: [&quot;babel-plugin-dev-expression&quot;],\n      &#125;),\n      replace(&#123; &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;development&quot;) &#125;),\n      compiler(),\n    ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;history.production.min.js&#96;,\n      format: &quot;esm&quot;,\n      sourcemap: !PRETTY,\n    &#125;,\n    plugins: [\n      babel(&#123;\n        exclude: &#x2F;node_modules&#x2F;,\n        presets: [&quot;@babel&#x2F;preset-modules&quot;],\n        plugins: [&quot;babel-plugin-dev-expression&quot;],\n      &#125;),\n      replace(&#123; &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;production&quot;) &#125;),\n      compiler(),\n      terser(&#123; ecma: 8, safari10: true &#125;),\n    ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n];\n&#x2F;&#x2F; 浏览器、服务端 umd格式\nconst globals &#x3D; [\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;umd&#x2F;history.development.js&#96;,\n      format: &quot;umd&quot;,\n      sourcemap: !PRETTY,\n      name: &quot;HistoryLibrary&quot;,\n    &#125;,\n    plugins: [\n      babel(&#123;\n        exclude: &#x2F;node_modules&#x2F;,\n        presets: [[&quot;@babel&#x2F;preset-env&quot;, &#123; loose: true &#125;]],\n        plugins: [&quot;babel-plugin-dev-expression&quot;],\n      &#125;),\n      replace(&#123; &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;development&quot;) &#125;),\n      compiler(),\n    ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;history.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;umd&#x2F;history.production.min.js&#96;,\n      format: &quot;umd&quot;,\n      sourcemap: !PRETTY,\n      name: &quot;HistoryLibrary&quot;,\n    &#125;,\n    plugins: [\n      babel(&#123;\n        exclude: &#x2F;node_modules&#x2F;,\n        presets: [[&quot;@babel&#x2F;preset-env&quot;, &#123; loose: true &#125;]],\n        plugins: [&quot;babel-plugin-dev-expression&quot;],\n      &#125;),\n      replace(&#123; &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;production&quot;) &#125;),\n      compiler(),\n      terser(),\n    ].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n];\n&#x2F;&#x2F; 服务端common.js\nconst node &#x3D; [\n  &#123;\n    input: &#96;$&#123;SOURCE_DIR&#125;&#x2F;node-main.js&#96;,\n    output: &#123;\n      file: &#96;$&#123;OUTPUT_DIR&#125;&#x2F;main.js&#96;,\n      format: &quot;cjs&quot;,\n    &#125;,\n    plugins: [compiler()].concat(PRETTY ? prettier(&#123; parser: &quot;babel&quot; &#125;) : []),\n  &#125;,\n];\n\nexport default [...modules, ...webModules, ...globals, ...node];</code></pre>\n\n<h2 id=\"history-js\"><a href=\"#history-js\" class=\"headerlink\" title=\"history.js\"></a>history.js</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; history&#x2F;packages&#x2F;history&#x2F;history.js\n&#x2F;&#x2F; 取中间值\nfunction clamp(n, lowerBound, upperBound) &#123;\n  return Math.min(Math.max(n, lowerBound), upperBound);\n&#125;\n\n&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;\n&#x2F;&#x2F; UTILS\n&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;\n&#x2F;&#x2F; 卸载前提示\nfunction promptBeforeUnload(event) &#123;\n  &#x2F;&#x2F; Cancel the event.\n  event.preventDefault();\n  &#x2F;&#x2F; Chrome (and legacy IE) requires returnValue to be set.\n  event.returnValue &#x3D; &quot;&quot;;\n&#125;\n&#x2F;&#x2F; 创建事件\nfunction createEvents() &#123;\n  let handlers &#x3D; [];\n\n  return &#123;\n    get length() &#123;\n      return handlers.length;\n    &#125;,\n    push(fn) &#123;\n      handlers.push(fn);\n      return function () &#123;\n        handlers &#x3D; handlers.filter((handler) &#x3D;&gt; handler !&#x3D;&#x3D; fn);\n      &#125;;\n    &#125;,\n    call(arg) &#123;\n      handlers.forEach((fn) &#x3D;&gt; fn &amp;&amp; fn(arg));\n    &#125;,\n  &#125;;\n&#125;\n&#x2F;&#x2F; 创建唯一key\nfunction createKey() &#123;\n  return Math.random().toString(36).substr(2, 8);\n&#125;\n&#x2F;&#x2F; 生成path\nexport function createPath(&#123; pathname &#x3D; &quot;&#x2F;&quot;, search &#x3D; &quot;&quot;, hash &#x3D; &quot;&quot; &#125;) &#123;\n  return pathname + search + hash;\n&#125;\n&#x2F;&#x2F; 解析path\nexport function parsePath(path) &#123;\n  &#x2F;&#x2F; &#39;https:&#x2F;&#x2F;fanyi.baidu.com&#x2F;?aldtype&#x3D;16047#ast&#x2F;zh&#x2F;promptBeforeUnload&#39;\n  let pieces &#x3D; &#123;&#125;;\n\n  if (path) &#123;\n    let hashIndex &#x3D; path.indexOf(&quot;#&quot;);\n    if (hashIndex &gt;&#x3D; 0) &#123;\n      pieces.hash &#x3D; path.substr(hashIndex); &#x2F;&#x2F; #ast&#x2F;zh&#x2F;promptBeforeUnload\n      path &#x3D; path.substr(0, hashIndex); &#x2F;&#x2F; https:&#x2F;&#x2F;fanyi.baidu.com&#x2F;?aldtype&#x3D;16047\n    &#125;\n\n    let searchIndex &#x3D; path.indexOf(&quot;?&quot;);\n    if (searchIndex &gt;&#x3D; 0) &#123;\n      pieces.search &#x3D; path.substr(searchIndex); &#x2F;&#x2F; ?aldtype&#x3D;16047\n      path &#x3D; path.substr(0, searchIndex); &#x2F;&#x2F; https:&#x2F;&#x2F;fanyi.baidu.com&#x2F;\n    &#125;\n\n    if (path) &#123;\n      pieces.pathname &#x3D; path;\n    &#125;\n  &#125;\n\n  return pieces;\n&#125;</code></pre>\n\n<h2 id=\"createBrowserHistory\"><a href=\"#createBrowserHistory\" class=\"headerlink\" title=\"createBrowserHistory\"></a>createBrowserHistory</h2><pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">&#x2F;&#x2F; 对象只读\nconst readOnly &#x3D; __DEV__ ? (obj) &#x3D;&gt; Object.freeze(obj) : (obj) &#x3D;&gt; obj;\n\n&#x2F;**\n * Browser history stores the location in regular URLs. This is the\n * standard for most web apps, but it requires some configuration on\n * the server to ensure you serve the same app at multiple URLs.\n * 浏览器历史记录将位置存储在常规URL中。这是\n * 大多数web应用程序的标准配置，但它需要在\n * 确保您在多个URL上为同一应用程序提供服务的服务器。\n *&#x2F;\nexport function createBrowserHistory(&#123; window &#x3D; document.defaultView &#125; &#x3D; &#123;&#125;) &#123;\n  let globalHistory &#x3D; window.history;\n  &#x2F;&#x2F; 获取第几个，和 location 信息\n  function getIndexAndLocation() &#123;\n    let &#123; pathname, search, hash &#125; &#x3D; window.location;\n    let state &#x3D; globalHistory.state || &#123;&#125;;\n    return [\n      state.idx,\n      readOnly(&#123;\n        &#x2F;&#x2F; 对象只读\n        pathname,\n        search,\n        hash,\n        state: state.usr || null,\n        key: state.key || &quot;default&quot;,\n      &#125;),\n    ];\n  &#125;\n\n  let blockedPopTx &#x3D; null;\n  function handlePop() &#123;\n    &#x2F;&#x2F; 出栈\n    if (blockedPopTx) &#123;\n      blockers.call(blockedPopTx);\n      blockedPopTx &#x3D; null;\n    &#125; else &#123;\n      let nextAction &#x3D; PopAction;\n      let [nextIndex, nextLocation] &#x3D; getIndexAndLocation();\n\n      if (blockers.length) &#123;\n        if (nextIndex !&#x3D; null) &#123;\n          let n &#x3D; index - nextIndex;\n          if (n) &#123;\n            &#x2F;&#x2F; Revert the POP 还原POP\n            blockedPopTx &#x3D; &#123;\n              action: nextAction,\n              location: nextLocation,\n              retry() &#123;\n                go(n * -1);\n              &#125;,\n            &#125;;\n\n            go(n);\n          &#125;\n        &#125; else &#123;\n          &#x2F;&#x2F; Trying to POP to a location with no index. We did not create\n          &#x2F;&#x2F; this location, so we can&#39;t effectively block the navigation.\n          &#x2F;&#x2F; 正在尝试弹出到没有索引的位置。我们没有创建此位置，因此无法有效阻止导航。\n          warning(\n            false,\n            &#x2F;&#x2F; TODO: Write up a doc that explains our blocking strategy in\n            &#x2F;&#x2F; detail and link to it here so people can understand better\n            &#x2F;&#x2F; what is going on and how to avoid it.\n            &#96;You are trying to block a POP navigation to a location that was not &#96; +\n              &#96;created by the history library. The block will fail silently in &#96; +\n              &#96;production, but in general you should do all navigation with the &#96; +\n              &#96;history library (instead of using window.history.pushState directly) &#96; +\n              &#96;to avoid this situation.&#96;\n          );\n        &#125;\n      &#125; else &#123;\n        applyTx(nextAction);\n      &#125;\n    &#125;\n  &#125;\n\n  window.addEventListener(PopStateEventType &#x2F;* popstate *&#x2F;, handlePop);\n\n  let action &#x3D; PopAction;\n  let [index, location] &#x3D; getIndexAndLocation();\n  let blockers &#x3D; createEvents();\n  let listeners &#x3D; createEvents();\n\n  if (index &#x3D;&#x3D; null) &#123;\n    index &#x3D; 0;\n    globalHistory.replaceState(&#123; ...globalHistory.state, idx: index &#125;, null);\n  &#125;\n\n  function createHref(to) &#123;\n    return typeof to &#x3D;&#x3D;&#x3D; &quot;string&quot; ? to : createPath(to);\n  &#125;\n\n  function getNextLocation(to, state &#x3D; null) &#123;\n    return readOnly(&#123;\n      ...location,\n      ...(typeof to &#x3D;&#x3D;&#x3D; &quot;string&quot; ? parsePath(to) : to),\n      state,\n      key: createKey(),\n    &#125;);\n  &#125;\n  &#x2F;&#x2F; 获取history state 和 url\n  function getHistoryStateAndUrl(nextLocation, index) &#123;\n    return [\n      &#123;\n        usr: nextLocation.state,\n        key: nextLocation.key,\n        idx: index,\n      &#125;,\n      createHref(nextLocation),\n    ];\n  &#125;\n  &#x2F;&#x2F; 执行观察者\n  function allowTx(action, location, retry) &#123;\n    return (\n      !blockers.length || (blockers.call(&#123; action, location, retry &#125;), false)\n    );\n  &#125;\n  &#x2F;&#x2F; 执行观察者\n  function applyTx(nextAction) &#123;\n    action &#x3D; nextAction;\n    [index, location] &#x3D; getIndexAndLocation();\n    listeners.call(&#123; action, location &#125;);\n  &#125;\n  &#x2F;&#x2F; 进栈\n  function push(to, state) &#123;\n    let nextAction &#x3D; PushAction;\n    let nextLocation &#x3D; getNextLocation(to, state);\n    function retry() &#123;\n      push(to, state);\n    &#125;\n\n    if (allowTx(nextAction, nextLocation, retry)) &#123;\n      let [historyState, url] &#x3D; getHistoryStateAndUrl(nextLocation, index + 1);\n\n      &#x2F;&#x2F; TODO: Support forced reloading\n      &#x2F;&#x2F; try...catch because iOS limits us to 100 pushState calls :&#x2F;\n      try &#123;\n        globalHistory.pushState(historyState, null, url);\n      &#125; catch (error) &#123;\n        &#x2F;&#x2F; They are going to lose state here, but there is no real\n        &#x2F;&#x2F; way to warn them about it since the page will refresh...\n        window.location.assign(url);\n      &#125;\n\n      applyTx(nextAction);\n    &#125;\n  &#125;\n  &#x2F;&#x2F; 替换\n  function replace(to, state) &#123;\n    let nextAction &#x3D; ReplaceAction;\n    let nextLocation &#x3D; getNextLocation(to, state);\n    function retry() &#123;\n      replace(to, state);\n    &#125;\n\n    if (allowTx(nextAction, nextLocation, retry)) &#123;\n      let [historyState, url] &#x3D; getHistoryStateAndUrl(nextLocation, index);\n\n      &#x2F;&#x2F; TODO: Support forced reloading\n      globalHistory.replaceState(historyState, null, url);\n\n      applyTx(nextAction);\n    &#125;\n  &#125;\n\n  function go(n) &#123;\n    globalHistory.go(n);\n  &#125;\n\n  let history &#x3D; &#123;\n    get action() &#123;\n      return action;\n    &#125;,\n    get location() &#123;\n      return location;\n    &#125;,\n    createHref,\n    push,\n    replace,\n    go,\n    back() &#123;\n      go(-1);\n    &#125;,\n    forward() &#123;\n      go(1);\n    &#125;,\n    listen(fn) &#123;\n      &#x2F;&#x2F; react-router使用listen监听变化，并进行匹配渲染\n      return listeners.push(fn);\n    &#125;,\n    block(fn) &#123;\n      let unblock &#x3D; blockers.push(fn);\n\n      if (blockers.length &#x3D;&#x3D;&#x3D; 1) &#123;\n        window.addEventListener(BeforeUnloadEventType, promptBeforeUnload);\n      &#125;\n\n      return function () &#123;\n        unblock();\n        &#x2F;&#x2F;页面undload之前清空监听，避免内存泄漏\n        &#x2F;&#x2F; Remove the beforeunload listener so the document may\n        &#x2F;&#x2F; still be salvageable in the pagehide event.\n        &#x2F;&#x2F; See https:&#x2F;&#x2F;html.spec.whatwg.org&#x2F;#unloading-documents\n        if (!blockers.length) &#123;\n          window.removeEventListener(BeforeUnloadEventType, promptBeforeUnload);\n        &#125;\n      &#125;;\n    &#125;,\n  &#125;;\n  &#x2F;&#x2F; 最终返回一个history对象，有一系列方法\n  return history;\n&#125;</code></pre>\n\n<h2 id=\"createHashHistory\"><a href=\"#createHashHistory\" class=\"headerlink\" title=\"createHashHistory\"></a>createHashHistory</h2><p>先不看了…</p>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><p><a href=\"https://github.com/remix-run/history\" target=\"_blank\" >remix-run&#x2F;history</a></p>\n","text":"介绍Documentation for version 5 can be found in the docs directory. This is the current stable release. Version 5 is used in React Router vers...","link":"","photos":[],"count_time":{"symbolsCount":"22k","symbolsTime":"20 mins."},"categories":[{"name":"React","slug":"React","count":34,"path":"api/categories/React.json"}],"tags":[{"name":"React","slug":"React","count":28,"path":"api/tags/React.json"},{"name":"源码","slug":"源码","count":15,"path":"api/tags/源码.json"},{"name":"react-router","slug":"react-router","count":3,"path":"api/tags/react-router.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">介绍</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">基本使用</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#api-%E5%8F%82%E8%80%83\"><span class=\"toc-text\">api 参考</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BA%90%E7%A0%81\"><span class=\"toc-text\">源码</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%A8%E6%84%8F\"><span class=\"toc-text\">注意</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%89%93%E5%8C%85\"><span class=\"toc-text\">打包</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#history-js\"><span class=\"toc-text\">history.js</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#createBrowserHistory\"><span class=\"toc-text\">createBrowserHistory</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#createHashHistory\"><span class=\"toc-text\">createHashHistory</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"><span class=\"toc-text\">参考链接</span></a></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"眼中有光，心中有梦，脚下有路","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"axios 1.0.0-alpha.1 源码","uid":"5878c07e39be3e6af6ed1f1edce82a5a","slug":"2022-06-23axios","date":"2022-06-23T01:22:54.000Z","updated":"2023-02-20T21:20:56.463Z","comments":true,"path":"api/articles/2022-06-23axios.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/20220623092515.webp","text":"官网官网首页官方文档介绍中文文档 Promise based HTTP client for the browser and node.js基于 promise 可以用于浏览器和 node.js 的网络请求库 Axios is a promise-based HTTP Clien...","link":"","photos":[],"count_time":{"symbolsCount":"33k","symbolsTime":"30 mins."},"categories":[{"name":"Http","slug":"Http","count":1,"path":"api/categories/Http.json"}],"tags":[{"name":"源码","slug":"源码","count":15,"path":"api/tags/源码.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"眼中有光，心中有梦，脚下有路","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"腾讯云COS,docx无法在浏览器预览","uid":"229017905bfbb779fea0f9efffb5a64c","slug":"2022-06-22cos","date":"2022-06-22T01:21:46.000Z","updated":"2023-02-20T21:20:56.462Z","comments":true,"path":"api/articles/2022-06-22cos.json","keywords":null,"cover":[],"text":"背景其他部门项目接入我们部门 wfc 审批流，有附件需要预览，附件种类非常多：图片、office(doc、ppt…)、代码文件（css、html、js…） 图片预览：使用第三方插件&#x2F;自己开发 pdf: 使用第三方插件&#x2F;iframe 具备浏览器预览 pdf 功能...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"对象存储","slug":"对象存储","count":1,"path":"api/categories/对象存储.json"}],"tags":[{"name":"对象存储","slug":"对象存储","count":1,"path":"api/tags/对象存储.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"眼中有光，心中有梦，脚下有路","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}