{"title":"部署后，无法运行","uid":"16c06075633c447ebc480ad4e752e204","slug":"2023-05-18bug","date":"2023-05-18T03:03:01.000Z","updated":"2023-07-08T01:06:25.355Z","comments":true,"path":"api/articles/2023-05-18bug.json","keywords":null,"cover":[],"content":"<h1 id=\"日志\"><a href=\"#日志\" class=\"headerlink\" title=\"日志\"></a>日志</h1><pre class=\"line-numbers language-none\"><code class=\"language-none\">2023-05-18T01:29:15.077Z ERROR next 63acefd419084df6 socrates &#123;&quot;stack&quot;:&quot;ReferenceError: Cannot access &#39;detail&#39; before initialization\\n    at Module.default (&#x2F;code&#x2F;client&#x2F;.next&#x2F;server&#x2F;pages&#x2F;my&#x2F;detail-cf860b1ba4ecad739d21.js:15994:36)\\n    at doRender (&#x2F;code&#x2F;node_modules&#x2F;@ty-fe&#x2F;next&#x2F;dist&#x2F;server&#x2F;render.js:196:27)\\n    at processTicksAndRejections (internal&#x2F;process&#x2F;task_queues.js:95:5)\\n    at async Server.renderToHTML (&#x2F;code&#x2F;node_modules&#x2F;@ty-fe&#x2F;next&#x2F;dist&#x2F;server&#x2F;next-server.js:584:19)\\n    at async Server.render (&#x2F;code&#x2F;node_modules&#x2F;@ty-fe&#x2F;next&#x2F;dist&#x2F;server&#x2F;next-server.js:507:20)\\n    at async Object.fn (&#x2F;code&#x2F;node_modules&#x2F;@ty-fe&#x2F;next&#x2F;dist&#x2F;server&#x2F;next-server.js:427:11)\\n    at async Server.run (&#x2F;code&#x2F;node_modules&#x2F;@ty-fe&#x2F;next&#x2F;dist&#x2F;server&#x2F;next-server.js:471:7)&quot;,&quot;type&quot;:&quot;Error&quot;,&quot;msg&quot;:&quot;Cannot access &#39;detail&#39; before initialization&quot;&#125;</code></pre>\n\n<h1 id=\"本地\"><a href=\"#本地\" class=\"headerlink\" title=\"本地\"></a>本地</h1><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">yarn dev # 运行正常\nyarn build &amp;&amp; yarn start # 运行正常</code></pre>\n\n<h1 id=\"历史打包记录\"><a href=\"#历史打包记录\" class=\"headerlink\" title=\"历史打包记录\"></a>历史打包记录</h1><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">1. 重新部署，运行正常\n2. 重新打包，部署，运行不正常\n# 这里要注意下，nextjs是运行时报的错，不是编译时</code></pre>\n\n<img src=\"http://t-blog-images.aijs.top/img/202305181610320.webp\" />\n\n<p>相同的 commit 节点,</p>\n<ol>\n<li>之前能正常打包、部署的，现在不正常，肯定是环境变动，</li>\n<li>导致组件库的依赖项，会被项目根目录的依赖项覆盖掉，导致找不到新的 API<code>createUpdateEffect</code>,查看源码，只在 ahooks v3 版本中存在</li>\n</ol>\n<h1 id=\"不正常的日志\"><a href=\"#不正常的日志\" class=\"headerlink\" title=\"不正常的日志\"></a>不正常的日志</h1><img src=\"http://t-blog-images.aijs.top/img/202305181613536.webp\" />\n\n<h1 id=\"排查\"><a href=\"#排查\" class=\"headerlink\" title=\"排查\"></a>排查</h1><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 1. 排查依赖\n# 2. 排查yarn.lock\n# 3. 排查package.json\n\n# 全部正常</code></pre>\n\n<h1 id=\"最后只有一种可能\"><a href=\"#最后只有一种可能\" class=\"headerlink\" title=\"最后只有一种可能\"></a>最后只有一种可能</h1><p><strong>导致组件库的依赖项，会被项目根目录的依赖项覆盖掉</strong></p>\n<p>之前是不存在这个问题的，记得之前我聊过将 ahooks v3 版本单独发布到 npm 仓库，不去动 v2 版本的 ahooks(原因是之前代码使用 v2 开发，改起来太多了)</p>\n<p>现在不得不，将 v2 版本的 ahooks 替换为 ahooks-v2 <a href=\"https://ahooks.js.org/zh-CN/guide/upgrade\" target=\"_blank\" >可以参考这个</a></p>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#x2F;&#x2F; 修改前\n&quot;ahooks&quot;: &quot;^2.10.15&quot;,\n&quot;@ty-fe&#x2F;ahooks-v3&quot;: &quot;^3.7.4&quot;,\n\n&#x2F;&#x2F; 修改后\n&quot;ahooks&quot;: &quot;^3.7.7&quot;,\n&quot;ahooks-v2&quot;: &quot;^2.10.15&quot;,</code></pre>\n\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"># 1. 本地运行正常\n# 2. 打包、部署、运行正常\n\n# 至此，问题解决</code></pre>\n\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><ol>\n<li>原可运行的代码，变得不可运行</li>\n<li>因 k8s 进行升级，服务器运行环境被更改，</li>\n<li>ahooks v3 版本丢失<ol>\n<li>组件库使用 ahooks v3 版本，</li>\n<li>项目 ahooks 使用 v2</li>\n<li>在打包环境中丢失，导致无法运行</li>\n</ol>\n</li>\n<li>解决：<ol>\n<li>将项目中的 v2 版本更改为<code>ahooks-v2</code></li>\n<li>在项目中安装 ahooks v3 的版本</li>\n</ol>\n</li>\n</ol>\n<h1 id=\"又一个项目的坑\"><a href=\"#又一个项目的坑\" class=\"headerlink\" title=\"又一个项目的坑\"></a>又一个项目的坑</h1><p>本地打包打包正常，部署时候报错找不到 ahooks，后来将 ahooks 锁版本解决</p>\n<img src=\"http://t-blog-images.aijs.top/img/202307061627334.webp\" />\n\n<h2 id=\"ahooks-锁版本解决\"><a href=\"#ahooks-锁版本解决\" class=\"headerlink\" title=\"ahooks 锁版本解决\"></a>ahooks 锁版本解决</h2><img src=\"http://t-blog-images.aijs.top/img/202307061628594.webp\" />\n","text":"日志2023-05-18T01:29:15.077Z ERROR next 63acefd419084df6 socrates &#123;&quot;stack&quot;:&quot;ReferenceError: Cannot access &#39;detail&#39;...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"next","slug":"next","count":1,"path":"api/categories/next.json"}],"tags":[{"name":"next","slug":"next","count":1,"path":"api/tags/next.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">日志</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%9C%AC%E5%9C%B0\"><span class=\"toc-text\">本地</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8E%86%E5%8F%B2%E6%89%93%E5%8C%85%E8%AE%B0%E5%BD%95\"><span class=\"toc-text\">历史打包记录</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%8D%E6%AD%A3%E5%B8%B8%E7%9A%84%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">不正常的日志</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%8E%92%E6%9F%A5\"><span class=\"toc-text\">排查</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%9C%80%E5%90%8E%E5%8F%AA%E6%9C%89%E4%B8%80%E7%A7%8D%E5%8F%AF%E8%83%BD\"><span class=\"toc-text\">最后只有一种可能</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">测试</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%88%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%9D%91\"><span class=\"toc-text\">又一个项目的坑</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#ahooks-%E9%94%81%E7%89%88%E6%9C%AC%E8%A7%A3%E5%86%B3\"><span class=\"toc-text\">ahooks 锁版本解决</span></a></li></ol></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/202303171118970.webp","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"重拾java","uid":"67e193579c0cb334ed58fb94e7cd04b2","slug":"2023-05-25java","date":"2023-05-25T12:52:54.000Z","updated":"2023-07-08T01:06:25.359Z","comments":true,"path":"api/articles/2023-05-25java.json","keywords":null,"cover":[],"text":"文章结构跟着兴趣走而不是顺序 输入校验validating-form-input 如何校验 如何处理检验不通过的信息 “Validating Form” 是指对表单数据进行验证以确保其符合特定规则或要求的过程。在 Web 应用程序中，表单通常用于收集用户输入的数据，例如注册表格、...","link":"","photos":[],"count_time":{"symbolsCount":"118k","symbolsTime":"1:48"},"categories":[{"name":"java","slug":"java","count":1,"path":"api/categories/java.json"}],"tags":[{"name":"java","slug":"java","count":1,"path":"api/tags/java.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/202303171118970.webp","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"Pinia","uid":"6a13b89bc1d9db16e3bd75ad19728f7b","slug":"2023-05-17pinia","date":"2023-05-17T13:08:07.000Z","updated":"2023-07-08T01:06:25.354Z","comments":true,"path":"api/articles/2023-05-17pinia.json","keywords":null,"cover":null,"text":"piniaPinia 是一个为 Vue 3 开发的状态管理库，它提供了一种简单、直观的方式来管理 Vue 3 应用程序的状态。与 Vue 2 的 Vuex 不同，Pinia 不依赖于任何全局状态，而是将所有状态都存储在本地的 Store 实例中，这使得 Pinia 更加模块化和灵...","link":"","photos":[],"count_time":{"symbolsCount":"15k","symbolsTime":"13 mins."},"categories":[{"name":"vue3","slug":"vue3","count":1,"path":"api/categories/vue3.json"}],"tags":[{"name":"vue3","slug":"vue3","count":1,"path":"api/tags/vue3.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/202303171118970.webp","link":"/","description":"<div><p>眼中有光，心中有梦，脚下有路</p><div>","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}