{"title":"react-native-webview中处理外网链接","uid":"da1169afdf41f1a24b458b57385fca2d","slug":"2022-06-29rn-web","date":"2022-06-29T09:11:44.000Z","updated":"2022-09-16T13:54:56.155Z","comments":true,"path":"api/articles/2022-06-29rn-web.json","keywords":null,"cover":[],"content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>之前公司移动端是使用 vpn 连接到内网，由于某些原因，IOS 企业证书即将到期，应用需要上架，vpn 不满足上架要求，所以：</p>\n<ul>\n<li>vpn 要从 iOS 包中移除</li>\n<li>vpn 移除导致不能直接访问内网</li>\n<li>需要通过外网域名访问内网资源</li>\n</ul>\n<p>不同环境的请求</p>\n<ul>\n<li>原生及 RN 代码，接口访问走 ATOP 接口访问</li>\n<li>内网应用嵌入到 react-native-webview 中，使用 cookie 注入的方式进行授权，</li>\n</ul>\n<p>已有的域名：</p>\n<ul>\n<li>之前已经做了企业微信工作台功能，考虑到申请外网域名需要走安全、合规审核比较麻烦</li>\n<li>我们的企业微信授权是根据请求头区分的，同时应用中也有是否是微信环境的判断, 所以：只要在项目中避开微信授权，走 SSO 授权（cookie 注入）</li>\n</ul>\n<img src=\"http://t-blog-images.aijs.top/img/20220629172711.webp\" />\n\n<p><em>顺便说句：这里的判断是采用(nextjs)服务端渲染，所以能直接在请求头中判断，如果不是服务端渲染，可能要考虑其他 rn 注入的方式</em></p>\n<h2 id=\"改造\"><a href=\"#改造\" class=\"headerlink\" title=\"改造\"></a>改造</h2><p><strong>RN 改造</strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220629173240.webp\" />\n\n<p><strong>h5 项目改造</strong></p>\n<!-- <img src=\"http://t-blog-images.aijs.top/img/20220629173017.webp\" /> -->\n<img src=\"http://t-blog-images.aijs.top/img/20220629180554.webp\" />\n\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">const lang &#x3D; cookie.parse(req.headers.cookie || &#39;&#39;).gTyPlatLang || &#39;en&#39;\nconst ua &#x3D; parser(req.headers[&#39;user-agent&#39;])\nCommonModel.actions.setDevice(ua.device.type, req)\n\nif (!getWechatUserAgent(req.headers[&#39;user-agent&#39;]) &amp;&amp; req.headers[&#39;x-public&#39;]) &#123;\n  const isMobile &#x3D; ua.device.type &#x3D;&#x3D;&#x3D; &#39;mobile&#39;\n  if(!(isMobile &amp;&amp; !!req.headers.tyxz))&#123;  &#x2F;&#x2F; 移动端不是企业微信的\n    redirect(Config.tyHost + join(&#39;&#x2F;&#39;, req.url), ctx) &#x2F;&#x2F; 移动端是rnxz的重定向到内网\n  &#125;\n&#125;\n</code></pre>\n\n<img src=\"http://t-blog-images.aijs.top/img/20220630093816.webp\" />\n\n\n<p>本篇文章针对的是非企业微信授权的情况，即：图第一行从左到右（有cookie信息的情况）</p>\n<h2 id=\"总结下\"><a href=\"#总结下\" class=\"headerlink\" title=\"总结下\"></a>总结下</h2><p><strong>按照原有的设计缺陷：</strong></p>\n<ul>\n<li>域名是给企业微信用的，是在nginx那边配置的请求头，这本身不够灵活</li>\n<li>代码中逻辑：<br>1.先获取用户信息，获取不到，<br>2.检测状态码（<code>fetch</code>工具对于后台返回的<code>401状态码</code>，如果是<code>401</code>，默认是走微信授权，后台业务校验授权信息不通过的），<br>3.对于不满足上述条件的，检测客户端是否是企业微信，<br>4.如果不是重定向到内网<br>（还是过于依赖域名配置）</li>\n</ul>\n<p><strong>重新设计：</strong></p>\n<ul>\n<li>正常业务逻辑，应该先判断是环境，决定走哪套授权验证（这样不会因为一套授权，一个域名了）</li>\n</ul>\n<h2 id=\"vconsole\"><a href=\"#vconsole\" class=\"headerlink\" title=\"vconsole\"></a>vconsole</h2><p>对于 react-native-webview 调试，使用了 <code>vconsole</code>调试，可以简单查看一些控制台信息，包括 cookie 相关的查看、复制、编辑操作</p>\n<div style=\"display:flex;flex-direction:row; flex-wrap:wrap\">\n<img src=\"http://t-blog-images.aijs.top/img/20220629173944.webp\" style=\"margin-right: 6px\" width=300/>\n<img src=\"http://t-blog-images.aijs.top/img/20220629173856.webp\" width=300/>\n</div>\n","text":"背景之前公司移动端是使用 vpn 连接到内网，由于某些原因，IOS 企业证书即将到期，应用需要上架，vpn 不满足上架要求，所以： vpn 要从 iOS 包中移除 vpn 移除导致不能直接访问内网 需要通过外网域名访问内网资源 不同环境的请求 原生及 RN 代码，接口访问走 AT...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"react-native","slug":"react-native","count":2,"path":"api/categories/react-native.json"}],"tags":[{"name":"react-native","slug":"react-native","count":2,"path":"api/tags/react-native.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%83%8C%E6%99%AF\"><span class=\"toc-text\">背景</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%94%B9%E9%80%A0\"><span class=\"toc-text\">改造</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93%E4%B8%8B\"><span class=\"toc-text\">总结下</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#vconsole\"><span class=\"toc-text\">vconsole</span></a></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"react hook 使用 bug","uid":"e5dbf22be09b32f376c35e2a002b6557","slug":"2022-07-01bug","date":"2022-07-01T03:16:39.000Z","updated":"2022-09-16T15:01:35.762Z","comments":true,"path":"api/articles/2022-07-01bug.json","keywords":null,"cover":[],"text":"问题Rendered more hooks than during the previous render. 解决 两种方式解决： 勾子前置 不用这个勾子 总结勾子不能在条件语句中使用 这个要注意并不是一定这种形式 if (条件) &#123; &#x2F;&#x2F; 如果条件...","link":"","photos":[],"count_time":{"symbolsCount":507,"symbolsTime":"1 mins."},"categories":[{"name":"bug","slug":"bug","count":4,"path":"api/categories/bug.json"}],"tags":[{"name":"React","slug":"React","count":21,"path":"api/tags/React.json"},{"name":"bug","slug":"bug","count":6,"path":"api/tags/bug.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"企业微信授权流程","uid":"240950b163de231df264068b4d1b9085","slug":"2022-06-29wx-auth","date":"2022-06-29T08:27:52.000Z","updated":"2022-09-16T13:54:56.204Z","comments":true,"path":"api/articles/2022-06-29wx-auth.json","keywords":null,"cover":[],"text":"准备工作 确保本地已经正确配置了 HOST，能够从工作台入口打开本地的开发服务 确保已获取到当前企业的唯一 ID：corp_id，在【管理后台】- 【我的企业】-【企业信息】页面，最下面找到【企业 ID】 已经通过接口调用获取到当前应用的 access_token，请参考 二：如...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/categories/企业微信.json"}],"tags":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/tags/企业微信.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}