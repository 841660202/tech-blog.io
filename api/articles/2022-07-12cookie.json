{"title":"cookie注入问题","uid":"4d4a2baebc5a8e28d7b1ee35ff588bdb","slug":"2022-07-12cookie","date":"2022-07-12T07:37:09.000Z","updated":"2022-09-16T13:54:56.211Z","comments":true,"path":"api/articles/2022-07-12cookie.json","keywords":null,"cover":[],"content":"<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>注入的 cookie 怎么没有啦，在<code>vconsole</code>中调试查看，<code>storage</code>有<code>cookie</code>信息,接口调用，发现没有 cookie 被<code>SSO</code>校验拦截住了</p>\n<h2 id=\"抓包结果\"><a href=\"#抓包结果\" class=\"headerlink\" title=\"抓包结果\"></a>抓包结果</h2><p><strong>服务端渲染，中间有代理转发，nextjs 服务端自适应</strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712110204.webp\" />\n\n<p><strong>接口请求</strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712110334.webp\" />\n\n<h2 id=\"问题分析\"><a href=\"#问题分析\" class=\"headerlink\" title=\"问题分析\"></a>问题分析</h2><p>通过 chrome,手动注入调试发现正常。手动注入一般情况是默认<code>/</code>,字段不是很多，cookie 注入有问题，问题大概出现在 path</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712154936.webp\" />\n\n<img src=\"http://t-blog-images.aijs.top/img/20220712154647.webp\" />\n\n<p>直接搜了下<code>cookie path</code>就把问题解决了</p>\n<h2 id=\"修改前代码\"><a href=\"#修改前代码\" class=\"headerlink\" title=\"修改前代码\"></a>修改前代码</h2><pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">(function () &#123;\n  document.cookie &#x3D; &quot;SSO_USER_TOKEN&#x3D;值;&quot;;\n&#125;)();</code></pre>\n\n<h2 id=\"调试\"><a href=\"#调试\" class=\"headerlink\" title=\"调试\"></a>调试</h2><p><strong><code>默认path</code></strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712104539.webp\" />\n\n<p><strong><code>path=/</code></strong></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712104801.webp\" />\n\n<h2 id=\"cookie-的-path-值的默认规则\"><a href=\"#cookie-的-path-值的默认规则\" class=\"headerlink\" title=\"cookie 的 path 值的默认规则\"></a>cookie 的 path 值的默认规则</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><a href=\"https://www.jianshu.com/p/48556e5c44f5\" target=\"_blank\" >cookie 的 path 值的默认规则</a><br>当 cookie 的 path 设置了值不为 null 的时候，以设置的值为准。(<strong>满足当前场景需要</strong>)<br>当 cookie 的 path 为 null 时候，获取请求的 URI 的 path 值<br>1). 当 URI 的 path 值是以“&#x2F;”结尾的时候，直接设置为 cookie 的 path 值<br>2). 当 URI 的 path 值不是以“&#x2F;”结尾的时候，查看 path 里面是否有“&#x2F;”<br>2.1). 如果有“&#x2F;”的话，直接截取到最后一个“&#x2F;”，然后设置为 cookie 的 path 值。<br>2.2). 如果没有“&#x2F;”的话，将 cookie 的 path 设置为”&#x2F;”。</p></blockquote>\n<p><strong>对于 1).测试结果如下：</strong>并不满足本次业务需要</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220712162419.webp\" />\n\n<h2 id=\"修改后代码\"><a href=\"#修改后代码\" class=\"headerlink\" title=\"修改后代码\"></a>修改后代码</h2><p>将 cookie 注入到<code>/</code>,代码<code>path=/;</code></p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">(function () &#123;\n  document.cookie &#x3D; &quot;SSO_USER_TOKEN&#x3D;值;path&#x3D;&#x2F;;&quot;;\n&#125;)();</code></pre>\n\n<h2 id=\"各字段含义\"><a href=\"#各字段含义\" class=\"headerlink\" title=\"各字段含义\"></a>各字段含义</h2><p><a href=\"https://baike.baidu.com/item/cookie/1119\" target=\"_blank\" >百度百科</a></p>\n<p>Cookie 是一段不超过 4KB 的小型文本数据，由一个名称（Name）、一个值（Value）和其它几个用于控制 Cookie 有效期、安全性、使用范围的可选属性组成。其中 ：</p>\n<ul>\n<li>(1)<strong>Name&#x2F;Value</strong>：设置 Cookie 的名称及相对应的值，对于认证 Cookie，Value 值包括 Web 服务器所提供的访问令牌 。</li>\n<li>(2)<strong>Expires 属性</strong>：设置 Cookie 的生存期。有两种存储类型的 Cookie：<strong>会话性</strong>与<strong>持久性</strong>。<ul>\n<li><em>Expires 属性缺省时，为会话性 Cookie，仅保存在客户端内存中，并在用户关闭浏览器时失效;</em></li>\n<li><em>持久性 Cookie 会保存在用户的硬盘中，直至生存期到或用户直接在网页中单击“注销”等按钮结束会话时才会失效。</em></li>\n</ul>\n</li>\n<li>(3)<strong>Path 属性</strong>：定义了 Web 站点上可以访问该 Cookie 的目录 。</li>\n<li>(4)<strong>Domain 属性</strong>：指定了可以访问该 Cookie 的 Web 站点或域。<strong>Cookie 机制并未遵循严格的同源策略，允许一个子域可以设置或获取其父域的 Cookie</strong>。当需要实现单点登录方案时，Cookie 的上述特性非常有用，然而也增加了 Cookie 受攻击的危险，比如攻击者可以借此发动会话定置攻击。因而，浏览器禁止在 Domain 属性中设置.org、.com 等通用顶级域名、以及在国家及地区顶级域下注册的二级域名，以减小攻击发生的范围 。</li>\n<li>(5)<strong>Secure 属性</strong>：指定是否使用 HTTPS 安全协议发送 Cookie。使用 HTTPS 安全协议，可以保护 Cookie 在浏览器和 Web 服务器间的传输过程中不被窃取和篡改。该方法也可用于 Web 站点的身份鉴别，即在 HTTPS 的连接建立阶段，浏览器会检查 Web 网站的 SSL 证书的有效性。但是基于兼容性的原因（比如有些网站使用自签署的证书）在检测到 SSL 证书无效时，浏览器并不会立即终止用户的连接请求，而是显示安全风险信息，用户仍可以选择继续访问该站点。由于许多用户缺乏安全意识，因而仍可能连接到 Pharming 攻击所伪造的网站 。</li>\n<li>(6)<strong>HTTPOnly 属性</strong> ：用于防止客户端脚本通过 document.cookie 属性访问 Cookie，有助于保护 Cookie 不被跨站脚本攻击窃取或篡改。但是，HTTPOnly 的应用仍存在局限性，一些浏览器可以阻止客户端脚本对 Cookie 的读操作，但允许写操作；此外大多数浏览器仍允许通过 XMLHTTP 对象读取 HTTP 响应中的 Set-Cookie 头 。</li>\n</ul>\n<h2 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h2><p><a href=\"https://www.jianshu.com/p/48556e5c44f5\" target=\"_blank\" >cookie 的 path 值的默认规则</a></p>\n<p><a href=\"https://baike.baidu.com/item/cookie/1119\" target=\"_blank\" >百度百科</a></p>\n","text":"问题注入的 cookie 怎么没有啦，在vconsole中调试查看，storage有cookie信息,接口调用，发现没有 cookie 被SSO校验拦截住了 抓包结果服务端渲染，中间有代理转发，nextjs 服务端自适应 接口请求 问题分析通过 chrome,手动注入调试发现正常...","link":"","photos":[],"count_time":{"symbolsCount":"2k","symbolsTime":"2 mins."},"categories":[{"name":"webview","slug":"webview","count":1,"path":"api/categories/webview.json"}],"tags":[{"name":"webview","slug":"webview","count":1,"path":"api/tags/webview.json"},{"name":"cookie","slug":"cookie","count":1,"path":"api/tags/cookie.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">问题</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C\"><span class=\"toc-text\">抓包结果</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90\"><span class=\"toc-text\">问题分析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9%E5%89%8D%E4%BB%A3%E7%A0%81\"><span class=\"toc-text\">修改前代码</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B0%83%E8%AF%95\"><span class=\"toc-text\">调试</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#cookie-%E7%9A%84-path-%E5%80%BC%E7%9A%84%E9%BB%98%E8%AE%A4%E8%A7%84%E5%88%99\"><span class=\"toc-text\">cookie 的 path 值的默认规则</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9%E5%90%8E%E4%BB%A3%E7%A0%81\"><span class=\"toc-text\">修改后代码</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%90%84%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89\"><span class=\"toc-text\">各字段含义</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\"><span class=\"toc-text\">参考链接</span></a></li></ol>","author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"前端基础-数组","uid":"12cc7106661c51633c97f9b1ac94a946","slug":"2022-07-14js-arr","date":"2022-07-14T07:40:32.000Z","updated":"2022-09-16T13:54:56.212Z","comments":true,"path":"api/articles/2022-07-14js-arr.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/202208022304934.png","text":"思维导图 创建 取值 查找 扁平化 遍历 返回 boolean 返回字符串 增&#x2F;删&#x2F;改&#x2F;拷贝&#x2F;解构 详细内容 查看数组 proto[1, 2, 3]; &#x2F;&#x2F; 将结果展开后，见下图 哎呦 [].__proto__Objec...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"前端基础","slug":"前端基础","count":39,"path":"api/categories/前端基础.json"}],"tags":[{"name":"前端基础","slug":"前端基础","count":41,"path":"api/tags/前端基础.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"企业微信文件预览","uid":"74208bc76768a419347d0ad3e15c33b0","slug":"2022-07-05wxfile","date":"2022-07-05T15:16:30.000Z","updated":"2022-09-16T13:54:56.210Z","comments":true,"path":"api/articles/2022-07-05wxfile.json","keywords":null,"cover":[],"text":"企业微信文件预览试错 1: const fileName &#x3D; &quot;xxxxx.jpeg&quot;; &#x2F;&#x2F; 举个例子 downloadAttachment(downloadUrl).then((res) &#x3D;&gt; &#123; v...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/categories/企业微信.json"}],"tags":[{"name":"企业微信","slug":"企业微信","count":5,"path":"api/tags/企业微信.json"}],"author":{"name":"举手摘月亮","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"生活不止眼前的苟且，还有诗和远方","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}