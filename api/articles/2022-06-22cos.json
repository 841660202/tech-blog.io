{"title":"腾讯云COS,docx无法在浏览器预览","uid":"229017905bfbb779fea0f9efffb5a64c","slug":"2022-06-22cos","date":"2022-06-22T01:21:46.000Z","updated":"2022-09-16T13:54:56.151Z","comments":true,"path":"api/articles/2022-06-22cos.json","keywords":null,"cover":[],"content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>其他部门项目接入我们部门 wfc 审批流，有附件需要预览，附件种类非常多：图片、office(doc、ppt…)、代码文件（css、html、js…）</p>\n<ul>\n<li><p>图片预览：使用第三方插件&#x2F;自己开发</p>\n</li>\n<li><p>pdf: 使用第三方插件&#x2F;iframe 具备浏览器预览 pdf 功能</p>\n</li>\n<li><p>office 预览：<code>office预览地址 + iframe</code></p>\n</li>\n</ul>\n<pre class=\"line-numbers language-typescript\" data-language=\"typescript\"><code class=\"language-typescript\">\nfunction getOfficeUrl(fileUrl: string) &#123;\n  if(!fileUrl) &#123;\n    throw new Error(&quot;fileUrl is required&quot;);\n  &#125;\n  return &#96;https:&#x2F;&#x2F;view.officeapps.live.com&#x2F;op&#x2F;view.aspx?src&#x3D;$&#123;encodeURIComponent(fileUrl))&#125;&#96;;\n&#125;\n\ngetOfficeUrl(&#39;https:&#x2F;&#x2F;hello-1257881288.cos.ap-shanghai.myqcloud.com&#x2F;demo.docx&#39;)\n&#x2F;&#x2F; 结果\n&#x2F;&#x2F; https:&#x2F;&#x2F;view.officeapps.live.com&#x2F;op&#x2F;view.aspx?src&#x3D;https%3A%2F%2Fhello-1257881288.cos.ap-shanghai.myqcloud.com%2Fdemo.docx</code></pre>\n<p>注意：一个月内有效（仅买了一个月）</p>\n<iframe src=\"https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fhello-1257881288.cos.ap-shanghai.myqcloud.com%2Fdemo.docx\" height=300 width='100%'></iframe>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>顺便提句: 使用 <code>https://view.officeapps.live.com/op/view.aspx?src=</code>预览失败后返回的是一个新的url错误地址，这并不意味着是iframe加载错误</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">&lt;iframe src&#x3D;&quot;https:&#x2F;&#x2F;view.officeapps.live.com&#x2F;op&#x2F;view.aspx?src&#x3D;https%3A%2F%2Fhello-1257881288.cos.ap-shanghai.myqcloud.com%2Fdemo.docx&quot; height&#x3D;300 width&#x3D;&#39;100%&#39;&gt;\n  加载失败了，提醒我（这个永远不会走到，除非&#96;https:&#x2F;&#x2F;view.officeapps.live.com&#96;挂了）\n&lt;&#x2F;iframe&gt;</code></pre>\n\n</p>\n</div>\n<h2 id=\"遇到坑\"><a href=\"#遇到坑\" class=\"headerlink\" title=\"遇到坑\"></a>遇到坑</h2><p><strong>通过 fileKey 获取预览地址</strong></p>\n<p style=\"color: red\">汗～,文件存储同学给的解释</p>\n\n<p>在通过 fileKey 获取预览地址时候，由于业务方的 pdf 类型 fileKey 有两种情况：</p>\n<ol>\n<li>fileKey<strong>有.pdf 结尾</strong>：获取到的临时预览地址是<strong>可以预览</strong></li>\n<li>fileKey<strong>无.pdf 结尾</strong>：获取到的临时预览地址是<strong>不可以预览</strong>，仅支持下载</li>\n</ol>\n<p><strong>腾讯云文档</strong></p>\n<ol>\n<li><p><a href=\"https://cloud.tencent.com/document/product/436/13361\" target=\"_blank\" >Content-Disposition</a>: attachment; filename*&#x3D;”abc.txt”， 中有 attachment 即下载</p>\n</li>\n<li><p>每个文件详情<strong>自定义 Headers</strong>部分</p>\n</li>\n</ol>\n<img src=\"http://t-blog-images.aijs.top/img/20220622100858.webp\"/>\n\n<p>文档的意思是：要想浏览器预览：上传文件需满足响应头正确</p>\n<ol>\n<li><p>方式 1: 上传文件带后缀，自动生成响应头</p>\n</li>\n<li><p>方式 1: 上传文件，需要配置文件的 content-type</p>\n</li>\n</ol>\n<p><strong>通过 fileKey 获取预览地址为 office 类型文件</strong></p>\n<p>前面说了，office 预览借助<code>iframe</code>,仅此即可实现，阿里云 OSS，妥妥滴没问题（阿里云我不贴图了，测试文件已被删除）</p>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">WARNING</p>\n<p>阿里云上上传文件，测试后，删除，几分钟内，文件还可以访问，第二天再访问不可访问了</p>\n<p>贴下不可访问的地址：（想着能访问，就不贴了，原因是：这是公司的一个模版文件，敏不敏感，我不晓得，我只是用来测试）</p>\n<p><code>https://view.officeapps.live.com/op/view.aspx?src=http%3A%2F%2Ft-blog-images.aijs.top%2FTYZN-XPPZ-04-006%252B%25E4%25BE%259B%25E5%25BA%2594%25E5%2595%2586%25E4%25BA%25A7%25E5%2593%2581%25E8%25B4%25A8%25E9%2587%258F%25E4%25BF%259D%25E8%25AF%2581%25E5%258D%258F%25E8%25AE%25AE_B1.docx</code></p>\n<p>如果是非常敏感的数据，不建议拿来测试，<strong>因为即使你删除文件，短时间内该文件地址还是可以访问的</strong></p>\n</div>\n<p>对于腾讯 COS，我特地花了 0.85RMB 买了一个月</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220622094259.webp\"/>\n\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">&#x2F;&#x2F; https:&#x2F;&#x2F;hello-1257881288.cos.ap-shanghai.myqcloud.com&#x2F;demo.docx</code></pre>\n\n<img src=\"http://t-blog-images.aijs.top/img/20220622094131.webp\" />\n\n<p>可到了腾讯云可就不一样了，昨天腾讯云，慢的要死，官网打开速度竟然比简书一篇文章还慢</p>\n<p>第二天询问公司附件存储方我们 wfc 项目 office 预览怎么又可以了，之前 6（预发环境）6 个文件 1 个可以预览，（线上环境）6 个都不能预览</p>\n<p>回答：</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220622093847.webp\" width=300/>\n\n<p>汗～， 我说昨天访问怎么那么慢</p>\n<p>复测昨天买的 COS，docx 文件预览,今天确实又可以了</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220622094517.webp\"/>\n\n<p>昨天确实不行，我测了几百遍</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220622094640.webp\"/>\n\n<p>期间怀疑过响应头,<code>网上各种乱七八糟的内容还需要自己辨别</code></p>\n<img src=\"http://t-blog-images.aijs.top/img/20220622094640.webp\"/>\n\n<h2 id=\"续-数据万象解绑\"><a href=\"#续-数据万象解绑\" class=\"headerlink\" title=\"续 数据万象解绑\"></a>续 数据万象解绑</h2><p>我测试一下，继续扣费，关掉</p>\n<img src=\"http://t-blog-images.aijs.top/img/20220701115515.webp\" width=300 />\n\n<img src=\"http://t-blog-images.aijs.top/img/20220701115411.webp\" />\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>有时后真的不是你的方式错误，第三方出的问题，奇葩的一笔，（预发环境）6 个文件 1 个可以预览，（线上环境）6 个都不能预览,备注：<strong>相同的数据</strong>.</p>\n<p>这个问题搞了大半天，下午收到内部系统反馈工单，到晚上近 8 点，问题一直存在。 由于盲目相信腾讯，一直以为是内部系统文件或是项目代码书写问题，排查了那么久测试了那么长时间（每次都要发到预发测试，因为日常公司存储服务不支持 office 预览，两周前已反馈了没给解决）。这么严重的问题，腾讯内部竟然也那么久才解决吗？<br><img src=\"https://img2.baidu.com/it/u=164072396,1121091430&fm=253&fmt=auto&app=138&f=JPEG?w=440&h=492\" width=100/><br>没有黑任何平台的意思，我被腾讯 COS 害苦了～</p>\n","text":"背景其他部门项目接入我们部门 wfc 审批流，有附件需要预览，附件种类非常多：图片、office(doc、ppt…)、代码文件（css、html、js…） 图片预览：使用第三方插件&#x2F;自己开发 pdf: 使用第三方插件&#x2F;iframe 具备浏览器预览 pdf 功能...","link":"","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"对象存储","slug":"对象存储","count":1,"path":"api/categories/对象存储.json"}],"tags":[{"name":"对象存储","slug":"对象存储","count":1,"path":"api/tags/对象存储.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%83%8C%E6%99%AF\"><span class=\"toc-text\">背景</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%81%87%E5%88%B0%E5%9D%91\"><span class=\"toc-text\">遇到坑</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BB%AD-%E6%95%B0%E6%8D%AE%E4%B8%87%E8%B1%A1%E8%A7%A3%E7%BB%91\"><span class=\"toc-text\">续 数据万象解绑</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"react-router v0.6.4 依赖 history 5.0.0-beta.5源码","uid":"a154738b9ff4f1409237a2b3abef8f87","slug":"2022-06-22.history","date":"2022-06-22T10:40:45.000Z","updated":"2022-09-16T15:00:17.131Z","comments":true,"path":"api/articles/2022-06-22.history.json","keywords":null,"cover":null,"text":"介绍Documentation for version 5 can be found in the docs directory. This is the current stable release. Version 5 is used in React Router vers...","link":"","photos":[],"count_time":{"symbolsCount":"22k","symbolsTime":"20 mins."},"categories":[{"name":"React","slug":"React","count":20,"path":"api/categories/React.json"}],"tags":[{"name":"React","slug":"React","count":14,"path":"api/tags/React.json"},{"name":"源码","slug":"源码","count":14,"path":"api/tags/源码.json"},{"name":"react-router","slug":"react-router","count":3,"path":"api/tags/react-router.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"react-router v6.4.0 源码","uid":"72ce6d94dd6a62c447ee1fdb4516d01c","slug":"2022-06-21react-router-code","date":"2022-06-21T01:06:50.000Z","updated":"2022-09-16T15:00:58.103Z","comments":true,"path":"api/articles/2022-06-21react-router-code.json","keywords":null,"cover":[],"text":"背景整了半天上一篇看的竟然是概念，我还以为是原理呢 最近看到了，面试题 react-router 原理，查了下答案，内容不是很多 React Router 原理浅谈前端路由原理，VueRouter 原理和 ReactRouter 原理 React Router 源码解析 之前没看...","link":"","photos":[],"count_time":{"symbolsCount":"59k","symbolsTime":"53 mins."},"categories":[{"name":"React","slug":"React","count":20,"path":"api/categories/React.json"}],"tags":[{"name":"源码","slug":"源码","count":14,"path":"api/tags/源码.json"},{"name":"react-router","slug":"react-router","count":3,"path":"api/tags/react-router.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"比你优秀的人，比你更努力！","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}