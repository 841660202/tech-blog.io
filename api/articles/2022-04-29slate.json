{"title":"Slate wiki-ui评论功能光标乱跳","uid":"f5ccfd5f1ce5f78727a64a19669811c7","slug":"2022-04-29slate","date":"2022-05-10T05:00:00.000Z","updated":"2022-09-16T13:54:56.099Z","comments":true,"path":"api/articles/2022-04-29slate.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/bug.webp","content":"<h2 id=\"bug复现\"><a href=\"#bug复现\" class=\"headerlink\" title=\"bug复现\"></a>bug复现</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">bug复现 (node:29) UnhandledPromiseRejectionWarning: Error: Forbidden at &amp;#x2F;code&amp;#x2F;client&amp;#x2F;.next&amp;#x2F;server&amp;#x2F;pages&amp;#x2F;_app-a05...</code></pre>\n<p><img src=\"https://t-blog-images.aijs.top/img/Kapture%202022-04-29%20at%2015.41.56.gif\"></p>\n<p>在vite react项目上，输入汉字的同时按住删除键，光标会乱跳</p>\n<h3 id=\"排查1\"><a href=\"#排查1\" class=\"headerlink\" title=\"排查1:\"></a>排查1:</h3><p>wiki（esm）组件问题，检查wiki-ui组件库，运行正常</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&quot;react&quot;: &quot;^16.8.0&quot;,\n&quot;react-dom&quot;: &quot;^16.8.0&quot;,</code></pre>\n<h3 id=\"排查2\"><a href=\"#排查2\" class=\"headerlink\" title=\"排查2:\"></a>排查2:</h3><p>vite加载wiki-ui组件时候，因为vite只能处理esm，在vite.config.ts, esbuildOptions自定义插件进行处理<br>wiki-ui，不是很懂，换个角度</p>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">esbuildOptions: &#123;\n  plugins: [\n    &#123;\n      name: &#39;originjs:commonjs&#39;,\n      setup(build) &#123;\n        build.onLoad(\n          &#123;\n            filter: &#x2F;@敏感数据-fe\\&#x2F;wiki-ui\\&#x2F;dist&#x2F;,\n            namespace: &#39;file&#39;,\n          &#125;,\n          async (&#123; path: id &#125;) &#x3D;&gt; &#123;\n            const code &#x3D; readFileSync(id).toString()\n            const result &#x3D; transformRequire(code, id)\n\n            return &#123;\n              contents: result,\n              loader: &#39;js&#39;,\n            &#125;\n          &#125;,\n        ),\n          build.onLoad(\n            &#123;\n              filter: &#x2F;@敏感数据-fe\\&#x2F;wiki-ui\\&#x2F;dist\\&#x2F;components\\&#x2F;iconfont&#x2F;,\n              namespace: &#39;file&#39;,\n            &#125;,\n            async (&#123; path: id &#125;) &#x3D;&gt; &#123;\n              const code &#x3D; readFileSync(id).toString()\n              const result &#x3D; transformRequire(code, id)\n\n              return &#123;\n                contents: result,\n                loader: &#39;js&#39;,\n              &#125;\n            &#125;,\n          )\n      &#125;,\n    &#125;,\n    esbuildPluginMonacoEditorNls(&#123;\n      locale: Languages.zh_hans,\n    &#125;),\n  ],\n&#125;,</code></pre>\n<h3 id=\"排查3\"><a href=\"#排查3\" class=\"headerlink\" title=\"排查3:\"></a>排查3:</h3><p>将wiki-ui组件放到umijs应用中运行</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># 搭建个项目\n# 移动demo组件到新项目\n# 运行，发现有相同的问题</code></pre>\n<h3 id=\"分析：\"><a href=\"#分析：\" class=\"headerlink\" title=\"分析：\"></a>分析：</h3><h4 id=\"1-dom\"><a href=\"#1-dom\" class=\"headerlink\" title=\"1.dom\"></a>1.dom</h4><p>输入过程中点击删除操作，那么在这个过程中，输入的内容是在<code>contenteditable=&quot;true&quot; </code>中运行</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;div data-gramm&#x3D;&quot;false&quot; role&#x3D;&quot;textbox&quot; spellcheck&#x3D;&quot;false&quot; class&#x3D;&quot;slash-slate-core&quot; id&#x3D;&quot;SLASH_SLATE_CORE&quot; data-app-id&#x3D;&quot;5A9BEA&quot; autocorrect&#x3D;&quot;false&quot; autocapitalize&#x3D;&quot;false&quot; data-slate-editor&#x3D;&quot;true&quot; data-slate-node&#x3D;&quot;value&quot; contenteditable&#x3D;&quot;true&quot; style&#x3D;&quot;position: relative; outline: none; white-space: pre-wrap; overflow-wrap: break-word;&quot;&gt;&lt;p data-slate-node&#x3D;&quot;element&quot;&gt;&lt;span data-slate-node&#x3D;&quot;text&quot;&gt;&lt;span data-slate-leaf&#x3D;&quot;true&quot;&gt;&lt;span data-slate-string&#x3D;&quot;true&quot;&gt;12121212哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈h h h h h h h h h h h h hs f s d f&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;</code></pre>\n<h4 id=\"2-合成事件\"><a href=\"#2-合成事件\" class=\"headerlink\" title=\"2.合成事件\"></a>2.合成事件</h4><p>应该会走合成事件，合成事件之后会执行渲染，web端走的是react-dom，比对正常运行的项目，和新项目的版本</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># react 17版本\n# react-dom 17版本</code></pre>\n<h4 id=\"3-react\"><a href=\"#3-react\" class=\"headerlink\" title=\"3.react\"></a>3.react</h4><p>先进行<code>react</code>降版本 <code>16.14.0</code>，检查合成事件是否有问题，降版本后，运行，问题同样存在，大概可以断定是<code>react-dom</code>渲染出了问题，</p>\n<h4 id=\"4-react-dom\"><a href=\"#4-react-dom\" class=\"headerlink\" title=\"4.react-dom\"></a>4.react-dom</h4><p>对<code>react-dom</code>降低版本到<code>16.14.0</code>, 后运行正常，那么问题应该在<code>react-dom</code>上</p>\n<h4 id=\"5-github版本-16-14-0\"><a href=\"#5-github版本-16-14-0\" class=\"headerlink\" title=\"5.github版本 16.14.0\"></a>5.github版本 16.14.0</h4><p>两个版本有什么不同：查看<code>react</code>发布日志，16.14.0之后的一个版本是<a href=\"https://github.com/facebook/react/releases#:~:text=17.0.0%20(October%2020%2C%202020)\">17.0.0 (October 20, 2020)</a> 看上去与事件和渲染相关的东西不多</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Use browser focusin and focusout for onFocus and onBlur. (@trueadm in #19186)\nMake all Capture events use the browser capture phase. (@trueadm in #19221)\nThrow if forwardRef or memo component returns undefined. (@gaearon in #19550)\nRemove event pooling. (@trueadm in #18969)\nFix onBeforeInput reporting an incorrect event.type. (@eps1lon in #19561)\nFix event.relatedTarget reported as undefined in Firefox. (@claytercek in #19607)\nFix rendering into a shadow root. (@Jack-Works in #15894)\nFix movementX&#x2F;Y polyfill with capture events. (@gaearon in #19672)\nArtifacts\nreact: https:&#x2F;&#x2F;unpkg.com&#x2F;react@17.0.1&#x2F;umd&#x2F;\nreact-art: https:&#x2F;&#x2F;unpkg.com&#x2F;react-art@17.0.1&#x2F;umd&#x2F;\nreact-dom: https:&#x2F;&#x2F;unpkg.com&#x2F;react-dom@17.0.1&#x2F;umd&#x2F;\nreact-is: https:&#x2F;&#x2F;unpkg.com&#x2F;react-is@17.0.1&#x2F;umd&#x2F;\nreact-test-renderer: https:&#x2F;&#x2F;unpkg.com&#x2F;react-test-renderer@17.0.1&#x2F;umd&#x2F;\nscheduler: https:&#x2F;&#x2F;unpkg.com&#x2F;scheduler@0.20.1&#x2F;umd&#x2F;</code></pre>\n<h4 id=\"6-github版本-18-1-0\"><a href=\"#6-github版本-18-1-0\" class=\"headerlink\" title=\"6.github版本 18.1.0\"></a>6.github版本 18.1.0</h4><p>在往后找最新的版本，发现在<a href=\"https://github.com/facebook/react/releases#:~:text=Compare-,18.1.0%20(April%2026%2C%202022),-Latest\">18.1.0 (April 26, 2022)</a>，改了一堆<code>react-dom</code>的bug,看上去也没相关的</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Fix the false positive warning about react-dom&#x2F;client when using UMD bundle. (@alireza-molaee in #24274)\nFix suppressHydrationWarning to work in production too. (@gaearon in #24271)\nFix componentWillUnmount firing twice inside of Suspense. (@acdlite in #24308)\nFix some transition updates being ignored. (@acdlite in #24353)\nFix useDeferredValue causing an infinite loop when passed an unmemoized value. (@acdlite in #24247)\nFix throttling of revealing Suspense fallbacks. (@sunderls in #24253)\nFix an inconsistency in whether the props object is the same between renders. (@Andarist and @acdlite in #24421)\nFix a missing warning about a setState loop in useEffect. (@gaearon in #24298)\nFix a spurious hydration error. (@gnoff in #24404)\nWarn when calling setState in useInsertionEffect. (@gaearon in #24295)\nEnsure the reason for hydration errors is always displayed. (@gaearon in #24276)</code></pre>\n\n<h3 id=\"可用版本\"><a href=\"#可用版本\" class=\"headerlink\" title=\"可用版本\"></a>可用版本</h3><pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&quot;react&quot;: &quot;^16.14.0&quot;,\n&quot;react-dom&quot;: &quot;16.14.0&quot;,\n</code></pre>\n\n<h3 id=\"这个演示代码正常\"><a href=\"#这个演示代码正常\" class=\"headerlink\" title=\"这个演示代码正常\"></a>这个演示代码正常</h3><pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;embed type&#x3D;&quot;text&#x2F;html&quot; src&#x3D;&quot;https:&#x2F;&#x2F;stackblitz.com&#x2F;edit&#x2F;react-ts-m3y5yv?embed&#x3D;1&amp;file&#x3D;App.tsx&amp;view&#x3D;preview&quot; width&#x3D;&quot;100%&quot; height&#x3D;&quot;200&quot;&gt;\n&lt;!--加载太慢，复制地址查看吧--&gt; \n&lt;!--https:&#x2F;&#x2F;stackblitz.com&#x2F;edit&#x2F;react-ts-m3y5yv?embed&#x3D;1&amp;file&#x3D;App.tsx&amp;view&#x3D;preview--&gt; </code></pre>\n\n<h2 id=\"懵逼。。。\"><a href=\"#懵逼。。。\" class=\"headerlink\" title=\"懵逼。。。\"></a>懵逼。。。</h2><p>从头开始</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">待办事项中的评论功能（组件问题）光标乱跳的问题；\n0. 项目 + wiki-ui 异常\n1. 单运行wiki-ui demo 正常\n2. 运行slate + umijs 正常\n3. 运行wiki-ui  + umijs 异常\n4. slate 与  wiki-ui  不一样在于slate版本\n5. wiki-ui 做了什么事情： 定制化一些节点展示，光标的渲染和wiki-ui无关</code></pre>\n<h2 id=\"贫僧先去slate官网化缘，回来再战\"><a href=\"#贫僧先去slate官网化缘，回来再战\" class=\"headerlink\" title=\"贫僧先去slate官网化缘，回来再战\"></a>贫僧先去slate官网<code>化缘</code>，回来再战</h2><p><a href=\"http://localhost:4000/post/2022-04-29slate-lean\">slate-lean</a></p>\n<h2 id=\"化缘归来\"><a href=\"#化缘归来\" class=\"headerlink\" title=\"化缘归来\"></a>化缘归来</h2><p>问题怎么解决</p>\n","text":"bug复现bug复现 (node:29) UnhandledPromiseRejectionWarning: Error: Forbidden at &amp;#x2F;code&amp;#x2F;client&amp;#x2F;.next&amp;#x2F;server&amp...","link":"","photos":[],"count_time":{"symbolsCount":"5.8k","symbolsTime":"5 mins."},"categories":[{"name":"wiki","slug":"wiki","count":3,"path":"api/categories/wiki.json"}],"tags":[{"name":"wiki","slug":"wiki","count":4,"path":"api/tags/wiki.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#bug%E5%A4%8D%E7%8E%B0\"><span class=\"toc-text\">bug复现</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8E%92%E6%9F%A51\"><span class=\"toc-text\">排查1:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8E%92%E6%9F%A52\"><span class=\"toc-text\">排查2:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8E%92%E6%9F%A53\"><span class=\"toc-text\">排查3:</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90%EF%BC%9A\"><span class=\"toc-text\">分析：</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#1-dom\"><span class=\"toc-text\">1.dom</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#2-%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">2.合成事件</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-react\"><span class=\"toc-text\">3.react</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#4-react-dom\"><span class=\"toc-text\">4.react-dom</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5-github%E7%89%88%E6%9C%AC-16-14-0\"><span class=\"toc-text\">5.github版本 16.14.0</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#6-github%E7%89%88%E6%9C%AC-18-1-0\"><span class=\"toc-text\">6.github版本 18.1.0</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8F%AF%E7%94%A8%E7%89%88%E6%9C%AC\"><span class=\"toc-text\">可用版本</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%99%E4%B8%AA%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81%E6%AD%A3%E5%B8%B8\"><span class=\"toc-text\">这个演示代码正常</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%87%B5%E9%80%BC%E3%80%82%E3%80%82%E3%80%82\"><span class=\"toc-text\">懵逼。。。</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B4%AB%E5%83%A7%E5%85%88%E5%8E%BBslate%E5%AE%98%E7%BD%91%E5%8C%96%E7%BC%98%EF%BC%8C%E5%9B%9E%E6%9D%A5%E5%86%8D%E6%88%98\"><span class=\"toc-text\">贫僧先去slate官网化缘，回来再战</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8C%96%E7%BC%98%E5%BD%92%E6%9D%A5\"><span class=\"toc-text\">化缘归来</span></a></li></ol>","author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"丷为中华之崛起而学习丷","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"前端基础-HTTP3","uid":"93abbea43ed2a379b0063e5e30a44a58","slug":"2022-05-11http","date":"2022-05-11T01:26:00.000Z","updated":"2022-09-16T13:54:56.105Z","comments":true,"path":"api/articles/2022-05-11http.json","keywords":null,"cover":[],"text":"现状 HTTP/3 的基础即谷歌多年探索的基于 UDP 的 QUIC 协议。与 TCP 相比，使用 UDP 可以提供更大的灵活性，并且可以使 QUIC 完全于用户空间中实现——对协议实现的更新不像 TCP 那样需要绑定到操作系统更新。使用 QUIC，可以简单地将 HTTP 级别的...","link":"","photos":[],"count_time":{"symbolsCount":736,"symbolsTime":"1 mins."},"categories":[{"name":"前端基础","slug":"前端基础","count":29,"path":"api/categories/前端基础.json"}],"tags":[{"name":"前端基础","slug":"前端基础","count":31,"path":"api/tags/前端基础.json"},{"name":"面试","slug":"面试","count":17,"path":"api/tags/面试.json"},{"name":"http","slug":"http","count":6,"path":"api/tags/http.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"丷为中华之崛起而学习丷","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}},"next_post":{"title":"前端基础-跨域问题","uid":"097419cee069b6e2fdfe8a3b19f9ef54","slug":"2022-05-09cors","date":"2022-05-09T13:30:47.000Z","updated":"2022-09-16T13:54:56.104Z","comments":true,"path":"api/articles/2022-05-09cors.json","keywords":null,"cover":"http://t-blog-images.aijs.top/img/20220509181853.webp","text":"背景浏览器安全策略限制跨域访问 内容安全策略是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (XSS) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。 维基百科： 内容安全策略（英语：Content Security ...","link":"","photos":[],"count_time":{"symbolsCount":"8.8k","symbolsTime":"8 mins."},"categories":[{"name":"前端基础","slug":"前端基础","count":29,"path":"api/categories/前端基础.json"}],"tags":[{"name":"前端基础","slug":"前端基础","count":31,"path":"api/tags/前端基础.json"},{"name":"面试","slug":"面试","count":17,"path":"api/tags/面试.json"}],"author":{"name":"陈哈喽","slug":"blog-author","avatar":"http://t-blog-images.aijs.top/img/avatar.jpeg","link":"/","description":"丷为中华之崛起而学习丷","socials":{"github":"https://github.com/841660202","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/web_longboss","juejin":"","customs":{}}}}}